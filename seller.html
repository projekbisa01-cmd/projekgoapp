<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mitra Projekgo - Admin Upgrade</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --primary: #FF6600;
            --dark: #1A1A1A;
            --bg: #F8F9FB;
            --white: #ffffff;
            --gray: #9ca3af;
            --success: #2e7d32;
            --danger: #d32f2f;
            --warning: #ed6c02;
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; background: var(--bg); color: var(--dark); padding-bottom: 80px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* LOGIN SCREEN */
        #login-page { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .login-logo { font-size: 40px; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        .login-input { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 12px; font-size: 16px; outline: none; }
        .btn-login { width: 100%; background: var(--primary); color: white; padding: 15px; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }

        /* HEADER */
        .header { background: var(--primary); color: white; padding: 25px 20px 45px 20px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; }
        
        /* NAVIGATION */
        .tabs { display: flex; background: white; padding: 8px; border-radius: 16px; margin: -25px 20px 20px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; z-index: 10; gap: 5px; }
        .tab-item { flex: 1; padding: 12px; font-weight: 700; color: var(--gray); cursor: pointer; border-radius: 10px; text-align: center; font-size: 13px; transition: 0.3s; }
        .tab-item.active { background: var(--primary); color: white; }

        /* CONTENT */
        .content-section { display: none; padding: 0 20px; animation: fadeIn 0.3s; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.05); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 12px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .stat-val { font-size: 18px; font-weight: 800; color: var(--primary); display: block; }
        .stat-label { font-size: 10px; color: var(--gray); text-transform: uppercase; }

        /* ADMIN LIST ITEMS */
        .admin-mitra-item { padding: 12px; border-bottom: 1px solid #f0f0f0; }
        .admin-mitra-item:last-child { border-bottom: none; }
        .btn-action { padding: 6px 10px; font-size: 11px; font-weight: 700; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-warning { background: #fff7ed; color: var(--warning); }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 25px; max-height: 90vh; overflow-y: auto; }

        .btn-submit { width: 100%; background: var(--primary); color: white; padding: 15px; border: none; border-radius: 12px; font-weight: 700; margin-top: 10px; cursor: pointer; }
        .admin-badge { background: #000; color: #fff; font-size: 10px; padding: 2px 8px; border-radius: 20px; margin-left: 5px; vertical-align: middle; }
        
        .search-box { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; font-family: inherit; font-size: 14px; }
    </style>
</head>
<body>

    <!-- LOGIN PAGE -->
    <div id="login-page">
        <div class="login-logo">Projekgo</div>
        <div style="font-weight:700; margin-bottom:20px; color: #666;">Portal Keamanan Mitra</div>
        <input type="text" id="login-id" class="login-input" placeholder="ID Warung / Admin">
        <input type="password" id="login-pin" class="login-input" placeholder="PIN Keamanan (6 Digit)">
        <button class="btn-login" onclick="handleLogin()">Buka Dashboard</button>
        <p style="font-size: 11px; color: #999; margin-top: 15px; text-align: center;">
            Hanya mitra terdaftar yang dapat mengakses data.<br>Hubungi Admin untuk pendaftaran baru.
        </p>
    </div>

    <!-- MAIN APP -->
    <div id="dashboard" style="display:none;">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items: center;">
                <div>
                    <div style="display: flex; align-items: center;">
                        <span id="display-name" style="font-weight: 800; font-size: 22px;">...</span>
                        <span id="admin-indicator" class="admin-badge" style="display:none;">ADMIN</span>
                    </div>
                    <div id="display-id" style="font-size: 12px; opacity: 0.8;">ID: ...</div>
                </div>
                <button onclick="handleLogout()" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:8px 15px; border-radius:10px; font-size:12px; font-weight:700;">Keluar</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-item active" onclick="switchTab('menu')" id="tab-menu">Kelola Menu</div>
            <div class="tab-item" onclick="switchTab('profile')" id="tab-profile">Profil Toko</div>
            <div class="tab-item" onclick="switchTab('admin')" id="tab-admin" style="display:none;">Panel Admin</div>
        </div>

        <!-- CONTENT: MENU -->
        <div id="content-menu" class="content-section active">
            <h3 style="margin-bottom: 15px;">Daftar Produk</h3>
            <div id="menu-container"></div>
            <div onclick="alert('Form tambah menu dalam pengembangan')" style="position:fixed; bottom:20px; right:20px; width:56px; height:56px; background:var(--primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px; box-shadow: 0 4px 15px rgba(255,102,0,0.4);"><i class="ph-bold ph-plus"></i></div>
        </div>

        <!-- CONTENT: PROFILE -->
        <div id="content-profile" class="content-section">
            <div class="card">
                <div class="profile-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 12px; background: #f9f9f9; margin-bottom: 10px; cursor: pointer;" onclick="showTermsModal()">
                    <i class="ph-fill ph-file-text" style="color:var(--primary); font-size:24px;"></i>
                    <div style="flex-grow:1; font-weight:700;">Perjanjian Mitra</div>
                    <i class="ph ph-lock-simple" style="color:#ccc;"></i>
                </div>
            </div>
        </div>

        <!-- CONTENT: ADMIN (UPGRADED) -->
        <div id="content-admin" class="content-section">
            <!-- Stats -->
            <div class="stat-grid">
                <div class="stat-card">
                    <span class="stat-val" id="stat-total-mitra">0</span>
                    <span class="stat-label">Total Mitra</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="stat-total-produk">0</span>
                    <span class="stat-label">Total Produk</span>
                </div>
            </div>

            <div class="card">
                <h4 style="margin-top:0;">Daftarkan Mitra Baru</h4>
                <input type="text" id="adm-new-id" class="login-input" placeholder="ID Warung (Tanpa spasi)" style="font-size:14px;">
                <input type="text" id="adm-new-name" class="login-input" placeholder="Nama Warung" style="font-size:14px;">
                <input type="text" id="adm-new-pin" class="login-input" placeholder="Set PIN (Min 4 Digit)" style="font-size:14px;">
                <button class="btn-submit" onclick="registerNewPartner()">Daftarkan Mitra</button>
            </div>

            <h4 style="margin: 20px 0 10px 0;">Manajemen Mitra Aktif</h4>
            <input type="text" id="admin-search" class="search-box" placeholder="Cari nama atau ID mitra..." onkeyup="filterMitraList()">
            
            <div class="card" style="padding:0; overflow:hidden;">
                <div id="admin-mitra-list"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: KETENTUAN -->
    <div id="modal-terms" class="modal-overlay" style="align-items: center; padding: 20px;">
        <div class="modal-content" style="border-radius: 20px;">
            <div style="text-align:center; margin-bottom:20px;">
                <h2 style="margin:0;">Ketentuan Layanan</h2>
                <p style="font-size:12px; color:var(--gray);">Dokumen Perjanjian Penjual</p>
            </div>
            <div style="font-size:13px; line-height:1.6; max-height:300px; overflow-y:auto;">
                <p><b>1. Larangan Alkohol:</b> Mitra dilarang keras menjual minuman beralkohol atau zat adiktif.</p>
                <p><b>2. Ketentuan Halal:</b> Semua makanan wajib memiliki keterangan bahan yang jelas dan tidak mengandung babi.</p>
                <p><b>3. Produk Hukum:</b> Dilarang menjual barang curian atau melanggar hukum negara.</p>
            </div>
            <button class="btn-submit" onclick="document.getElementById('modal-terms').style.display='none'">Tutup</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, where, onSnapshot, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDq0UCWj43rCP3rqvAGbdyr2FFV7kyhZTA",
            authDomain: "projekgo-app.firebaseapp.com",
            projectId: "projekgo-app",
            storageBucket: "projekgo-app.firebasestorage.app",
            messagingSenderId: "910691523179",
            appId: "1:910691523179:web:2c78d27de6a02cec952f2e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let allMitraData = [];

        // --- LOGIN LOGIC ---
        window.handleLogin = async () => {
            const id = document.getElementById('login-id').value.trim().toLowerCase();
            const pin = document.getElementById('login-pin').value.trim();
            if(!id || !pin) return alert("Lengkapi data login!");

            const vendorSnap = await getDoc(doc(db, "vendors", id));
            if(vendorSnap.exists()) {
                const data = vendorSnap.data();
                if(data.pin === pin) {
                    currentUser = { id, name: data.nama_warung, role: data.role || 'vendor' };
                    localStorage.setItem('projekgo_session', JSON.stringify(currentUser));
                    initDashboard();
                } else { alert("PIN Salah!"); }
            } else { alert("ID Mitra tidak terdaftar."); }
        };

        window.handleLogout = () => {
            localStorage.removeItem('projekgo_session');
            location.reload();
        };

        // --- DASHBOARD INIT ---
        function initDashboard() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('display-name').innerText = currentUser.name;
            document.getElementById('display-id').innerText = "ID: " + currentUser.id;

            if(currentUser.role === 'admin') {
                document.getElementById('tab-admin').style.display = 'block';
                document.getElementById('admin-indicator').style.display = 'inline-block';
                loadAdminData();
            }

            // Sync User's Products
            const q = query(collection(db, "products"), where("vendor_id", "==", currentUser.id));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('menu-container');
                container.innerHTML = '';
                snapshot.forEach(d => {
                    const item = d.data();
                    const el = document.createElement('div');
                    el.className = 'card'; el.style.display = 'flex'; el.style.gap = '15px';
                    el.innerHTML = `
                        <div style="width:60px; height:60px; background:#eee; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#ccc;"><i class="ph ph-image" style="font-size:24px;"></i></div>
                        <div>
                            <div style="font-weight:700;">${item.nama_menu}</div>
                            <div style="color:var(--primary); font-size:14px; font-weight:600;">Rp ${item.harga.toLocaleString()}</div>
                        </div>
                    `;
                    container.appendChild(el);
                });
            });
        }

        // --- ADMIN UPGRADE FUNCTIONS ---
        async function loadAdminData() {
            // Get stats
            onSnapshot(collection(db, "vendors"), (snap) => {
                document.getElementById('stat-total-mitra').innerText = snap.size - 1; // Exclude admin
                allMitraData = [];
                snap.forEach(d => {
                    if(d.id !== 'admin') allMitraData.push(d.data());
                });
                renderMitraList(allMitraData);
            });

            const productsSnap = await getDocs(collection(db, "products"));
            document.getElementById('stat-total-produk').innerText = productsSnap.size;
        }

        function renderMitraList(data) {
            const list = document.getElementById('admin-mitra-list');
            list.innerHTML = '';
            data.forEach(m => {
                const el = document.createElement('div');
                el.className = 'admin-mitra-item';
                el.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                        <div>
                            <div style="font-weight:800; font-size:14px;">${m.nama_warung}</div>
                            <div style="font-size:11px; color:var(--gray)">ID: ${m.id} â€¢ PIN: ${m.pin}</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-action btn-warning" onclick="resetPin('${m.id}')">
                            <i class="ph-bold ph-key"></i> Reset PIN
                        </button>
                        <button class="btn-action btn-danger" onclick="deletePartner('${m.id}', '${m.nama_warung}')">
                            <i class="ph-bold ph-trash"></i> Hapus
                        </button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        window.filterMitraList = () => {
            const val = document.getElementById('admin-search').value.toLowerCase();
            const filtered = allMitraData.filter(m => 
                m.nama_warung.toLowerCase().includes(val) || 
                m.id.toLowerCase().includes(val)
            );
            renderMitraList(filtered);
        };

        window.deletePartner = async (id, name) => {
            if(confirm(`Hapus mitra "${name}" secara permanen? Tindakan ini tidak bisa dibatalkan.`)) {
                await deleteDoc(doc(db, "vendors", id));
                alert("Mitra berhasil dihapus.");
            }
        };

        window.resetPin = async (id) => {
            if(confirm(`Reset PIN mitra ini ke default "123456"?`)) {
                await updateDoc(doc(db, "vendors", id), { pin: "123456" });
                alert("PIN berhasil direset ke 123456");
            }
        };

        window.registerNewPartner = async () => {
            const id = document.getElementById('adm-new-id').value.trim().toLowerCase();
            const name = document.getElementById('adm-new-name').value.trim();
            const pin = document.getElementById('adm-new-pin').value.trim();

            if(!id || !name || pin.length < 4) return alert("Mohon lengkapi data (PIN minimal 4 angka)");

            const check = await getDoc(doc(db, "vendors", id));
            if(check.exists()) return alert("ID Mitra sudah digunakan!");

            await setDoc(doc(db, "vendors", id), {
                id, nama_warung: name, pin, role: 'vendor', created_at: new Date().toISOString()
            });

            alert("Pendaftaran Berhasil!");
            document.getElementById('adm-new-id').value = "";
            document.getElementById('adm-new-name').value = "";
            document.getElementById('adm-new-pin').value = "";
        };

        // UI HELPERS
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-item').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.getElementById('content-'+tab).classList.add('active');
        };

        window.showTermsModal = () => document.getElementById('modal-terms').style.display='flex';

        // Check Session
        const session = localStorage.getItem('projekgo_session');
        if(session) {
            currentUser = JSON.parse(session);
            initDashboard();
        }

    </script>
</body>
</html>
