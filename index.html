<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Meta PWA -->
    <meta name="theme-color" content="#ea580c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ProjekGo">
    
    <title>ProjekGo - Katalog Kuliner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Mencegah pantulan scroll */
        }

        #app-container {
            height: 100%;
            height: 100dvh;
            max-width: 28rem;
            margin: 0 auto;
            background-color: #fff7ed;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* Utilitas Custom untuk Performa */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .scrolling-wrapper {
            -webkit-overflow-scrolling: touch; /* Momentum scroll iOS halus */
            overflow-y: auto;
            will-change: scroll-position; /* Beritahu browser area ini akan di-scroll */
            touch-action: pan-y;
        }

        /* Optimasi Rendering Item List (Penting untuk 'Ringan') */
        .list-item-optimized {
            content-visibility: auto; /* Browser skip render jika item di luar layar */
            contain-intrinsic-size: 100px; /* Estimasi tinggi item */
            contain: layout paint; /* Isolasi layout */
        }

        .category-icon { transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
        .category-icon:active { transform: scale(0.9); }
        .icon-3d { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); transition: transform 0.3s ease; }
        .category-icon:hover .icon-3d { transform: translateY(-5px); }

        .page-section {
            transition: opacity 0.2s ease-in-out;
            opacity: 1;
            pointer-events: auto;
            position: absolute;
            inset: 0;
            background-color: #fff7ed;
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding-bottom: 5rem;
        }
        .hidden-page { opacity: 0; pointer-events: none; z-index: 0; display: none !important; }

        .nav-item.active i { color: #ea580c; }
        .nav-item.active span { color: #ea580c; font-weight: 700; }

        .shop-closed { filter: grayscale(100%); opacity: 0.6; }

        .variant-radio:checked + label {
            background-color: #fff7ed; border-color: #ea580c; color: #ea580c; font-weight: 700;
        }
        .variant-radio:checked + label .check-icon { display: block; }
        
        @keyframes like-bounce { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .liked-anim { animation: like-bounce 0.3s ease-in-out; }
        
        .progress-bar-fill { transition: width 1s ease-in-out; }
    </style>
</head>
<body>

    <div id="app-container">
        
        <!-- === HALAMAN UTAMA (HOME) === -->
        <div id="home-page" class="page-section z-20">
            <!-- Header Minimalis & Membulat -->
            <header class="bg-orange-600 text-white pt-6 pb-8 px-5 rounded-b-[2.5rem] shadow-lg shadow-orange-600/20 z-20 relative shrink-0">
                <div class="flex justify-between items-center mb-5">
                    <div class="flex flex-col">
                        <h1 class="text-2xl font-black tracking-tighter italic select-none">PROJEK<span class="text-orange-200">GO</span></h1>
                        <div class="flex items-center gap-1.5 opacity-90 cursor-pointer mt-0.5" onclick="initLocation()">
                            <i class="fas fa-map-marker-alt text-[10px] animate-bounce"></i>
                            <!-- Updated Logic: Will prioritize District/Kecamatan -->
                            <p class="text-[10px] font-medium truncate max-w-[200px] leading-none" id="header-address-text">Mendeteksi Lokasi...</p>
                        </div>
                    </div>
                    <!-- Menu Button -->
                    <button class="bg-white/10 hover:bg-white/20 text-white w-9 h-9 rounded-full flex items-center justify-center transition active:scale-95 backdrop-blur-sm" onclick="openPartnershipModal()">
                        <i class="fas fa-bars text-xs"></i>
                    </button>
                </div>
                
                <!-- Search Bar Integrated -->
                <div class="relative group" onclick="navTo('search-page')">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fas fa-search text-orange-300 group-hover:text-orange-500 transition-colors text-sm"></i>
                    </div>
                    <input type="text" placeholder="Mau makan apa hari ini?" readonly
                        class="w-full py-3 pl-10 pr-4 rounded-2xl text-gray-700 text-sm font-medium bg-white/95 border-0 shadow-sm focus:ring-0 cursor-pointer placeholder-gray-400">
                </div>
            </header>

            <!-- Main Content (Optimized Scroll) -->
            <main class="flex-1 overflow-y-auto hide-scrollbar scrolling-wrapper pb-24 relative pt-2 px-4 bg-gray-50 z-0">
                <div class="mb-6 mt-2">
                    <div class="grid grid-cols-4 gap-y-6" id="categories-container">
                        <div class="col-span-4 text-center text-gray-400 text-xs py-4">
                            <i class="fas fa-circle-notch fa-spin text-orange-500 mb-2"></i><br>Memuat Kategori...
                        </div>
                    </div>
                </div>

                <!-- Bagian "Hanya ada di PROJEKGO" -->
                <div class="mb-8">
                    <div class="flex justify-between items-center px-1 mb-3">
                        <h3 class="font-bold text-gray-800 text-lg">Promo Spesial</h3>
                        <span class="text-orange-600 text-xs font-bold cursor-pointer" onclick="openExclusivePage()">Lihat Semua</span>
                    </div>
                    <div id="exclusive-slider" class="flex gap-4 overflow-x-auto hide-scrollbar pb-4 snap-x touch-pan-x min-h-[140px] scrolling-wrapper">
                         <div class="w-full text-center text-gray-400 text-xs py-10">
                            <i class="fas fa-spinner fa-spin"></i> Memuat Data...
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <div class="flex justify-between items-center px-1 mb-3">
                        <h3 class="font-bold text-gray-800 text-lg">Paling Laris</h3>
                        <span class="text-orange-600 text-xs font-bold cursor-pointer" onclick="openCategory('all', 'Semua Menu')">Lihat Semua</span>
                    </div>
                    <div id="recommendation-slider" class="flex gap-4 overflow-x-auto hide-scrollbar pb-4 snap-x touch-pan-x min-h-[140px] scrolling-wrapper">
                        <div class="w-full text-center text-gray-400 text-xs py-10">
                            <i class="fas fa-spinner fa-spin"></i> Memuat Data...
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-end px-1 mb-3 sticky top-0 bg-gray-50 z-20 py-2">
                        <h3 class="font-bold text-gray-800 text-lg">Daftar Penjual</h3>
                        <button onclick="fetchData()" class="text-orange-600 text-xs font-semibold flex items-center gap-1 hover:text-orange-700 active:scale-95 transition">
                            <i class="fas fa-sync-alt" id="refreshIcon"></i> Refresh
                        </button>
                    </div>
                    <div id="vendor-list" class="space-y-4">
                        <div class="text-center text-gray-400 text-xs py-10 bg-white rounded-3xl">
                            <i class="fas fa-store text-2xl mb-2 text-gray-300"></i><br>Mencari Mitra Penjual...
                        </div>
                    </div>
                </div>
                
                <div class="h-10"></div>
            </main>
        </div>

        <!-- === HALAMAN PENCARIAN === -->
        <div id="search-page" class="page-section hidden-page z-30 bg-gray-50">
            <div class="bg-white p-4 shadow-sm flex items-center gap-3 sticky top-0 z-10">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-3 text-orange-500"></i>
                    <input type="text" id="global-search-input" placeholder="Cari makanan atau resto..." 
                        class="w-full py-2.5 pl-10 pr-4 rounded-full bg-gray-100 text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-orange-200"
                        oninput="handleGlobalSearch(this.value)">
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 scrolling-wrapper" id="search-results">
                <div class="text-center mt-10 text-gray-400">
                    <i class="fas fa-search text-4xl mb-2"></i>
                    <p class="text-sm">Ketik untuk mencari...</p>
                </div>
            </div>
        </div>

        <!-- === HALAMAN POIN (NEW) === -->
        <div id="points-page" class="page-section hidden-page z-30 bg-gray-50">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 sticky top-0 z-10">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Poin Saya</h2>
                    <p class="text-xs text-gray-500">Kumpulkan dan tukar hadiah!</p>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar scrolling-wrapper">
                <!-- Card Utama Poin -->
                <div class="bg-gradient-to-br from-orange-500 to-red-600 rounded-[2rem] p-6 text-white shadow-xl mb-6 relative overflow-hidden">
                    <div class="absolute -top-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl"></div>
                    <div class="absolute bottom-0 left-0 w-32 h-32 bg-yellow-400 opacity-10 rounded-full blur-xl"></div>
                    
                    <div class="relative z-10 flex flex-col items-center">
                        <p class="text-orange-100 text-sm font-medium mb-1">Total Poin Kamu</p>
                        <h1 class="text-6xl font-black mb-2 drop-shadow-sm" id="point-display-count">0</h1>
                        <div class="w-full bg-black/20 rounded-full h-3 mb-2 overflow-hidden backdrop-blur-sm">
                            <div id="point-progress-bar" class="bg-yellow-400 h-full rounded-full shadow-lg progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between w-full text-xs font-medium text-orange-100 px-1">
                            <span>0</span>
                            <span id="point-target-text">Target: 10 Poin</span>
                        </div>
                    </div>
                </div>

                <!-- Bagian Penukaran -->
                <div class="bg-white p-5 rounded-[2rem] shadow-sm mb-6 border border-gray-100">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-lg">
                            <i class="fas fa-truck-fast"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">Gratis Ongkir Rp 5.000</h3>
                            <p class="text-xs text-gray-500">Tukarkan 10 Poin untuk voucher ini</p>
                        </div>
                    </div>
                    <button id="btn-redeem-point" onclick="redeemPoints()" disabled class="w-full py-3 rounded-xl font-bold text-sm transition-all duration-300 bg-gray-200 text-gray-400 cursor-not-allowed">
                        Tukar Poin (Butuh 10 Poin)
                    </button>
                </div>

                <!-- Info Cara Dapat -->
                <div class="bg-orange-50 p-5 rounded-[2rem] border border-orange-100">
                    <h3 class="font-bold text-gray-800 mb-3 text-sm">Cara Mendapatkan Poin</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-orange-200 text-orange-700 flex items-center justify-center text-xs font-bold shrink-0">1</div>
                            <p class="text-xs text-gray-600 leading-relaxed">Lakukan pemesanan makanan via aplikasi. Setiap 1 kali transaksi = <span class="font-bold text-orange-600">1 Poin</span>.</p>
                        </li>
                        <li class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-orange-200 text-orange-700 flex items-center justify-center text-xs font-bold shrink-0">2</div>
                            <p class="text-xs text-gray-600 leading-relaxed">Kumpulkan hingga <span class="font-bold text-orange-600">10 Poin</span>.</p>
                        </li>
                        <li class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-orange-200 text-orange-700 flex items-center justify-center text-xs font-bold shrink-0">3</div>
                            <p class="text-xs text-gray-600 leading-relaxed">Tukarkan dengan Voucher Gratis Ongkir senilai Rp 5.000!</p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- === HALAMAN PESANAN === -->
        <div id="orders-page" class="page-section hidden-page z-30 bg-gray-50 flex items-center justify-center">
            <div class="text-center p-8">
                <div class="bg-orange-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-receipt text-4xl text-orange-500"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Belum ada pesanan</h2>
                <p class="text-gray-500 text-sm mb-6">Kamu belum pernah pesan makanan nih. Yuk cari makanan enak!</p>
                <button onclick="navTo('home-page')" class="bg-orange-600 text-white px-6 py-2.5 rounded-full font-bold text-sm shadow-lg hover:bg-orange-700">Mulai Pesan</button>
            </div>
        </div>

        <!-- === HALAMAN PROFIL === -->
        <div id="profile-page" class="page-section hidden-page z-30 bg-gray-50">
            <div class="bg-orange-600 h-32 relative shrink-0"></div>
            <div class="px-4 -mt-12 relative z-10 mb-4 shrink-0">
                <div class="bg-white p-4 rounded-[2rem] shadow-md flex flex-col items-center relative">
                    <div class="w-20 h-20 bg-gray-200 rounded-full border-4 border-white -mt-12 mb-2 overflow-hidden shadow-sm">
                        <img src="https://ui-avatars.com/api/?name=User+ProjekGo&background=random" class="w-full h-full" id="profile-avatar-img">
                    </div>
                    <button onclick="openEditProfile()" class="absolute top-2 right-2 text-gray-400 hover:text-orange-600 p-2">
                        <i class="fas fa-pen text-sm"></i>
                    </button>
                    <h2 class="font-bold text-lg text-gray-800" id="profile-name-text">User ProjekGo</h2>
                    <p class="text-xs text-gray-500" id="profile-phone-text">+62 812-3456-7890</p>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto px-4 pb-20 scrolling-wrapper">
                <div class="space-y-3">
                    <button onclick="openAddressModal()" class="w-full bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center text-gray-700 active:bg-gray-50 transition">
                        <span class="font-medium text-sm flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-500"><i class="fas fa-map-marker-alt"></i></div> Alamat Tersimpan</span>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </button>
                    <button onclick="openFavoritesPage()" class="w-full bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center text-gray-700 active:bg-gray-50 transition">
                        <span class="font-medium text-sm flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-500"><i class="fas fa-heart"></i></div> Makanan Favorit</span>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </button>
                    <button class="w-full bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center text-gray-700 active:bg-gray-50 transition">
                        <span class="font-medium text-sm flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-500"><i class="fas fa-headset"></i></div> Bantuan</span>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- === HALAMAN KATEGORI / FAVORIT === -->
        <div id="category-page" class="page-section hidden-page z-40 bg-gray-50">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 z-10 shrink-0 sticky top-0">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 id="cat-page-title" class="text-lg font-bold text-gray-800">Nama Kategori</h2>
                    <p class="text-xs text-gray-500">Menampilkan menu pilihan</p>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar scrolling-wrapper">
                <div id="category-content-container" class="grid grid-cols-2 gap-3 pb-24"></div>
            </div>
        </div>

        <!-- NEW: HALAMAN "HANYA ADA DI PROJEKGO" -->
        <div id="exclusive-page" class="page-section hidden-page z-40 bg-gray-50">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 z-10 shrink-0 sticky top-0">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Eksklusif ProjekGo</h2>
                    <p class="text-xs text-gray-500">Menu spesial hanya untukmu</p>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar scrolling-wrapper">
                <div id="exclusive-content-container" class="grid grid-cols-2 gap-3 pb-24"></div>
            </div>
        </div>

        <!-- === HALAMAN DETAIL PENJUAL === -->
        <div id="vendor-page" class="page-section hidden-page z-50 bg-gray-50">
            <div class="relative h-48 bg-gray-300">
                <img id="vendor-banner-img" src="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                <button onclick="handleBack()" class="absolute top-4 left-4 w-10 h-10 bg-white/20 backdrop-blur rounded-full text-white flex items-center justify-center hover:bg-white/30 transition">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="absolute bottom-4 left-4 text-white">
                    <h2 id="vendor-name-title" class="text-2xl font-bold leading-tight">Nama Warung</h2>
                    <p id="vendor-info-subtitle" class="text-xs opacity-90 mt-1">Status â€¢ Kategori</p>
                </div>
                <div class="absolute bottom-4 right-4 bg-white/20 backdrop-blur px-3 py-1 rounded-full flex items-center gap-1 text-white">
                    <i class="fas fa-star text-yellow-400 text-xs"></i>
                    <span id="vendor-rating-badge" class="text-xs font-bold">4.8</span>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 -mt-4 bg-gray-50 rounded-t-[2rem] relative z-10 hide-scrollbar scrolling-wrapper">
                <h3 class="font-bold text-gray-800 mb-4">Daftar Menu</h3>
                <div id="vendor-menu-container" class="space-y-3 pb-24"></div>
            </div>
        </div>

        <!-- === MODAL / SHEET LAYOUTS === -->
        
        <!-- EDIT PROFILE -->
        <div id="edit-profile-modal" class="absolute inset-0 z-[90] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
            <div class="bg-white rounded-[2rem] w-full max-w-sm p-6 shadow-2xl">
                <h3 class="font-bold text-lg text-gray-800 mb-4">Edit Profil</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Nama Lengkap</label>
                        <input type="text" id="edit-name-input" class="w-full border border-gray-300 rounded-xl p-3 text-sm focus:outline-none focus:border-orange-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Nomor Telepon</label>
                        <input type="tel" id="edit-phone-input" class="w-full border border-gray-300 rounded-xl p-3 text-sm focus:outline-none focus:border-orange-500">
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button onclick="closeEditProfile()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl">Batal</button>
                        <button onclick="saveProfile()" class="flex-1 bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg">Simpan</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADDRESS MODAL -->
        <div id="address-modal" class="absolute inset-0 z-[85] hidden bg-gray-50 flex flex-col">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 z-10">
                <button onclick="closeAddressModal()" class="p-2 hover:bg-gray-100 rounded-full text-gray-700">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-lg font-bold text-gray-800">Alamat Tersimpan</h2>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 scrolling-wrapper" id="address-list-container"></div>
            <div class="p-4 bg-white border-t border-gray-200">
                <button onclick="openAddAddressModal()" class="w-full bg-orange-600 text-white font-bold py-3 rounded-2xl shadow-lg flex items-center justify-center gap-2 active:scale-[0.98] transition">
                    <i class="fas fa-plus"></i> Tambah Alamat Baru
                </button>
            </div>
        </div>

        <!-- ADD ADDRESS SHEET -->
        <div id="add-address-modal" class="absolute inset-0 z-[90] hidden">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeAddAddressModal()"></div>
            <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6 min-h-[50%] flex flex-col transition-transform duration-300 transform translate-y-full" id="add-address-content">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 cursor-grab" onclick="closeAddAddressModal()"></div>
                <h3 class="font-bold text-xl text-gray-800 mb-6">Tambah Alamat Baru</h3>
                <div class="space-y-5 mb-6 flex-1 overflow-y-auto hide-scrollbar">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Label Alamat</label>
                        <div class="flex gap-2">
                            <button onclick="setAddressLabel('Rumah')" class="addr-label-btn flex-1 py-3 border border-orange-500 bg-orange-50 text-orange-600 rounded-2xl text-sm font-bold transition">Rumah</button>
                            <button onclick="setAddressLabel('Kantor')" class="addr-label-btn flex-1 py-3 border border-gray-200 text-gray-600 rounded-2xl text-sm font-bold hover:bg-gray-50 transition">Kantor</button>
                            <button onclick="setAddressLabel('Lainnya')" class="addr-label-btn flex-1 py-3 border border-gray-200 text-gray-600 rounded-2xl text-sm font-bold hover:bg-gray-50 transition">Lainnya</button>
                        </div>
                        <input type="hidden" id="new-addr-label" value="Rumah">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Alamat Lengkap</label>
                        <div class="relative">
                            <i class="fas fa-map-marker-alt absolute left-3 top-3.5 text-gray-400"></i>
                            <textarea id="new-addr-detail" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-2xl py-3 pl-10 pr-4 text-sm focus:outline-none focus:border-orange-500 focus:bg-white transition resize-none text-gray-800 font-medium" placeholder="Jalan, Nomor Rumah, RT/RW..."></textarea>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Catatan Kurir (Opsional)</label>
                        <div class="relative">
                            <i class="fas fa-pen absolute left-3 top-3.5 text-gray-400"></i>
                            <input type="text" id="new-addr-note" class="w-full bg-gray-50 border border-gray-200 rounded-2xl py-3 pl-10 pr-4 text-sm focus:outline-none focus:border-orange-500 focus:bg-white transition text-gray-800 font-medium" placeholder="Pagar hitam, dekat warung...">
                        </div>
                    </div>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-100">
                    <button onclick="saveNewAddress()" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-orange-200 hover:bg-orange-700 active:scale-[0.98] transition flex justify-center items-center gap-2">
                        <i class="fas fa-check"></i> Simpan Alamat
                    </button>
                </div>
            </div>
        </div>

        <!-- PARTNERSHIP MODAL -->
        <div id="partnership-modal" class="absolute inset-0 z-[95] hidden flex items-end justify-center bg-black/50 backdrop-blur-sm" onclick="closePartnershipModal()">
            <div class="bg-white w-full rounded-t-[2.5rem] p-6 transform transition-transform duration-300 translate-y-0" onclick="event.stopPropagation()">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6"></div>
                <h3 class="font-bold text-xl text-gray-800 mb-4">Bergabung Bersama Kami</h3>
                <div class="space-y-3 mb-6">
                    <div onclick="window.open('seller.html', '_blank')" class="bg-orange-50 p-4 rounded-2xl flex items-center gap-4 cursor-pointer hover:bg-orange-100 transition border border-orange-100 active:scale-[0.98]">
                        <div class="bg-orange-500 text-white w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-md"><i class="fas fa-store"></i></div>
                        <div><h4 class="font-bold text-gray-800">Login Mitra Penjual</h4><p class="text-xs text-gray-600">Masuk untuk kelola menu & toko</p></div>
                        <i class="fas fa-chevron-right ml-auto text-orange-400"></i>
                    </div>
                    <!-- (Optional: Registration Link or Form could go here if needed) -->
                </div>
            </div>
        </div>

        <!-- VARIANT MODAL (UPDATED: Bigger Image) -->
        <div id="variant-modal" class="absolute inset-0 z-[80] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
            <div class="bg-white rounded-[2rem] w-full max-w-sm overflow-hidden shadow-2xl transform transition-all scale-100">
                <!-- Image Height Increased to h-64 (approx 256px) for better visibility -->
                <div class="relative h-64 bg-gray-200">
                    <img id="variant-modal-img" src="" class="w-full h-full object-cover transition-opacity duration-300" loading="lazy">
                    <button onclick="closeVariantModal()" class="absolute top-4 right-4 w-9 h-9 bg-white/80 backdrop-blur rounded-full flex items-center justify-center shadow-md text-gray-600 hover:text-red-500 active:scale-90 transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6">
                    <h3 id="variant-modal-title" class="font-bold text-xl text-gray-800 leading-tight mb-1">Nama Produk</h3>
                    <p id="variant-modal-price" class="text-orange-600 font-bold text-lg mb-4">Rp 0</p>
                    
                    <div id="variant-options-wrapper" class="mb-6">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Pilih Variasi</p>
                        <div id="variant-options-container" class="space-y-2 max-h-40 overflow-y-auto hide-scrollbar"></div>
                    </div>
                    
                    <button id="btn-add-variant" onclick="confirmVariantAdd()" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-2xl shadow-lg hover:bg-orange-700 transition active:scale-[0.98]">
                        Tambah ke Keranjang
                    </button>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <nav class="bg-white border-t border-gray-100 flex justify-around items-center px-2 py-3 pb-6 shrink-0 z-[60] shadow-[0_-5px_15px_rgba(0,0,0,0.05)] absolute bottom-0 left-0 right-0 w-full rounded-t-[2rem]">
            <button onclick="navTo('home-page')" class="nav-item active flex flex-col items-center gap-1 text-gray-400 w-16 active:scale-90 transition" id="nav-home">
                <i class="fas fa-utensils text-xl"></i><span class="text-[10px] font-medium">Beranda</span>
            </button>
            
            <button onclick="navTo('points-page')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16 transition active:scale-90" id="nav-points">
                <i class="fas fa-star text-xl"></i><span class="text-[10px] font-medium">Poin</span>
            </button>
            
            <div class="relative -top-6">
                <button onclick="openCart()" class="bg-orange-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-orange-300 hover:bg-orange-700 transition transform hover:scale-105 active:scale-95 relative z-40">
                    <i class="fas fa-shopping-basket text-xl"></i>
                    <span id="cart-badge-nav" class="absolute top-0 right-0 bg-red-500 border-2 border-white text-white text-[9px] w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
                </button>
            </div>
            <button onclick="navTo('orders-page')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16 transition active:scale-90" id="nav-orders">
                <i class="fas fa-receipt text-xl"></i><span class="text-[10px] font-medium">Pesanan</span>
            </button>
            <button onclick="navTo('profile-page')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16 transition active:scale-90" id="nav-profile">
                <i class="fas fa-user text-xl"></i><span class="text-[10px] font-medium">Profil</span>
            </button>
        </nav>

        <!-- CART MODAL -->
        <div id="cart-modal" class="absolute inset-0 z-[70] hidden">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeCart()"></div>
            <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-5 min-h-[60%] max-h-[90%] flex flex-col transition-transform duration-300 transform translate-y-full" id="cart-content">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4 cursor-grab" onclick="closeCart()"></div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Keranjang Saya</h2>
                    <button onclick="closeCart()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200"><i class="fas fa-times text-sm"></i></button>
                </div>
                <div id="cart-items-container" class="flex-1 overflow-y-auto hide-scrollbar mb-4 space-y-4 scrolling-wrapper"></div>
                <div id="checkout-form" class="border-t border-gray-100 pt-4 hidden shrink-0">
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Alamat Pengantaran</label>
                        <textarea id="delivery-address" rows="2" class="w-full bg-gray-50 border border-gray-200 rounded-2xl p-3 text-sm focus:outline-none focus:border-orange-500 resize-none" placeholder="Isi alamat lengkap agar ongkir akurat..."></textarea>
                    </div>
                    
                    <!-- Multi-Vendor Alert -->
                    <div id="multi-vendor-alert" class="hidden bg-yellow-50 border border-yellow-200 p-3 rounded-2xl mb-3 flex items-start gap-2">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5 text-xs"></i>
                        <p class="text-[11px] text-yellow-700 leading-tight">Pesan lebih dari 1 penjual, ada tambahan sedikit ongkir.</p>
                    </div>
                    
                    <div class="bg-green-50 p-3 rounded-2xl mb-4 border border-green-100" id="info-ongkir-box">
                        <div class="flex items-start gap-2 mb-1"><i class="fas fa-check-circle text-green-600 mt-0.5"></i><p class="text-[11px] text-green-800 font-bold leading-tight">Ongkir nanti dihitung oleh admin berdasarkan alamat kamu.</p></div>
                        <p class="text-[10px] text-green-700 ml-5">PASTI LEBIH HEMAT!</p>
                    </div>

                    <div class="space-y-1 mb-4">
                        <div class="flex justify-between items-center"><span class="text-gray-500 text-[10px] font-medium bg-gray-100 px-2 py-0.5 rounded">PROJEKGO tidak markup harga</span><span class="text-xs text-gray-400 line-through" id="cart-total-original">Rp0</span></div>
                        
                        <div class="flex justify-between items-center text-xs text-gray-600 font-medium">
                            <span>Biaya Aplikasi</span>
                            <div class="flex items-center gap-1">
                                <span class="text-[9px] bg-gray-200 text-gray-500 px-1.5 py-0.5 rounded font-bold">Gratis</span>
                                <span>Rp 0</span>
                            </div>
                        </div>
                        
                        <!-- Total Bayar -->
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-gray-800 font-bold text-sm">Total harga makanan</span>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded font-bold border border-orange-200">Harga Asli</span>
                                <span class="text-lg font-bold text-orange-600" id="cart-total-final">Rp0</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-end"><span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold" id="cart-savings-text">Anda lebih hemat Rp0</span></div>
                    </div>
                    <button onclick="checkoutToWA()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3.5 rounded-2xl shadow-lg flex items-center justify-center gap-2 transition-all active:scale-[0.98]">
                        <i class="fab fa-whatsapp text-xl"></i> Pesan via WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Logic -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').catch(err => console.log('SW Failed', err));
            });
        }

        // --- API CONFIGURATION ---
        const API_URL = "https://script.google.com/macros/s/AKfycbw65jWYm1cmPsXPM22Hsi9LH0FrY2AiIPNHE-16uvhEaVsx-KrgZ8KWw0K0cpAVA5Sj/exec";
        
        let favorites = new Set();
        let userProfile = {
            name: "User ProjekGo",
            phone: "+62 812-3456-7890",
            avatar: "https://ui-avatars.com/api/?name=User+ProjekGo&background=random"
        };
        let savedAddresses = [
            { id: 1, label: "Rumah", detail: "Jl. Melati No. 10, RT 01/02, Jakarta Selatan" },
            { id: 2, label: "Kantor", detail: "Gedung Cyber Lt. 2, Kuningan, Jakarta Selatan" }
        ];

        // POIN System
        let userPoints = 5; 
        let isFreeShippingActive = false;

        let productsData = [];
        let vendorsData = [];
        let categoriesData = [];
        let cart = [];
        let navHistory = ['home-page']; 
        let lastBackPressTime = 0;
        let tempSelectedProduct = null;

        // --- FUNGSI FALLBACK DATA (DUMMY DATA) ---
        function loadFallbackData() {
            categoriesData = [
                { id: "cat1", name: "Aneka Nasi", img: "https://cdn-icons-png.flaticon.com/512/3014/3014520.png" },
                { id: "cat2", name: "Minuman", img: "https://cdn-icons-png.flaticon.com/512/3054/3054889.png" },
                { id: "cat3", name: "Jajanan", img: "https://cdn-icons-png.flaticon.com/512/5787/5787016.png" },
                { id: "cat4", name: "Roti & Kue", img: "https://cdn-icons-png.flaticon.com/512/3014/3014499.png" },
                { id: "cat5", name: "Sate & BBQ", img: "https://cdn-icons-png.flaticon.com/512/1147/1147832.png" } 
            ];
            vendorsData = [];
            productsData = []; 
        }

        async function fetchData() {
            const refreshBtn = document.getElementById('refreshIcon');
            if(refreshBtn) refreshBtn.classList.add('fa-spin');
            
            try {
                loadFallbackData(); 
                
                // Fetch Categories
                const catRes = await fetch(`${API_URL}?action=getCategories`);
                const catJson = await catRes.json();
                if (catJson.status === 'success' && catJson.data.length > 0) {
                    categoriesData = catJson.data.map(c => ({ id: c.Category_ID, name: c.Name, img: c.Icon_Image_URL }));
                }

                // Fetch Products
                const prodRes = await fetch(`${API_URL}?action=getProducts`);
                const prodJson = await prodRes.json();
                if (prodJson.status === 'success' && prodJson.data.length > 0) {
                    productsData = prodJson.data.map(p => ({
                        id: p.ID, name: p.Name, vendor: p.Vendor_Name, category: p.Category,
                        price: Number(p.Price),
                        originalPrice: p.Original_Price ? Number(p.Original_Price) : Math.round(Number(p.Price) * 1.25),
                        rating: Number(p.Rating) || 4.5, image: p.Image_URL,
                        variants: p.Variants ? String(p.Variants).split(',').map(s => s.trim()).filter(Boolean) : [],
                        isExclusive: (String(p.Is_Exclusive).toLowerCase() === 'true'),
                        description: p.Description || ''
                    }));
                }

                // Fetch Vendors
                const vendRes = await fetch(`${API_URL}?action=getVendors`);
                const vendJson = await vendRes.json();
                if (vendJson.status === 'success' && vendJson.data.length > 0) {
                    vendorsData = vendJson.data.map(v => ({
                        id: v.ID, name: v.Vendor_Name, type: v.Type, distance: "1-3 km",
                        rating: Number(v.Rating) || 4.5, status: v.Status, img: v.Image_URL, address: v.Address || ''
                    }));
                }

                renderCategories();
                renderRecommendations();
                renderExclusiveSlider();
                renderVendorList();
                renderPointsUI();
                
                if(refreshBtn) refreshBtn.classList.remove('fa-spin');

            } catch (error) {
                console.log("Error fetching API, using fallback if available.");
                if(refreshBtn) refreshBtn.classList.remove('fa-spin');
                renderCategories(); 
                renderRecommendations();
                renderExclusiveSlider();
                renderVendorList();
                renderPointsUI();
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderExclusiveSlider() {
            const container = document.getElementById('exclusive-slider');
            const exclusiveProducts = productsData.filter(p => p.isExclusive);
            if (exclusiveProducts.length === 0) { container.innerHTML = `<div class="w-full text-center text-gray-400 text-xs py-4">Belum ada promo.</div>`; return; }
            
            container.innerHTML = exclusiveProducts.map(item => `
                <div class="min-w-[280px] bg-white rounded-[1.5rem] p-4 shadow-md border border-orange-100 flex gap-4 snap-center cursor-pointer active:scale-[0.98] transition relative overflow-hidden" onclick="handleAddToCart(${item.id})">
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-orange-500 rounded-full opacity-10"></div>
                    <div class="w-24 h-24 bg-gray-200 rounded-[1.5rem] overflow-hidden shrink-0 shadow-sm relative">
                        <img src="${item.image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100?text=No+Img'">
                        <div class="absolute top-0 left-0 bg-orange-600 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-br-lg">PROJEKGO</div>
                    </div>
                    <div class="flex flex-col justify-center flex-1">
                        <h4 class="font-bold text-gray-800 text-sm leading-tight mb-1 line-clamp-2">${item.name}</h4>
                        <p class="text-[10px] text-gray-500 leading-tight mb-2 line-clamp-2 h-7">${item.description || item.vendor}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-orange-600 font-bold text-sm">${formatRupiah(item.price)}</span>
                            <div class="w-7 h-7 bg-orange-100 rounded-full flex items-center justify-center text-orange-600"><i class="fas fa-plus text-xs"></i></div>
                        </div>
                    </div>
                </div>`).join('');
        }

        function renderProductGrid(products, container) {
            if(!products || products.length === 0) { container.innerHTML = '<div class="col-span-2 text-center text-gray-400 text-sm py-10">Tidak ada produk ditemukan.</div>'; return; }
            container.innerHTML = products.map(item => `
                <div class="list-item-optimized bg-white p-3 rounded-[1.5rem] shadow-sm border border-gray-100 flex flex-col h-full active:scale-[0.98] transition relative">
                    <div class="h-28 w-full bg-gray-200 rounded-3xl overflow-hidden mb-2 relative">
                        <img src="${item.image}" class="w-full h-full object-cover" loading="lazy" decoding="async" onerror="this.src='https://placehold.co/200?text=No+Img'">
                        <div class="absolute top-2 left-2 bg-white/90 backdrop-blur px-1.5 py-0.5 rounded text-[9px] font-bold flex items-center gap-1 shadow-sm z-10"><i class="fas fa-star text-yellow-500"></i> ${item.rating}</div>
                        <button onclick="toggleFavorite(event, ${item.id})" class="absolute top-2 right-2 w-7 h-7 bg-white/80 backdrop-blur rounded-full flex items-center justify-center shadow-sm z-10 hover:bg-white transition"><i class="${favorites.has(item.id) ? 'fas fa-heart text-red-500' : 'far fa-heart text-gray-400'} text-xs ${favorites.has(item.id) ? 'liked-anim' : ''}"></i></button>
                        ${(item.originalPrice > item.price) ? `<div class="absolute bottom-2 left-2 bg-red-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded shadow-sm">Hemat ${formatRupiah(item.originalPrice - item.price)}</div>` : ''}
                    </div>
                    <div class="mb-1">
                        <h4 class="font-bold text-gray-800 text-sm line-clamp-1">${item.name}</h4>
                        <p class="text-[10px] text-gray-400 leading-tight line-clamp-2 my-1 h-8 overflow-hidden">${item.description || 'Deskripsi menu belum tersedia.'}</p>
                        <p class="text-[10px] text-gray-500 font-medium flex items-center gap-1"><i class="fas fa-store text-[9px] text-orange-400"></i> ${item.vendor}</p>
                    </div>
                    <div class="flex justify-between items-end mt-auto pt-2">
                        <div class="flex flex-col">${(item.originalPrice > item.price) ? `<span class="text-[10px] text-gray-400 line-through">${formatRupiah(item.originalPrice)}</span>` : ''}<span class="text-orange-600 font-bold text-sm">${formatRupiah(item.price)}</span></div>
                        <button onclick="handleAddToCart(${item.id})" class="w-8 h-8 rounded-full bg-orange-100 hover:bg-orange-600 hover:text-white text-orange-600 flex items-center justify-center transition-colors shadow-sm active:scale-90"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                </div>`).join('');
        }

        function renderRecommendations() {
            const container = document.getElementById('recommendation-slider');
            if(!productsData || productsData.length === 0) { container.innerHTML = `<div class="w-full text-center text-gray-400 text-xs py-4">Data belum tersedia.</div>`; return; }
            container.innerHTML = productsData.slice(0, 5).map(item => `
                <div class="list-item-optimized min-w-[160px] max-w-[160px] bg-white p-3 rounded-[1.5rem] shadow-sm border border-gray-100 snap-center flex flex-col cursor-pointer active:scale-[0.98] transition" onclick="handleAddToCart(${item.id})">
                    <div class="w-full h-24 bg-gray-200 rounded-3xl overflow-hidden mb-2 relative">
                        <img src="${item.image}" class="w-full h-full object-cover" loading="lazy" decoding="async" onerror="this.src='https://placehold.co/150?text=No+Img'">
                        <div class="absolute top-1 left-1 bg-white/90 px-1.5 py-0.5 rounded text-[9px] font-bold flex items-center gap-1 z-10"><i class="fas fa-star text-yellow-500"></i> ${item.rating}</div>
                        <button onclick="toggleFavorite(event, ${item.id})" class="absolute top-1 right-1 w-6 h-6 bg-white/80 rounded-full flex items-center justify-center shadow-sm z-10"><i class="${favorites.has(item.id) ? 'fas fa-heart text-red-500' : 'far fa-heart text-gray-400'} text-[10px]"></i></button>
                    </div>
                    <h4 class="font-bold text-gray-800 text-xs line-clamp-1 mb-0.5">${item.name}</h4>
                    <p class="text-[10px] text-gray-500 leading-tight line-clamp-2 h-8 mb-1 overflow-hidden">${item.description || 'Deskripsi belum tersedia.'}</p>
                    <p class="text-[9px] text-gray-400 font-medium mb-1 line-clamp-1"><i class="fas fa-store text-[8px] text-orange-400"></i> ${item.vendor}</p>
                    <div class="flex justify-between items-center mt-auto">
                        <div class="flex flex-col">${item.originalPrice > item.price ? `<span class="text-[9px] text-gray-400 line-through">${formatRupiah(item.originalPrice)}</span>` : ''}<span class="text-orange-600 font-bold text-xs">${formatRupiah(item.price)}</span></div>
                        <button onclick="event.stopPropagation(); handleAddToCart(${item.id})" class="bg-orange-50 text-orange-600 rounded-full w-6 h-6 flex items-center justify-center hover:bg-orange-600 hover:text-white transition active:scale-90"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                </div>`).join('');
        }

        function renderVendorList() {
            const container = document.getElementById('vendor-list');
            if(!vendorsData || vendorsData.length === 0) { container.innerHTML = `<div class="text-center text-gray-400 text-xs py-10">Belum ada mitra penjual.</div>`; return; }
            const sortedVendors = [...vendorsData].sort((a, b) => (a.status === b.status ? 0 : a.status === 'Buka' ? -1 : 1));
            container.innerHTML = sortedVendors.map(vendor => `
                <div onclick="openVendor('${vendor.id}')" class="list-item-optimized bg-white p-4 rounded-[1.5rem] shadow-sm border border-gray-100 flex gap-4 items-center hover:bg-orange-50/30 transition cursor-pointer active:scale-[0.99] ${vendor.status === 'Tutup' ? 'shop-closed' : ''}">
                    <div class="w-16 h-16 rounded-full bg-gray-200 overflow-hidden shrink-0 border-2 border-white shadow-sm">
                        <img src="${vendor.img}" class="w-full h-full object-cover" loading="lazy" decoding="async" onerror="this.src='https://placehold.co/100?text=Logo'">
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-gray-800 text-base">${vendor.name}</h4>
                            ${vendor.status === 'Tutup' ? '<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full font-bold">TUTUP</span>' : '<span class="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full font-bold">BUKA</span>'}
                        </div>
                        <p class="text-xs text-gray-500 font-medium mb-1">${vendor.type} â€¢ ${vendor.distance}</p>
                        <div class="flex items-center gap-1">
                            <div class="flex text-yellow-400 text-[10px]"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i></div><span class="text-xs font-bold text-gray-700 ml-1">${vendor.rating}</span>
                        </div>
                    </div>
                    <div class="text-gray-300"><i class="fas fa-chevron-right text-sm"></i></div>
                </div>`).join('');
        }

        // --- CART & POINTS LOGIC ---
        function renderPointsUI() {
            document.getElementById('point-display-count').innerText = userPoints;
            const percent = Math.min((userPoints / 10) * 100, 100);
            document.getElementById('point-progress-bar').style.width = `${percent}%`;
            if (userPoints >= 10) {
                document.getElementById('point-target-text').innerText = "Target Tercapai!";
                document.getElementById('btn-redeem-point').disabled = false;
                document.getElementById('btn-redeem-point').classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                document.getElementById('btn-redeem-point').classList.add('bg-orange-600', 'text-white', 'shadow-lg', 'active:scale-95');
                document.getElementById('btn-redeem-point').innerText = "Tukar Sekarang";
            } else {
                const needs = 10 - userPoints;
                document.getElementById('point-target-text').innerText = `Kurang ${needs} poin lagi`;
                document.getElementById('btn-redeem-point').disabled = true;
                document.getElementById('btn-redeem-point').classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                document.getElementById('btn-redeem-point').classList.remove('bg-orange-600', 'text-white', 'shadow-lg', 'active:scale-95');
                document.getElementById('btn-redeem-point').innerText = "Tukar Poin (Butuh 10 Poin)";
            }
        }

        function redeemPoints() {
            if (userPoints >= 10) {
                if(confirm("Tukarkan 10 Poin dengan Gratis Ongkir Rp 5.000?")) {
                    userPoints -= 10;
                    isFreeShippingActive = true;
                    renderPointsUI();
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white text-gray-800 p-6 rounded-2xl shadow-2xl z-[120] flex flex-col items-center animate-bounce';
                    toast.innerHTML = `<div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-500 text-3xl mb-3"><i class="fas fa-check"></i></div><h3 class="font-bold text-lg mb-1">Berhasil Ditukar!</h3><p class="text-xs text-gray-500 text-center">Diskon Ongkir Rp 5.000 aktif untuk pesanan berikutnya.</p>`;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 2500);
                }
            }
        }

        function openCart() {
            const modal = document.getElementById('cart-modal');
            const content = document.getElementById('cart-content');
            const container = document.getElementById('cart-items-container');
            const form = document.getElementById('checkout-form');
            const ongkirInfoBox = document.getElementById('info-ongkir-box');

            modal.classList.remove('hidden');
            setTimeout(() => { content.classList.remove('translate-y-full'); }, 10);

            // Update Info Ongkir Box
            if (isFreeShippingActive) {
                ongkirInfoBox.innerHTML = `<div class="flex items-start gap-2 mb-1"><i class="fas fa-ticket-alt text-orange-600 mt-0.5"></i><p class="text-[11px] text-orange-800 font-bold leading-tight">Voucher Gratis Ongkir (5rb) Aktif!</p></div><p class="text-[10px] text-orange-700 ml-5">Akan otomatis dipotong di WhatsApp.</p>`;
                ongkirInfoBox.classList.replace('bg-green-50', 'bg-orange-50');
                ongkirInfoBox.classList.replace('border-green-100', 'border-orange-100');
            } else {
                ongkirInfoBox.innerHTML = `<div class="flex items-start gap-2 mb-1"><i class="fas fa-check-circle text-green-600 mt-0.5"></i><p class="text-[11px] text-green-800 font-bold leading-tight">Ongkir nanti dihitung oleh admin berdasarkan alamat kamu.</p></div><p class="text-[10px] text-green-700 ml-5">PASTI LEBIH HEMAT!</p>`;
                ongkirInfoBox.classList.replace('bg-orange-50', 'bg-green-50');
                ongkirInfoBox.classList.replace('border-orange-100', 'border-green-100');
            }

            if (cart.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-400 flex flex-col items-center"><div class="bg-gray-100 p-4 rounded-full mb-3"><i class="fas fa-shopping-basket text-4xl text-gray-300"></i></div><p class="font-medium text-gray-500">Keranjang masih kosong</p><button onclick="closeCart()" class="mt-4 text-orange-600 font-bold text-sm">Kembali Belanja</button></div>`;
                form.classList.add('hidden');
            } else {
                form.classList.remove('hidden');
                const grouped = {};
                cart.forEach(item => { if (!grouped[item.vendor]) grouped[item.vendor] = []; grouped[item.vendor].push(item); });
                let html = '';
                for (const vendor in grouped) {
                    html += `<div class="bg-gray-50 rounded-2xl p-3 border border-gray-100"><div class="flex items-center gap-2 mb-2 pb-2 border-b border-gray-200"><i class="fas fa-store text-orange-600 text-xs"></i><h4 class="font-bold text-sm text-gray-800">${vendor}</h4></div>`;
                    grouped[vendor].forEach(item => {
                        html += `<div class="flex justify-between items-center mb-2 last:mb-0"><div class="flex gap-2 items-center"><div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden shrink-0"><img src="${item.image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100?text=No+Img'"></div><div><p class="text-xs font-bold text-gray-700 line-clamp-1">${item.name}</p>${item.variant ? `<p class="text-[9px] text-orange-600 bg-orange-50 px-1 rounded inline-block mb-0.5">${item.variant}</p>` : ''}<div class="flex gap-1 items-center">${(item.originalPrice > item.price) ? `<p class="text-[9px] text-gray-400 line-through">${formatRupiah(item.originalPrice)}</p>` : ''}<p class="text-[10px] text-orange-600 font-bold">${formatRupiah(item.price)}</p></div></div></div><div class="flex items-center gap-2 bg-white rounded-lg px-1 py-0.5 border border-gray-200 shadow-sm"><button onclick="updateQty('${item.cartItemId}', -1)" class="w-6 h-6 flex items-center justify-center text-gray-500 text-[10px] hover:bg-gray-100 rounded">-</button><span class="text-xs font-bold w-4 text-center">${item.qty}</span><button onclick="updateQty('${item.cartItemId}', 1)" class="w-6 h-6 flex items-center justify-center text-green-600 text-[10px] hover:bg-gray-100 rounded">+</button></div></div>`;
                    });
                    html += `</div>`;
                }
                container.innerHTML = html;
            }
        }

        // --- NAVIGATION & INIT ---
        function navTo(pageId, addToStack = true) {
            document.querySelectorAll('.page-section').forEach(el => { el.classList.add('hidden-page'); el.classList.remove('z-50', 'z-40', 'z-30'); });
            const target = document.getElementById(pageId);
            target.classList.remove('hidden-page');
            const scrollContainer = target.querySelector('.overflow-y-auto'); if (scrollContainer) scrollContainer.scrollTop = 0;
            if (pageId === 'home-page') target.classList.add('z-20'); else target.classList.add('z-50');
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active'); el.querySelector('i').classList.replace('text-orange-600', 'text-gray-400'); el.querySelector('span').classList.remove('font-bold', 'text-orange-600'); });
            
            const navMap = { 'home-page': 'nav-home', 'search-page': null, 'points-page': 'nav-points', 'orders-page': 'nav-orders', 'profile-page': 'nav-profile' };
            
            if (navMap[pageId]) { 
                const navEl = document.getElementById(navMap[pageId]); 
                if(navEl) {
                    navEl.classList.add('active'); 
                    navEl.querySelector('i').classList.replace('text-gray-400', 'text-orange-600'); 
                    navEl.querySelector('span').classList.add('font-bold', 'text-orange-600'); 
                }
            }
            if (addToStack) { navHistory.push(pageId); history.pushState({ page: pageId }, null, ""); }
            if (pageId === 'points-page') renderPointsUI();
        }

        function handleBack() { window.history.back(); }
        window.onpopstate = function(event) {
            const modals = ['cart-modal', 'variant-modal', 'edit-profile-modal', 'address-modal', 'partnership-modal', 'add-address-modal']; 
            for (const mId of modals) {
                const m = document.getElementById(mId);
                if (m && !m.classList.contains('hidden')) {
                    if (mId === 'cart-modal') closeCart();
                    else if (mId === 'variant-modal') closeVariantModal();
                    else if (mId === 'edit-profile-modal') closeEditProfile();
                    else if (mId === 'add-address-modal') closeAddAddressModal();
                    else if (mId === 'address-modal') closeAddressModal();
                    else if (mId === 'partnership-modal') closePartnershipModal();
                    history.pushState(null, null, window.location.href);
                    return;
                }
            }
            if (navHistory.length > 1) { navHistory.pop(); const prevPage = navHistory[navHistory.length - 1]; navTo(prevPage, false); } else { const now = new Date().getTime(); if (now - lastBackPressTime < 2000) { history.back(); } else { lastBackPressTime = now; const toast = document.createElement('div'); toast.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs font-bold py-2 px-4 rounded-full shadow-lg z-[90] animate-bounce'; toast.innerText = 'Tekan sekali lagi untuk keluar aplikasi'; document.body.appendChild(toast); setTimeout(() => toast.remove(), 2000); history.pushState(null, null, window.location.href); } }
        };
        window.addEventListener('load', () => { history.replaceState({ page: 'home-page' }, null, ""); updateProfileUI(); initLocation(); fetchData(); });
        
        function renderCategories() {
            if(!categoriesData || categoriesData.length === 0) { document.getElementById('categories-container').innerHTML = `<div class="col-span-4 text-center text-gray-400 text-xs py-4">Kategori Kosong.</div>`; return; }
            document.getElementById('categories-container').innerHTML = categoriesData.map(cat => `<div onclick="openCategory('${cat.id}', '${cat.name}')" class="category-icon flex flex-col items-center gap-1 cursor-pointer group select-none"><div class="w-16 h-16 flex items-center justify-center transition-all duration-300 active:scale-90"><img src="${cat.img}" alt="${cat.name}" class="w-14 h-14 object-contain icon-3d" onerror="this.src='https://img.icons8.com/3d-fluency/94/menu.png'"></div><span class="text-[11px] font-bold text-gray-700 text-center leading-tight tracking-wide">${cat.name}</span></div>`).join('');
        }
        function handleGlobalSearch(query) {
            const container = document.getElementById('search-results');
            if (!query) { container.innerHTML = `<div class="text-center mt-10 text-gray-400"><i class="fas fa-search text-4xl mb-2"></i><p class="text-sm">Ketik untuk mencari...</p></div>`; return; }
            const lowerQuery = query.toLowerCase();
            const filteredProducts = productsData.filter(p => p.name.toLowerCase().includes(lowerQuery) || p.vendor.toLowerCase().includes(lowerQuery));
            const filteredVendors = vendorsData.filter(v => v.name.toLowerCase().includes(lowerQuery));
            filteredVendors.sort((a, b) => (a.status === b.status ? 0 : a.status === 'Buka' ? -1 : 1));
            let html = '';
            if (filteredVendors.length > 0) {
                html += `<h4 class="font-bold text-gray-800 text-sm mb-2 mt-2">Warung/Resto</h4>`;
                html += filteredVendors.map(v => `<div onclick="openVendor('${v.id}')" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex gap-3 items-center mb-2 cursor-pointer ${v.status === 'Tutup' ? 'shop-closed' : ''}"><img src="${v.img}" class="w-10 h-10 rounded-full object-cover bg-gray-200" onerror="this.src='https://placehold.co/100?text=Resto'"><div><p class="font-bold text-sm text-gray-800">${v.name}</p><p class="text-[10px] text-gray-500">${v.type}</p></div></div>`).join('');
            }
            if (filteredProducts.length > 0) {
                html += `<h4 class="font-bold text-gray-800 text-sm mb-2 mt-4">Menu Makanan</h4>`;
                html += filteredProducts.map(p => `<div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex gap-3 mb-2"><img src="${p.image}" class="w-16 h-16 rounded-full object-cover bg-gray-200" onerror="this.src='https://placehold.co/100?text=Menu'"><div class="flex-1"><p class="font-bold text-sm text-gray-800">${p.name}</p><p class="text-[10px] text-gray-500">${p.vendor}</p>${p.variants && p.variants.length > 0 ? '<p class="text-[9px] text-orange-600 mt-1">Ada Pilihan Varian</p>' : ''}<div class="flex justify-between mt-2 items-center"><div>${(p.originalPrice > p.price) ? `<span class="text-[10px] text-gray-400 line-through mr-1">${formatRupiah(p.originalPrice)}</span>` : ''}<span class="text-orange-600 font-bold text-xs">${formatRupiah(p.price)}</span></div><button onclick="handleAddToCart(${p.id})" class="text-orange-600 text-xs font-bold">+ Pesan</button></div></div></div>`).join('');
            }
            if (!filteredVendors.length && !filteredProducts.length) { html = `<div class="text-center mt-10 text-gray-400"><p class="text-sm">Tidak ditemukan hasil.</p></div>`; }
            container.innerHTML = html;
        }

        // --- Functions Logic for Address, Profile, Variant, etc ---
        function openAddressModal() { renderAddressList(); document.getElementById('address-modal').classList.remove('hidden'); }
        function closeAddressModal() { document.getElementById('address-modal').classList.add('hidden'); }
        function renderAddressList() { const container = document.getElementById('address-list-container'); container.innerHTML = savedAddresses.map(addr => `<div class="bg-white p-3 rounded-2xl border border-gray-200 flex justify-between items-center cursor-pointer hover:border-orange-500 group" onclick="selectAddress('${addr.detail}')"><div><span class="text-xs font-bold bg-gray-100 text-gray-600 px-2 py-0.5 rounded mb-1 inline-block">${addr.label}</span><p class="text-sm text-gray-800 leading-tight">${addr.detail}</p></div><button onclick="event.stopPropagation(); deleteAddress(${addr.id})" class="text-gray-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button></div>`).join(''); }
        function deleteAddress(id) { if (confirm('Hapus alamat ini?')) { savedAddresses = savedAddresses.filter(a => a.id !== id); renderAddressList(); } }
        function openAddAddressModal() { const modal = document.getElementById('add-address-modal'); const content = document.getElementById('add-address-content'); document.getElementById('new-addr-detail').value = ''; document.getElementById('new-addr-note').value = ''; setAddressLabel('Rumah'); modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('translate-y-full'); }, 10); }
        function closeAddAddressModal() { const modal = document.getElementById('add-address-modal'); const content = document.getElementById('add-address-content'); content.classList.add('translate-y-full'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }
        function setAddressLabel(label) { document.getElementById('new-addr-label').value = label; document.querySelectorAll('.addr-label-btn').forEach(btn => { if(btn.innerText === label) { btn.classList.add('border-orange-500', 'bg-orange-50', 'text-orange-600'); btn.classList.remove('border-gray-200', 'text-gray-600'); } else { btn.classList.remove('border-orange-500', 'bg-orange-50', 'text-orange-600'); btn.classList.add('border-gray-200', 'text-gray-600'); } }); }
        function saveNewAddress() { const label = document.getElementById('new-addr-label').value; const detail = document.getElementById('new-addr-detail').value; const note = document.getElementById('new-addr-note').value; if (!detail) { const input = document.getElementById('new-addr-detail'); input.classList.add('border-red-500', 'animate-pulse'); setTimeout(() => input.classList.remove('border-red-500', 'animate-pulse'), 1000); return; } const finalDetail = note ? `${detail} (${note})` : detail; savedAddresses.push({ id: Date.now(), label: label || "Alamat", detail: finalDetail }); renderAddressList(); closeAddAddressModal(); const toast = document.createElement('div'); toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs font-bold py-2 px-4 rounded-full shadow-lg z-[95] animate-bounce flex items-center'; toast.innerHTML = `<i class="fas fa-check-circle mr-2 text-green-400"></i> Alamat Berhasil Disimpan`; document.body.appendChild(toast); setTimeout(() => toast.remove(), 2000); }
        function addNewAddress() { openAddAddressModal(); }
        function selectAddress(detail) { document.getElementById('delivery-address').value = detail; alert(`Alamat "${detail}" dipilih.`); closeAddressModal(); }
        function updateProfileUI() { document.getElementById('profile-name-text').innerText = userProfile.name; document.getElementById('profile-phone-text').innerText = userProfile.phone; document.getElementById('profile-avatar-img').src = userProfile.avatar; }
        function openEditProfile() { document.getElementById('edit-name-input').value = userProfile.name; document.getElementById('edit-phone-input').value = userProfile.phone; document.getElementById('edit-profile-modal').classList.remove('hidden'); }
        function closeEditProfile() { document.getElementById('edit-profile-modal').classList.add('hidden'); }
        function saveProfile() { const newName = document.getElementById('edit-name-input').value; const newPhone = document.getElementById('edit-phone-input').value; if (newName && newPhone) { userProfile.name = newName; userProfile.phone = newPhone; userProfile.avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(newName)}&background=random`; updateProfileUI(); closeEditProfile(); } }
        function toggleFavorite(event, id) { event.stopPropagation(); const btn = event.currentTarget; if (favorites.has(id)) { favorites.delete(id); btn.innerHTML = `<i class="far fa-heart text-gray-400 text-xs"></i>`; } else { favorites.add(id); btn.innerHTML = `<i class="fas fa-heart text-red-500 text-xs liked-anim"></i>`; } const catTitle = document.getElementById('cat-page-title').innerText; if (!document.getElementById('category-page').classList.contains('hidden-page') && catTitle === 'Makanan Favorit') { openFavoritesPage(false); } }
        function openFavoritesPage(navigate = true) { if (navigate) navTo('category-page'); document.getElementById('cat-page-title').innerText = 'Makanan Favorit'; const container = document.getElementById('category-content-container'); const favProducts = productsData.filter(p => favorites.has(p.id)); if (favProducts.length === 0) { container.innerHTML = '<div class="col-span-2 text-center text-gray-400 mt-10"><i class="far fa-heart text-4xl mb-2"></i><p>Belum ada makanan favorit.</p></div>'; } else { renderProductGrid(favProducts, container); } }
        function openCategory(catId, catName) { navTo('category-page'); document.getElementById('cat-page-title').innerText = catName; const container = document.getElementById('category-content-container'); container.innerHTML = '<div class="col-span-2 text-center py-10"><i class="fas fa-spinner fa-spin text-orange-500"></i> Memuat...</div>'; setTimeout(() => { const filtered = catId === 'all' ? productsData : productsData.filter(p => p.category === catId); if (filtered.length === 0) { container.innerHTML = '<div class="col-span-2 text-center text-gray-400 mt-10">Belum ada menu di kategori ini.</div>'; return; } renderProductGrid(filtered, container); }, 300); }
        function openVendor(vendorId) { const vendor = vendorsData.find(v => String(v.id) === String(vendorId)); if (!vendor) return; document.getElementById('vendor-banner-img').src = vendor.img || "https://placehold.co/600x200?text=Resto"; document.getElementById('vendor-name-title').innerText = vendor.name; document.getElementById('vendor-info-subtitle').innerText = `${vendor.status} â€¢ ${vendor.type} â€¢ ${vendor.distance}`; document.getElementById('vendor-rating-badge').innerText = vendor.rating; const container = document.getElementById('vendor-menu-container'); const vendorProducts = productsData.filter(p => p.vendor === vendor.name); if (vendorProducts.length === 0) { container.innerHTML = `<p class="text-center text-gray-400 text-sm py-10">Belum ada menu.</p>`; } else { container.innerHTML = vendorProducts.map(item => `<div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex gap-3"><div class="w-20 h-20 bg-gray-200 rounded-3xl overflow-hidden shrink-0 relative"><img src="${item.image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100?text=No+Img'"><button onclick="toggleFavorite(event, ${item.id})" class="absolute top-1 right-1 w-6 h-6 bg-white/80 rounded-full flex items-center justify-center shadow-sm z-10"><i class="${favorites.has(item.id) ? 'fas fa-heart text-red-500' : 'far fa-heart text-gray-400'} text-[10px]"></i></button></div><div class="flex-1 flex flex-col justify-between"><div><h4 class="font-bold text-gray-800 text-sm line-clamp-1">${item.name}</h4><p class="text-[10px] text-gray-500 line-clamp-2">${item.description || 'Menu lezat dari ' + item.vendor}</p>${item.variants && item.variants.length > 0 ? `<p class="text-[9px] text-orange-600 bg-orange-50 inline-block px-1.5 rounded mt-1">Ada Pilihan Varian</p>` : ''}</div><div class="flex justify-between items-end mt-1"><div class="flex flex-col">${item.originalPrice > item.price ? `<span class="text-[10px] text-gray-400 line-through">${formatRupiah(item.originalPrice)}</span>` : ''}<span class="text-orange-600 font-bold text-sm">${formatRupiah(item.price)}</span></div>${vendor.status === 'Buka' ? `<button onclick="handleAddToCart(${item.id})" class="bg-orange-100 text-orange-600 w-7 h-7 rounded-full flex items-center justify-center hover:bg-orange-600 hover:text-white transition"><i class="fas fa-plus text-xs"></i></button>` : `<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded">Tutup</span>`}</div></div></div>`).join(''); } navTo('vendor-page'); }
        function handleAddToCart(id) { const product = productsData.find(p => p.id === id); if (!product) return; if (product.variants && product.variants.length > 0) { openVariantModal(product); } else { addToCart(id, null); } }
        function openVariantModal(product) { tempSelectedProduct = product; document.getElementById('variant-modal-img').src = product.image || "https://placehold.co/300?text=No+Img"; document.getElementById('variant-modal-title').innerText = product.name; document.getElementById('variant-modal-price').innerText = formatRupiah(product.price); document.getElementById('variant-options-container').innerHTML = product.variants.map((v, index) => `<div class="relative"><input type="radio" name="product_variant" id="var_${index}" value="${v}" class="variant-radio peer hidden" ${index === 0 ? 'checked' : ''}><label for="var_${index}" class="flex items-center justify-between w-full p-3 bg-white border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 peer-checked:bg-orange-50 peer-checked:border-orange-500 transition-all"><span class="text-sm font-medium text-gray-700">${v}</span><i class="fas fa-check-circle text-orange-500 hidden check-icon"></i></label></div>`).join(''); document.getElementById('variant-modal').classList.remove('hidden'); }
        function closeVariantModal() { document.getElementById('variant-modal').classList.add('hidden'); tempSelectedProduct = null; }
        function confirmVariantAdd() { if (!tempSelectedProduct) return; const selectedVariant = document.querySelector('input[name="product_variant"]:checked'); if (selectedVariant) { addToCart(tempSelectedProduct.id, selectedVariant.value); closeVariantModal(); } else { alert("Pilih varian dulu ya!"); } }
        function addToCart(id, variant) { const product = productsData.find(p => p.id === id); if (!product) return; const cartItemId = variant ? `${id}-${variant}` : `${id}`; const existingItem = cart.find(item => item.cartItemId === cartItemId); if (existingItem) { existingItem.qty += 1; } else { cart.push({ ...product, qty: 1, variant: variant || "", cartItemId: cartItemId }); } updateCartUI(); const toast = document.createElement('div'); toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white text-xs font-bold py-2 px-4 rounded-full shadow-lg z-[90] animate-bounce pointer-events-none flex items-center'; toast.innerHTML = `<i class="fas fa-check-circle mr-1"></i> ${product.name} +1`; document.body.appendChild(toast); setTimeout(() => toast.remove(), 1500); }
        function updateCartUI() { 
            const totalQty = cart.reduce((sum, item) => sum + item.qty, 0); 
            const badges = [document.getElementById('cart-badge-header'), document.getElementById('cart-badge-nav')]; 
            badges.forEach(badge => { 
                if (badge) { 
                    if (totalQty > 0) { 
                        badge.innerText = totalQty; badge.classList.remove('hidden'); 
                    } else { 
                        badge.classList.add('hidden'); 
                    } 
                } 
            }); 

            // Logic Multi Vendor Alert
            const uniqueVendors = new Set(cart.map(item => item.vendor));
            const multiVendorAlert = document.getElementById('multi-vendor-alert');
            if (multiVendorAlert) {
                if (uniqueVendors.size > 1) {
                    multiVendorAlert.classList.remove('hidden');
                } else {
                    multiVendorAlert.classList.add('hidden');
                }
            }

            const totalOriginal = cart.reduce((sum, item) => sum + (item.originalPrice * item.qty), 0); 
            const totalFinal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0); 
            const totalSavings = totalOriginal - totalFinal; 
            document.getElementById('cart-total-original').innerText = formatRupiah(totalOriginal); 
            document.getElementById('cart-total-final').innerText = formatRupiah(totalFinal); 
            if (totalSavings > 0) { 
                document.getElementById('cart-savings-text').innerText = `Anda lebih hemat ${formatRupiah(totalSavings)}`; 
                document.getElementById('cart-savings-text').parentElement.classList.remove('hidden'); 
            } else { 
                document.getElementById('cart-savings-text').parentElement.classList.add('hidden'); 
            } 
        }
        function closeCart() { const modal = document.getElementById('cart-modal'); const content = document.getElementById('cart-content'); content.classList.add('translate-y-full'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }
        function updateQty(cartItemId, change) { const itemIndex = cart.findIndex(item => item.cartItemId === cartItemId); if (itemIndex > -1) { cart[itemIndex].qty += change; if (cart[itemIndex].qty <= 0) cart.splice(itemIndex, 1); updateCartUI(); openCart(); } }
        
        function checkoutToWA() { 
            const address = document.getElementById('delivery-address').value; 
            if (!address.trim()) { alert("Mohon isi alamat pengantaran lengkap."); document.getElementById('delivery-address').focus(); return; } 
            const phoneNumber = "6281292802623"; 
            
            // SIMULASI TAMBAH POIN SAAT CHECKOUT
            userPoints += 1; // Menambah 1 poin otomatis
            renderPointsUI(); // Refresh UI poin di background
            
            let message = `Halo Admin ProjekGo, saya mau pesan:%0A%0A`; 
            
            const grouped = {}; 
            let totalOriginal = 0; 
            let totalFinal = 0; 
            cart.forEach(item => { if (!grouped[item.vendor]) grouped[item.vendor] = []; grouped[item.vendor].push(item); totalOriginal += item.originalPrice * item.qty; totalFinal += item.price * item.qty; }); 
            
            for (const vendor in grouped) { 
                message += `*ðŸª ${vendor}*%0A`; 
                grouped[vendor].forEach(item => { 
                    const variantText = item.variant ? ` (${item.variant})` : ''; 
                    message += `- ${item.qty}x ${item.name}${variantText} (@ ${item.price / 1000}k)%0A`; 
                }); 
                message += `%0A`; 
            } 
            
            const savings = totalOriginal - totalFinal; 
            message += `ðŸ’° *Total Bayar: ${formatRupiah(totalFinal)}*%0A`; 
            if (savings > 0) message += `ðŸ”¥ *Hemat: ${formatRupiah(savings)}*%0A`; 
            
            // Tambahkan Info Voucher jika aktif
            if(isFreeShippingActive) {
                message += `ðŸŽŸ *Voucher: GRATIS ONGKIR (Tukar 10 Poin)*%0A`;
                // Reset voucher after usage (simulation)
                isFreeShippingActive = false;
                renderPointsUI();
            }

            message += `ðŸ“ *Alamat:* ${encodeURIComponent(address)}%0A`; 
            message += `Mohon info total beserta ongkirnya ya kak. Terima kasih!`; 
            
            window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank'); 
        }

        function formatRupiah(number) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumSignificantDigits: 3 }).format(number); }
        function openPartnershipModal() { document.getElementById('partnership-modal').classList.remove('hidden'); }
        function closePartnershipModal() { document.getElementById('partnership-modal').classList.add('hidden'); }
        function openSellerRegistration() { closePartnershipModal(); const modal = document.getElementById('seller-register-modal'); const content = document.getElementById('seller-register-content'); modal.classList.remove('hidden'); setTimeout(() => content.classList.remove('translate-y-full'), 10); }
        function closeSellerRegistration() { const modal = document.getElementById('seller-register-modal'); const content = document.getElementById('seller-register-content'); content.classList.add('translate-y-full'); setTimeout(() => modal.classList.add('hidden'), 300); }
        function openRiderRegistration() { closePartnershipModal(); const modal = document.getElementById('rider-info-modal'); modal.classList.remove('hidden'); } 
        function closeRiderInfo() { document.getElementById('rider-info-modal').classList.add('hidden'); } 
        function closeRiderRegistration() { const modal = document.getElementById('rider-register-modal'); const content = document.getElementById('rider-register-content'); content.classList.add('translate-y-full'); setTimeout(() => modal.classList.add('hidden'), 300); }
        function previewImage(input, previewId) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.getElementById(previewId).src = e.target.result; document.getElementById(previewId).classList.remove('hidden'); document.getElementById(previewId + '-container').classList.add('opacity-0'); }; reader.readAsDataURL(input.files[0]); } }
        
        function initLocation() { const locText = document.getElementById('header-address-text'); locText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mencari...'; if (navigator.geolocation) { const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }; navigator.geolocation.getCurrentPosition(async (position) => { const lat = position.coords.latitude; const lon = position.coords.longitude; try { const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`); const data = await response.json(); const kecamatan = data.address.suburb || data.address.village || data.address.city_district || "Lokasi Terdeteksi"; const city = data.address.city || data.address.town || data.address.county || ""; locText.innerText = `${kecamatan}, ${city}`; } catch (error) { locText.innerText = "Lokasi tidak ditemukan"; console.error("Geocoding error:", error); } }, (error) => { locText.innerText = "Lokasi belum diatur"; }, options); } else { locText.innerText = "GPS tidak didukung"; } }
        
        function openExclusivePage() {
            navTo('exclusive-page');
            const container = document.getElementById('exclusive-content-container');
            container.innerHTML = '<div class="col-span-2 text-center py-10"><i class="fas fa-spinner fa-spin text-orange-500"></i> Memuat...</div>';
            setTimeout(() => {
                const exclusiveProducts = productsData.filter(p => p.isExclusive);
                if (exclusiveProducts.length === 0) { container.innerHTML = '<div class="col-span-2 text-center text-gray-400 mt-10">Belum ada menu eksklusif saat ini.</div>'; return; }
                renderProductGrid(exclusiveProducts, container);
            }, 300);
        }
    </script>
</body>
</html>
