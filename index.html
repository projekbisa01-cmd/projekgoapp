<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Meta PWA -->
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default"> 
    <meta name="apple-mobile-web-app-title" content="ProjekGo">
    
    <title>ProjekGo - Katalog Kuliner</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        /* === PERFORMA TINGGI & RESET === */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
            touch-action: manipulation; 
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        .shadow-xl, .shadow-2xl, .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03) !important;
        }

        /* Fallback Backdrop Blur untuk performa mobile rendah */
        .backdrop-blur, .backdrop-blur-sm, .backdrop-blur-md {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            background-color: rgba(255, 255, 255, 0.85);
        }
        
        .bg-black\/20, .bg-black\/50, .bg-black\/60 {
            background-color: rgba(0, 0, 0, 0.7) !important;
        }

        #app-container {
            height: 100%;
            height: 100dvh; 
            max-width: 28rem;
            margin: 0 auto;
            background-color: #ffffff;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateZ(0);
        }

        /* === SCROLLING === */
        .scrolling-wrapper {
            -webkit-overflow-scrolling: touch; 
            overflow-y: auto;
            overflow-x: hidden;
            will-change: scroll-position;
            overscroll-behavior-y: none;
            padding-bottom: 6rem;
            scroll-behavior: auto; 
            transform: translateZ(0); 
            contain: content;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* FIX SCROLL ISSUE */
        .horizontal-slider {
            touch-action: pan-x pan-y; 
        }

        .optimized-list {
            content-visibility: auto; 
            contain-intrinsic-size: 100px 800px; 
        }

        .category-icon:active { transform: scale(0.9); }
        
        .page-section {
            transition: opacity 0.15s ease-out;
            opacity: 1;
            pointer-events: auto;
            position: absolute;
            inset: 0;
            background-color: #fff; 
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding-bottom: 5rem;
            transform: translate3d(0,0,0);
        }
        .hidden-page { opacity: 0; pointer-events: none; z-index: 0; display: none !important; }

        .nav-item.active i { color: #ea580c; }
        .nav-item.active span { color: #ea580c; font-weight: 700; }

        .shop-closed { filter: grayscale(100%); opacity: 0.6; pointer-events: none; }

        .variant-radio:checked + label {
            background-color: #fff7ed; border-color: #ea580c; color: #ea580c; font-weight: 700;
        }
        .variant-radio:checked + label .check-icon { display: block; }
        
        .liked-anim { animation: like-bounce 0.2s ease-in-out; }
        @keyframes like-bounce { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        .progress-bar-fill { transition: width 0.5s ease-out; }

        .leaflet-pane { z-index: 10; }
        .leaflet-top, .leaflet-bottom { z-index: 20; }
        .leaflet-container { touch-action: none; }
    </style>
</head>
<body>

    <div id="app-container">
        
        <!-- === HALAMAN UTAMA (HOME) === -->
        <div id="home-page" class="page-section z-20 bg-gray-50">
            <!-- 
               PERUBAHAN STRUKTUR: 
               Header dipindah ke dalam <main> agar bisa di-scroll.
               Search bar dibuat sticky.
            -->
            <main class="flex-1 overflow-y-auto hide-scrollbar scrolling-wrapper bg-white z-0 relative w-full pb-24">
                
                <!-- 1. Header Minimalis (Ikut Scroll) -->
                <div class="px-5 pt-12 pb-2 bg-white flex items-center justify-between gap-3">
                    <div>
                        <div class="flex items-center gap-1">
                             <span class="text-orange-600 text-2xl font-black tracking-tighter italic">PROJEK<span class="text-gray-800">GO</span></span>
                        </div>
                        <div class="flex items-center gap-1 mt-0.5 cursor-pointer active:opacity-70 transition" onclick="openLocationModal('header')">
                            <p class="text-xs font-bold text-gray-500 max-w-[180px] truncate" id="header-address-text">Pilih Wilayah</p>
                            <i class="fas fa-chevron-down text-[10px] text-orange-500"></i>
                        </div>
                    </div>
                    <button class="w-10 h-10 rounded-full bg-gray-50 border border-gray-100 flex items-center justify-center text-gray-700 active:scale-95 transition hover:bg-gray-100 shadow-sm" onclick="openPartnershipModal()">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>

                <!-- 2. Sticky Search Bar (Menempel di atas) -->
                <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-md px-5 py-3 shadow-[0_4px_20px_rgba(0,0,0,0.02)] transition-all">
                    <div class="relative group active:scale-[0.98] transition w-full" onclick="navTo('search-page')">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i class="fas fa-search text-orange-500 text-sm"></i>
                        </div>
                        <input type="text" placeholder="Cari makanan enak..." readonly
                            class="w-full py-3.5 pl-11 pr-5 rounded-2xl text-gray-700 text-xs font-bold bg-gray-100 border-none focus:ring-0 cursor-pointer placeholder-gray-400">
                    </div>
                </div>

                <!-- 3. Konten Utama (Scrollable) -->
                <div class="px-5 space-y-6 pt-2 pb-24">
                    
                    <!-- Kategori -->
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm">Kategori</h3>
                        </div>
                        <div class="grid grid-cols-4 gap-y-4" id="categories-container">
                            <div class="col-span-4 text-center text-gray-400 text-xs py-4">
                                <i class="fas fa-circle-notch fa-spin text-orange-500 mb-2"></i><br>Memuat...
                            </div>
                        </div>
                    </div>

                    <!-- Promo Banner -->
                    <div style="contain: content;">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm">Lagi Promo</h3>
                            <span class="text-orange-600 text-[10px] font-bold cursor-pointer" onclick="openExclusivePage()">Lihat Semua</span>
                        </div>
                        <div id="exclusive-slider" class="flex gap-3 overflow-x-auto hide-scrollbar pb-2 snap-x min-h-[120px] horizontal-slider" style="scroll-behavior: auto;">
                             <div class="w-full text-center text-gray-400 text-xs py-8">
                                <i class="fas fa-spinner fa-spin"></i> Memuat...
                            </div>
                        </div>
                    </div>

                    <!-- Paling Laris -->
                    <div style="contain: content;">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm">Paling Laris</h3>
                            <span class="text-orange-600 text-[10px] font-bold cursor-pointer" onclick="openCategory('all', 'Semua Menu')">Lihat Semua</span>
                        </div>
                        <div id="recommendation-slider" class="flex gap-3 overflow-x-auto hide-scrollbar pb-2 snap-x min-h-[120px] horizontal-slider" style="scroll-behavior: auto;">
                            <div class="w-full text-center text-gray-400 text-xs py-8">
                                <i class="fas fa-spinner fa-spin"></i> Memuat...
                            </div>
                        </div>
                    </div>

                    <!-- Daftar Penjual -->
                    <div>
                        <div class="flex justify-between items-end mb-3 sticky top-[70px] bg-white/95 backdrop-blur-sm z-10 py-2 -mx-5 px-5">
                            <h3 class="font-bold text-gray-800 text-sm">Warung Sekitar</h3>
                            <button onclick="fetchData()" class="text-orange-600 text-[10px] font-semibold flex items-center gap-1 hover:text-orange-700 active:scale-95 transition">
                                <i class="fas fa-sync-alt" id="refreshIcon"></i> Refresh
                            </button>
                        </div>
                        <div id="vendor-list" class="space-y-4 optimized-list">
                            <div class="text-center text-gray-400 text-xs py-10 bg-white rounded-2xl">
                                <i class="fas fa-store text-xl mb-2 text-gray-300"></i><br>Mencari Mitra...
                            </div>
                        </div>
                    </div>
                    
                </div>
            </main>
        </div>

        <!-- === HALAMAN PENCARIAN === -->
        <div id="search-page" class="page-section hidden-page z-30 bg-gray-50">
            <div class="bg-white p-3 shadow-sm flex items-center gap-3 sticky top-0 z-10">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-2.5 text-orange-500 text-xs"></i>
                    <input type="text" id="global-search-input" placeholder="Cari makanan atau resto..." 
                        class="w-full py-2 pl-9 pr-4 rounded-full bg-gray-100 text-gray-800 text-xs focus:outline-none focus:ring-2 focus:ring-orange-200"
                        oninput="debouncedSearch(this.value)">
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 scrolling-wrapper optimized-list" id="search-results">
                <div class="text-center mt-10 text-gray-400">
                    <i class="fas fa-search text-3xl mb-2"></i>
                    <p class="text-xs">Ketik untuk mencari...</p>
                </div>
            </div>
        </div>

        <!-- === HALAMAN POIN === -->
        <div id="points-page" class="page-section hidden-page z-30 bg-gray-50">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 sticky top-0 z-10">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Poin Saya</h2>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar scrolling-wrapper">
                <!-- Card Utama Poin -->
                <div class="bg-gradient-to-br from-orange-500 to-red-600 rounded-[1.5rem] p-5 text-white shadow-xl mb-6 relative overflow-hidden">
                    <div class="absolute -top-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl"></div>
                    <div class="absolute bottom-0 left-0 w-32 h-32 bg-yellow-400 opacity-10 rounded-full blur-xl"></div>
                    
                    <div class="relative z-10 flex flex-col items-center">
                        <p class="text-orange-100 text-xs font-medium mb-1">Saldo Poin</p>
                        <h1 class="text-5xl font-black mb-2 drop-shadow-sm" id="point-display-count">0</h1>
                        <div class="w-full bg-black/20 rounded-full h-2 mb-2 overflow-hidden">
                            <div id="point-progress-bar" class="bg-yellow-400 h-full rounded-full shadow-lg progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between w-full text-[10px] font-medium text-orange-100 px-1">
                            <span>0</span>
                            <span id="point-target-text">Target: 10 Poin</span>
                        </div>
                    </div>
                </div>

                <!-- Bagian Klaim Poin -->
                <div class="bg-white p-5 rounded-[1.5rem] shadow-sm mb-6 border border-gray-100">
                    <h3 class="font-bold text-gray-800 text-sm mb-3">Punya Kode Voucher?</h3>
                    <div class="flex gap-2">
                        <input type="text" id="claim-code-input" placeholder="Masukkan kode dari Admin" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-orange-500 uppercase">
                        <button onclick="claimPointCode()" class="bg-orange-600 text-white px-4 py-2 rounded-xl font-bold text-xs shadow-md active:scale-95">Klaim</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 italic">*Minta kode ke admin setelah pesananmu selesai diantar.</p>
                </div>

                <!-- Bagian Penukaran -->
                <div class="bg-white p-5 rounded-[1.5rem] shadow-sm mb-6 border border-gray-100">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-lg">
                            <i class="fas fa-truck-fast"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm">Gratis Ongkir Rp 5.000</h3>
                            <p class="text-[10px] text-gray-500">Tukarkan 10 Poin</p>
                        </div>
                    </div>
                    <button id="btn-redeem-point" onclick="redeemPoints()" disabled class="w-full py-3 rounded-xl font-bold text-xs transition-all duration-300 bg-gray-200 text-gray-400 cursor-not-allowed">
                        Tukar Poin
                    </button>
                </div>
            </div>
        </div>

        <!-- === HALAMAN PESANAN (History) === -->
        <div id="orders-page" class="page-section hidden-page z-30 bg-gray-50">
             <div class="bg-white p-4 shadow-sm flex items-center gap-4 sticky top-0 z-10">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Riwayat Pesanan</h2>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 scrolling-wrapper optimized-list" id="order-history-container">
                 <!-- Content akan diisi JS -->
            </div>
        </div>

        <!-- === HALAMAN PROFIL === -->
        <div id="profile-page" class="page-section hidden-page z-30 bg-gray-50">
            <div class="bg-orange-600 h-24 relative shrink-0"></div>
            <div class="px-4 -mt-10 relative z-10 mb-4 shrink-0">
                <div class="bg-white p-4 rounded-[1.5rem] shadow-md flex flex-col items-center relative">
                    <div class="w-16 h-16 bg-gray-200 rounded-full border-4 border-white -mt-10 mb-2 overflow-hidden shadow-sm">
                        <img src="https://ui-avatars.com/api/?name=User+ProjekGo&background=random" class="w-full h-full" id="profile-avatar-img" loading="lazy">
                    </div>
                    <button onclick="openEditProfile()" class="absolute top-2 right-2 text-gray-400 hover:text-orange-600 p-2">
                        <i class="fas fa-pen text-xs"></i>
                    </button>
                    <h2 class="font-bold text-base text-gray-800" id="profile-name-text">User ProjekGo</h2>
                    <p class="text-xs text-gray-500" id="profile-phone-text">+62 812-3456-7890</p>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto px-4 pb-20 scrolling-wrapper">
                <div class="space-y-3">
                    <button onclick="openAddressModal()" class="w-full bg-white p-3 rounded-2xl shadow-sm flex justify-between items-center text-gray-700 active:bg-gray-50 transition">
                        <span class="font-medium text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-full bg-orange-100 flex items-center justify-center text-orange-500"><i class="fas fa-map-marker-alt text-xs"></i></div> Alamat Tersimpan</span>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </button>
                    <button onclick="openFavoritesPage()" class="w-full bg-white p-3 rounded-2xl shadow-sm flex justify-between items-center text-gray-700 active:bg-gray-50 transition">
                        <span class="font-medium text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-full bg-red-100 flex items-center justify-center text-red-500"><i class="fas fa-heart text-xs"></i></div> Makanan Favorit</span>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </button>
                    <button class="w-full bg-white p-3 rounded-2xl shadow-sm flex justify-between items-center text-gray-700 active:bg-gray-50 transition">
                        <span class="font-medium text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-full bg-blue-100 flex items-center justify-center text-blue-500"><i class="fas fa-headset text-xs"></i></div> Bantuan</span>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- === HALAMAN KERANJANG (FULL PAGE - FIXED) === -->
        <div id="cart-page" class="page-section hidden-page z-50 bg-gray-50 flex flex-col h-full absolute inset-0">
            <!-- Header Cart -->
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 sticky top-0 z-20 flex-shrink-0">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Keranjang</h2>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar scrolling-wrapper">
                <div id="cart-items-container" class="space-y-4 pb-4 optimized-list">
                    <!-- Cart items will be rendered here -->
                </div>
                
                <!-- Checkout Form Area (Static part in scroll flow) -->
                <div id="checkout-form-container" class="border-t border-gray-200 pt-6 hidden pb-24">
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-700 mb-2">Lokasi Pengantaran</label>
                        <div class="flex flex-col gap-2">
                             <!-- Tombol Pin Lokasi -->
                            <div onclick="openLocationModal('checkout')" class="bg-orange-50 border border-orange-200 rounded-xl p-3 flex items-center gap-3 cursor-pointer active:scale-[0.99] transition">
                                <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 shrink-0">
                                    <i class="fas fa-map-marked-alt text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] font-bold text-orange-600 mb-0.5">Titik Lokasi</p>
                                    <p id="checkout-address-text" class="text-xs font-medium text-gray-800 line-clamp-2 leading-tight">Klik untuk atur pin lokasi di peta</p>
                                    <input type="hidden" id="checkout-lat">
                                    <input type="hidden" id="checkout-lng">
                                </div>
                                <i class="fas fa-chevron-right text-orange-300 text-xs"></i>
                            </div>
                            
                            <!-- Detail Alamat -->
                            <div class="relative">
                                <i class="fas fa-pen absolute left-3 top-3 text-gray-400 text-xs"></i>
                                <textarea id="checkout-note" rows="2" class="w-full bg-white border border-gray-200 rounded-xl py-2.5 pl-9 pr-4 text-xs focus:outline-none focus:border-orange-500 resize-none font-medium text-gray-700 shadow-sm" placeholder="Detail: Pagar hitam, Lantai 2, Depan Warung..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dynamic Summary will be injected here via JS -->
                    <div id="cart-summary-area"></div>
                </div>
            </div>
        </div>

        <!-- === HALAMAN KATEGORI / FAVORIT === -->
        <div id="category-page" class="page-section hidden-page z-40 bg-gray-50">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 z-10 shrink-0 sticky top-0">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 id="cat-page-title" class="text-lg font-bold text-gray-800">Kategori</h2>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar scrolling-wrapper">
                <div id="category-content-container" class="grid grid-cols-2 gap-3 pb-24 optimized-list"></div>
            </div>
        </div>

        <!-- NEW: HALAMAN "HANYA ADA DI PROJEKGO" -->
        <div id="exclusive-page" class="page-section hidden-page z-40 bg-gray-50">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 z-10 shrink-0 sticky top-0">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Eksklusif</h2>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar scrolling-wrapper">
                <div id="exclusive-content-container" class="grid grid-cols-2 gap-3 pb-24 optimized-list"></div>
            </div>
        </div>

        <!-- === HALAMAN DETAIL PENJUAL === -->
        <div id="vendor-page" class="page-section hidden-page z-50 bg-gray-50">
            <div class="relative h-48 bg-gray-300">
                <img id="vendor-banner-img" src="" class="w-full h-full object-cover rounded-none" loading="lazy" decoding="async">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                <button onclick="handleBack()" class="absolute top-4 left-4 w-9 h-9 bg-white/90 rounded-full text-black flex items-center justify-center hover:bg-white transition shadow-sm">
                    <i class="fas fa-arrow-left text-sm"></i>
                </button>
                <div class="absolute bottom-4 left-4 text-white w-full pr-4">
                    <div class="flex justify-between items-end">
                        <div>
                            <h2 id="vendor-name-title" class="text-xl font-bold leading-tight">Nama Warung</h2>
                            <p id="vendor-info-subtitle" class="text-[10px] opacity-90 mt-1">Status â€¢ Kategori</p>
                        </div>
                        <div class="bg-white/90 px-2 py-1 rounded-full flex items-center gap-1 text-black shadow-sm">
                            <i class="fas fa-star text-yellow-500 text-[10px]"></i>
                            <span id="vendor-rating-badge" class="text-[10px] font-bold">4.8</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 -mt-4 bg-gray-50 rounded-t-[1.5rem] relative z-10 hide-scrollbar scrolling-wrapper">
                <h3 class="font-bold text-gray-800 mb-4 text-sm">Daftar Menu</h3>
                <div id="vendor-menu-container" class="grid grid-cols-2 gap-3 pb-24 optimized-list"></div>
            </div>
        </div>

        <!-- === MODAL / SHEET LAYOUTS === -->
        
        <!-- MODAL PILIHAN WILAYAH (AWAL) -->
        <div id="region-choice-modal" class="absolute inset-0 z-[110] hidden bg-black/80 flex items-center justify-center p-6" style="backdrop-filter: none;">
            <div class="bg-white rounded-[2rem] w-full max-w-sm p-6 shadow-2xl animate-bounce-in">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-map-marked-alt text-2xl text-orange-600"></i>
                    </div>
                    <h2 class="text-xl font-black text-gray-800">Mau Jajan Dimana?</h2>
                    <p class="text-sm text-gray-500 mt-1">Pilih area sekitarmu untuk menemukan kuliner terbaik.</p>
                </div>
                <div class="space-y-3">
                    <button onclick="selectRegion('Gombong')" class="w-full bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-xl font-bold shadow-lg shadow-orange-200 transition active:scale-[0.98] flex items-center justify-between group">
                        <span>Area Gombong</span>
                        <i class="fas fa-chevron-right group-hover:translate-x-1 transition"></i>
                    </button>
                    <button onclick="selectRegion('Kebumen')" class="w-full bg-white border-2 border-gray-100 hover:border-orange-500 text-gray-700 p-4 rounded-xl font-bold transition active:scale-[0.98] flex items-center justify-between group">
                        <span>Kebumen Kota</span>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:text-orange-500 transition"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL LOKASI (MAPS) -->
        <div id="location-modal" class="absolute inset-0 z-[100] hidden bg-white flex-col">
            <div class="p-4 shadow-sm flex items-center gap-3 bg-white z-10">
                <button onclick="closeLocationModal()" class="p-2 hover:bg-gray-100 rounded-full"><i class="fas fa-arrow-left"></i></button>
                <h2 class="font-bold text-lg text-gray-800">Pin Lokasi</h2>
            </div>
            
            <div class="relative flex-1 bg-gray-100">
                <div id="map" class="absolute inset-0 z-0"></div>
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10 pointer-events-none mb-8">
                    <i class="fas fa-map-marker-alt text-4xl text-red-500 drop-shadow-md animate-bounce"></i>
                </div>
                <button onclick="getCurrentLocation()" class="absolute bottom-6 right-4 z-10 bg-white p-3 rounded-full shadow-lg text-orange-600 active:scale-90">
                    <i class="fas fa-crosshairs text-xl"></i>
                </button>
            </div>

            <div class="p-5 bg-white rounded-t-[2rem] shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-20 -mt-6 relative">
                <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
                <h3 class="font-bold text-gray-800 text-sm mb-1">Titik Pilihan</h3>
                <p id="selected-address" class="text-xs text-gray-500 mb-4 line-clamp-2 h-8">Geser peta untuk menentukan titik...</p>
                <button onclick="confirmLocation()" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-[0.98] transition">
                    Gunakan Lokasi Ini
                </button>
            </div>
        </div>

        <!-- SELLER REGISTRATION SHEET -->
        <div id="seller-register-modal" class="absolute inset-0 z-[100] hidden">
            <div class="absolute inset-0 bg-black/50" onclick="closeSellerRegistration()"></div> <!-- Removed backdrop-blur -->
            <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6 min-h-[85%] flex flex-col transition-transform duration-300 transform translate-y-full" id="seller-register-content">
                <button onclick="closeSellerRegistration()" class="absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 hover:text-red-500 transition z-20"><i class="fas fa-times"></i></button>
                <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4 cursor-grab" onclick="closeSellerRegistration()"></div>
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600"><i class="fas fa-store"></i></div>
                    <div><h3 class="font-bold text-xl text-gray-800 leading-none">Formulir Mitra Penjual</h3><p class="text-xs text-gray-500 mt-1">Daftar sekarang untuk mulai berjualan</p></div>
                </div>
                <div class="flex-1 overflow-y-auto hide-scrollbar space-y-5 pb-6">
                    <div>
                        <h4 class="text-sm font-bold text-gray-800 mb-3 border-l-4 border-orange-500 pl-2">Informasi Pemilik</h4>
                        <div class="space-y-3">
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Nama Lengkap Pemilik</label><input type="text" id="reg-seller-name" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500 font-medium" placeholder="Contoh: Budi Santoso"></div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Nomor WhatsApp Aktif</label><div class="relative"><span class="absolute left-4 top-3 text-gray-500 font-medium text-sm">+62</span><input type="tel" id="reg-seller-phone" class="w-full bg-gray-50 border border-gray-200 rounded-2xl pl-12 pr-4 py-3 text-sm focus:outline-none focus:border-orange-500 font-medium" placeholder="8123456789"></div></div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-gray-800 mb-3 border-l-4 border-orange-500 pl-2">Informasi Usaha</h4>
                        <div class="space-y-3">
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Nama Resto / Warung</label><input type="text" id="reg-seller-biz" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500 font-medium" placeholder="Contoh: Warung Sejahtera"></div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Kategori Makanan</label>
                                <select id="reg-seller-cat" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500 font-medium text-gray-700">
                                    <option value="" disabled selected>Pilih Kategori Utama</option>
                                    <option value="Aneka Nasi">Aneka Nasi</option>
                                    <option value="Minuman">Minuman</option>
                                    <option value="Jajanan">Jajanan</option>
                                    <option value="Roti & Kue">Roti & Kue</option>
                                    <option value="Sate & BBQ">Sate & BBQ</option>
                                </select>
                            </div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Alamat Lengkap Usaha</label><textarea id="reg-seller-addr" rows="2" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500 font-medium resize-none" placeholder="Jalan, No, RT/RW, Kelurahan..."></textarea></div>
                        </div>
                    </div>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-100">
                    <button onclick="submitRegistration('Mitra Penjual')" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-orange-200 hover:bg-orange-700 active:scale-[0.98] transition flex justify-center items-center gap-2">
                        <i class="fas fa-paper-plane"></i> Kirim Pendaftaran
                    </button>
                </div>
            </div>
        </div>

        <!-- EDIT PROFILE -->
        <div id="edit-profile-modal" class="absolute inset-0 z-[90] hidden flex items-center justify-center bg-black/50 p-4">
            <div class="bg-white rounded-[2rem] w-full max-w-sm p-6 shadow-2xl">
                <h3 class="font-bold text-lg text-gray-800 mb-4">Edit Profil</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Nama Lengkap</label>
                        <input type="text" id="edit-name-input" class="w-full border border-gray-300 rounded-xl p-3 text-sm focus:outline-none focus:border-orange-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Nomor Telepon</label>
                        <input type="tel" id="edit-phone-input" class="w-full border border-gray-300 rounded-xl p-3 text-sm focus:outline-none focus:border-orange-500">
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button onclick="closeEditProfile()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl">Batal</button>
                        <button onclick="saveProfile()" class="flex-1 bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg">Simpan</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADDRESS MODAL -->
        <div id="address-modal" class="absolute inset-0 z-[85] hidden bg-gray-50 flex flex-col">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 z-10">
                <button onclick="closeAddressModal()" class="p-2 hover:bg-gray-100 rounded-full text-gray-700">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-lg font-bold text-gray-800">Alamat Tersimpan</h2>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 scrolling-wrapper optimized-list" id="address-list-container"></div>
            <div class="p-4 bg-white border-t border-gray-200">
                <button onclick="openAddAddressModal()" class="w-full bg-orange-600 text-white font-bold py-3 rounded-2xl shadow-lg flex items-center justify-center gap-2 active:scale-[0.98] transition">
                    <i class="fas fa-plus"></i> Tambah Alamat Baru
                </button>
            </div>
        </div>

        <!-- ADD ADDRESS SHEET -->
        <div id="add-address-modal" class="absolute inset-0 z-[90] hidden">
            <div class="absolute inset-0 bg-black/50" onclick="closeAddAddressModal()"></div>
            <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6 min-h-[50%] flex flex-col transition-transform duration-300 transform translate-y-full" id="add-address-content">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 cursor-grab" onclick="closeAddAddressModal()"></div>
                <h3 class="font-bold text-xl text-gray-800 mb-6">Tambah Alamat Baru</h3>
                <div class="space-y-5 mb-6 flex-1 overflow-y-auto hide-scrollbar">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Label Alamat</label>
                        <div class="flex gap-2">
                            <button onclick="setAddressLabel('Rumah')" class="addr-label-btn flex-1 py-3 border border-orange-500 bg-orange-50 text-orange-600 rounded-2xl text-sm font-bold transition">Rumah</button>
                            <button onclick="setAddressLabel('Kantor')" class="addr-label-btn flex-1 py-3 border border-gray-200 text-gray-600 rounded-2xl text-sm font-bold hover:bg-gray-50 transition">Kantor</button>
                            <button onclick="setAddressLabel('Lainnya')" class="addr-label-btn flex-1 py-3 border border-gray-200 text-gray-600 rounded-2xl text-sm font-bold hover:bg-gray-50 transition">Lainnya</button>
                        </div>
                        <input type="hidden" id="new-addr-label" value="Rumah">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Alamat Lengkap</label>
                        <div class="relative">
                            <i class="fas fa-map-marker-alt absolute left-3 top-3.5 text-gray-400"></i>
                            <textarea id="new-addr-detail" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-2xl py-3 pl-10 pr-4 text-sm focus:outline-none focus:border-orange-500 focus:bg-white transition resize-none text-gray-800 font-medium" placeholder="Jalan, Nomor Rumah, RT/RW..."></textarea>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Catatan Kurir (Opsional)</label>
                        <div class="relative">
                            <i class="fas fa-pen absolute left-3 top-3.5 text-gray-400"></i>
                            <input type="text" id="new-addr-note" class="w-full bg-gray-50 border border-gray-200 rounded-2xl py-3 pl-10 pr-4 text-sm focus:outline-none focus:border-orange-500 focus:bg-white transition text-gray-800 font-medium" placeholder="Pagar hitam, dekat warung...">
                        </div>
                    </div>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-100">
                    <button onclick="saveNewAddress()" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-orange-200 hover:bg-orange-700 active:scale-[0.98] transition flex justify-center items-center gap-2">
                        <i class="fas fa-check"></i> Simpan Alamat
                    </button>
                </div>
            </div>
        </div>

        <!-- PARTNERSHIP MODAL -->
        <div id="partnership-modal" class="absolute inset-0 z-[95] hidden flex items-end justify-center bg-black/50" onclick="closePartnershipModal()">
            <div class="bg-white w-full rounded-t-[2.5rem] p-6 pb-10" onclick="event.stopPropagation()">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-6"></div>
                <h3 class="font-bold text-xl text-gray-800 mb-4">Menu Mitra</h3>
                <div class="space-y-3">
                    <div onclick="openSellerRegistration()" class="bg-green-50 p-4 rounded-2xl flex items-center gap-4 hover:bg-green-100 transition border border-green-100 cursor-pointer">
                        <div class="bg-green-500 text-white w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-user-plus"></i></div>
                        <div><h4 class="font-bold text-gray-800">Daftar Mitra Baru</h4><p class="text-xs text-gray-600">Gabung jadi penjual/rider sekarang</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VARIANT MODAL (LARGE IMAGE FIX) -->
        <div id="variant-modal" class="absolute inset-0 z-[80] hidden flex items-center justify-center bg-black/60 p-4 transition-opacity duration-200">
            <div class="bg-white rounded-[2rem] w-full max-w-sm overflow-hidden shadow-2xl flex flex-col max-h-[85vh]">
                <!-- Gambar Besar Penuh -->
                <div class="relative h-72 shrink-0 bg-gray-200">
                    <img id="variant-modal-img" src="" class="w-full h-full object-cover transition-opacity duration-300" loading="lazy" decoding="async">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                    <button onclick="closeVariantModal()" class="absolute top-4 right-4 w-9 h-9 bg-black/30 rounded-full flex items-center justify-center text-white hover:bg-black/50 transition">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="absolute bottom-4 left-4 right-4">
                        <h3 id="variant-modal-title" class="font-bold text-xl text-white leading-tight shadow-black drop-shadow-md">Nama Produk</h3>
                        <p id="variant-modal-vendor" class="text-xs text-gray-200 mt-1">Nama Toko</p>
                    </div>
                </div>
                
                <!-- Content Scrollable -->
                <div class="p-5 overflow-y-auto flex-1">
                    <div class="flex justify-between items-center mb-4">
                        <p id="variant-modal-price" class="text-orange-600 font-black text-2xl">Rp 0</p>
                        <div class="flex items-center gap-1 text-yellow-500 text-xs font-bold">
                            <i class="fas fa-star"></i> <span>4.8</span>
                        </div>
                    </div>
                    
                    <p id="variant-modal-desc" class="text-xs text-gray-600 leading-relaxed mb-5">Deskripsi produk akan muncul di sini.</p>

                    <div id="variant-options-wrapper" class="mb-6 hidden">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Pilih Varian</p>
                        <div id="variant-options-container" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Footer Action -->
                <div class="p-4 border-t border-gray-100 bg-gray-50">
                    <button id="btn-add-variant" onclick="confirmVariantAdd()" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2">
                        <span>Tambah Pesanan</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <nav class="bg-white border-t border-gray-100 flex justify-around items-center px-2 py-3 pb-6 shrink-0 z-[60] absolute bottom-0 left-0 right-0 w-full rounded-t-[2rem] shadow-[0_-5px_15px_rgba(0,0,0,0.03)]" style="contain: layout size;">
            <button onclick="navTo('home-page')" class="nav-item active flex flex-col items-center gap-1 text-gray-400 w-16 active:scale-90 transition" id="nav-home">
                <i class="fas fa-utensils text-xl"></i><span class="text-[10px] font-medium">Beranda</span>
            </button>
            
            <button onclick="navTo('points-page')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16 active:scale-90 transition" id="nav-points">
                <i class="fas fa-star text-xl"></i><span class="text-[10px] font-medium">Poin</span>
            </button>
            
            <div class="relative -top-6">
                <!-- MODIFIED: Open Full Page Cart -->
                <button onclick="navTo('cart-page'); renderCartPage()" class="bg-orange-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-orange-300 active:scale-95 transition relative z-40">
                    <i class="fas fa-shopping-basket text-xl"></i>
                    <span id="cart-badge-nav" class="absolute top-0 right-0 bg-red-500 border-2 border-white text-white text-[9px] w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
                </button>
            </div>
            <button onclick="navTo('orders-page')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16 active:scale-90 transition" id="nav-orders">
                <i class="fas fa-receipt text-xl"></i><span class="text-[10px] font-medium">Pesanan</span>
            </button>
            <button onclick="navTo('profile-page')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16 active:scale-90 transition" id="nav-profile">
                <i class="fas fa-user text-xl"></i><span class="text-[10px] font-medium">Profil</span>
            </button>
        </nav>
    </div>

    <!-- Scripts ditempatkan di paling bawah body untuk performa -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbw65jWYm1cmPsXPM22Hsi9LH0FrY2AiIPNHE-16uvhEaVsx-KrgZ8KWw0K0cpAVA5Sj/exec"; 
        
        let map, marker;
        let selectedLat, selectedLng;
        let cart = [];
        let orderHistory = JSON.parse(localStorage.getItem('pg_orders')) || [];
        let productsData = [];
        let vendorsData = [];
        let userRegionPref = localStorage.getItem('pg_region_pref') || null;
        let mapLocationMode = 'header';
        let favorites = new Set(JSON.parse(localStorage.getItem('pg_favorites')) || []);
        
        let userProfile = {
            name: "User ProjekGo",
            phone: "+62 812-3456-7890",
            avatar: "https://ui-avatars.com/api/?name=User+ProjekGo&background=random"
        };
        let savedAddresses = [
            { id: 1, label: "Rumah", detail: "Jl. Melati No. 10, RT 01/02, Jakarta Selatan" },
            { id: 2, label: "Kantor", detail: "Gedung Cyber Lt. 2, Kuningan, Jakarta Selatan" }
        ];

        let userPoints = parseInt(localStorage.getItem('pg_points')) || 0;
        let claimedCodes = JSON.parse(localStorage.getItem('pg_claimed_codes')) || [];
        
        const VALID_POINT_CODES = ['PROJEKGO', 'MAKANENAK', 'SENIN', 'JUMATBERKAH', 'TEST1234'];
        const COORDS_GOMBONG = [-7.607865, 109.513824];
        const COORDS_KEBUMEN = [-7.6797, 109.6644];

        // --- DEBOUNCE SEARCH ---
        let searchTimeout;
        function debouncedSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                handleGlobalSearch(query);
            }, 300); 
        }

        // --- SEARCH LOGIC ---
        function handleGlobalSearch(query) {
            const container = document.getElementById('search-results');
            if(!query) {
                container.innerHTML = `<div class="text-center mt-10 text-gray-400"><i class="fas fa-search text-3xl mb-2"></i><p class="text-xs">Ketik untuk mencari...</p></div>`;
                return;
            }
            
            const lowerQ = query.toLowerCase();
            const results = productsData.filter(p => 
                p.Name.toLowerCase().includes(lowerQ) || 
                p.Vendor_Name.toLowerCase().includes(lowerQ)
            );

            if(results.length === 0) {
                container.innerHTML = `<div class="text-center mt-10 text-gray-400"><p class="text-xs">Tidak ditemukan.</p></div>`;
            } else {
                renderProductGrid(results, container);
            }
        }

        window.addEventListener('load', () => {
            fetchData();
            if(!userRegionPref) {
                setTimeout(() => {
                    document.getElementById('region-choice-modal').classList.remove('hidden');
                }, 1000);
            } else {
                document.getElementById('header-address-text').innerText = userRegionPref;
            }
            updateProfileUI(); 
            updatePointsUI();
            renderOrderHistory();
        });

        function selectRegion(region) {
            userRegionPref = region === 'Kebumen' ? 'Kebumen Kota' : 'Gombong';
            localStorage.setItem('pg_region_pref', userRegionPref);
            document.getElementById('header-address-text').innerText = userRegionPref;
            document.getElementById('region-choice-modal').classList.add('hidden');
        }

        async function fetchData() {
            const refreshBtn = document.getElementById('refreshIcon');
            if(refreshBtn) refreshBtn.classList.add('fa-spin');

            try {
                // --- KEMBALI KE LOGIKA AWAL: Ambil Kategori dari Sheet Categories ---
                const catRes = await fetch(`${API_URL}?action=getCategories`);
                const catJson = await catRes.json();
                if(catJson.status === 'success') {
                    renderCategories(catJson.data);
                }

                const prodRes = await fetch(`${API_URL}?action=getProducts`);
                const prodJson = await prodRes.json();
                if(prodJson.status === 'success') {
                    productsData = prodJson.data; 
                    renderProductLists();
                }

                const vendRes = await fetch(`${API_URL}?action=getVendors`);
                const vendJson = await vendRes.json();
                if(vendJson.status === 'success') {
                    vendorsData = vendJson.data;
                    renderVendorList(vendorsData);
                }

            } catch (error) {
                console.error("Gagal memuat data:", error);
            } finally {
                if(refreshBtn) refreshBtn.classList.remove('fa-spin');
            }
        }

        function openLocationModal(mode = 'header') {
            mapLocationMode = mode;
            const modal = document.getElementById('location-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            let initialCoords = COORDS_GOMBONG; 
            if (userRegionPref === 'Kebumen Kota') {
                initialCoords = COORDS_KEBUMEN;
            }

            if (mode === 'checkout') {
                const existingLat = document.getElementById('checkout-lat').value;
                const existingLng = document.getElementById('checkout-lng').value;
                if(existingLat && existingLng) {
                    initialCoords = [parseFloat(existingLat), parseFloat(existingLng)];
                }
            }

            setTimeout(() => {
                if (!map) {
                    map = L.map('map', { zoomControl: false }).setView(initialCoords, 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
                    map.on('moveend', function() {
                        const center = map.getCenter();
                        updateSelectedLocation(center.lat, center.lng);
                    });
                } else {
                    map.setView(initialCoords, 15);
                }
                updateSelectedLocation(initialCoords[0], initialCoords[1]);
                map.invalidateSize();
            }, 300);
        }

        function closeLocationModal() {
            document.getElementById('location-modal').classList.add('hidden');
            document.getElementById('location-modal').classList.remove('flex');
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 17);
                    updateSelectedLocation(lat, lng);
                }, () => {
                    alert('Gagal mendapatkan lokasi. Pastikan GPS aktif.');
                });
            }
        }

        async function updateSelectedLocation(lat, lng) {
            selectedLat = lat;
            selectedLng = lng;
            document.getElementById('selected-address').innerText = "Memuat alamat...";
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await res.json();
                const addr = data.address;
                const shortAddr = addr.village || addr.suburb || addr.town || addr.city_district || "Lokasi Terpilih";
                const city = addr.city || addr.county || "";
                
                let displayAddr = `${shortAddr}, ${city}`;
                if(displayAddr.length > 50) displayAddr = displayAddr.substring(0, 50) + "...";

                document.getElementById('selected-address').innerText = displayAddr;
            } catch (e) {
                document.getElementById('selected-address').innerText = "Gagal memuat nama jalan";
            }
        }

        function confirmLocation() {
            const addrText = document.getElementById('selected-address').innerText;
            if (mapLocationMode === 'header') {
                document.getElementById('header-address-text').innerText = addrText;
            } else if (mapLocationMode === 'checkout') {
                document.getElementById('checkout-address-text').innerText = addrText;
                document.getElementById('checkout-lat').value = selectedLat;
                document.getElementById('checkout-lng').value = selectedLng;
            }
            closeLocationModal();
        }

        function renderCategories(data) {
            const container = document.getElementById('categories-container');
            
            // Mapping Icon Manual untuk kategori spesifik
            const iconMap = {
                'Sarapan': 'https://img.icons8.com/color/48/breakfast.png',
                'per Nasi an': 'https://img.icons8.com/color/48/rice-bowl.png',
                'Minuman': 'https://img.icons8.com/color/48/orange-soda.png',
                'Ayam': 'https://img.icons8.com/color/48/fried-chicken.png',
                'Makanan kuah': 'https://img.icons8.com/color/48/soup-plate.png',
                'Aneka mie': 'https://img.icons8.com/color/48/noodles.png',
                'Makanan ringan': 'https://img.icons8.com/color/48/chips.png'
            };

            container.innerHTML = data.map(cat => {
                // Fallback icon jika di sheet kosong, cek mapping, lalu cek default
                let iconSrc = cat.Icon_Image_URL;
                if (!iconSrc || iconSrc.trim() === '') {
                    // Coba cari match di iconMap (case insensitive dikit)
                    const key = Object.keys(iconMap).find(k => k.toLowerCase() === cat.Name.toLowerCase());
                    iconSrc = key ? iconMap[key] : 'https://img.icons8.com/color/48/food.png';
                }

                // PENTING: Gunakan escape character untuk cat.Name di dalam onclick
                // Agar nama kategori dengan tanda kutip (misal "Jum'at Berkah") tidak error
                const safeName = cat.Name.replace(/'/g, "\\'");

                return `
                <div onclick="openCategory('${safeName}', '${safeName}')" class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition">
                    <div class="w-14 h-14 flex items-center justify-center bg-orange-50 rounded-2xl border border-orange-100 shadow-sm">
                        <img src="${iconSrc}" class="w-8 h-8 object-contain" onerror="this.src='https://img.icons8.com/color/48/food.png'" loading="lazy" decoding="async">
                    </div>
                    <span class="text-[10px] font-bold text-gray-600 text-center leading-tight px-1 truncate w-full mt-1">${cat.Name}</span>
                </div>
            `}).join('');
        }

        function renderProductLists() {
            const exclusiveContainer = document.getElementById('exclusive-slider');
            const recContainer = document.getElementById('recommendation-slider');
            const exclusive = productsData.filter(p => String(p.Is_Exclusive || p.Exclusive || 'false').toLowerCase() === 'true');
            const normal = productsData; 

            if(exclusive.length > 0) {
                exclusiveContainer.innerHTML = exclusive.map(p => createProductCard(p, 'horizontal')).join('');
            } else {
                exclusiveContainer.innerHTML = '<div class="text-xs text-gray-400 w-full text-center py-4">Belum ada promo.</div>';
            }

            if(normal.length > 0) {
                recContainer.innerHTML = normal.slice(0, 5).map(p => createProductCard(p, 'vertical')).join('');
            } else {
                recContainer.innerHTML = '<div class="text-xs text-gray-400 w-full text-center py-4">Belum ada data.</div>';
            }
        }

        function renderProductGrid(products, container) {
            if(!products || products.length === 0) { 
                container.innerHTML = '<div class="col-span-2 text-center text-gray-400 text-sm py-10">Tidak ada produk ditemukan.</div>'; 
                return; 
            }
            container.innerHTML = products.map(item => createProductCard(item, 'vertical')).join('');
        }

        function createProductCard(item, type) {
            const priceVal = parseFloat(item.Price);
            const originalPriceVal = parseFloat(item.Original_Price);
            const price = new Intl.NumberFormat('id-ID').format(priceVal);
            const oriPrice = new Intl.NumberFormat('id-ID').format(originalPriceVal);
            const imgUrl = item.Image_URL && item.Image_URL.startsWith('http') ? item.Image_URL : 'https://placehold.co/200?text=No+Img';
            const availability = item.Availability ? String(item.Availability) : '';
            const isHabis = availability.trim() === 'Habis';
            const clickAction = isHabis ? "" : `onclick='openProductModal(${JSON.stringify(item)})'`;
            const opacityClass = isHabis ? "opacity-60 grayscale cursor-not-allowed" : "cursor-pointer active:scale-[0.98]";
            const overlay = isHabis ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-xs text-white font-bold rounded-xl z-20">HABIS</div>' : '';
            const isHemat = originalPriceVal > priceVal;
            const hematAmount = isHemat ? (originalPriceVal - priceVal) : 0;
            const hematLabel = isHemat ? `<div class="absolute top-2 left-2 bg-red-600 text-white text-[9px] font-bold px-2 py-0.5 rounded-md z-10 shadow-sm border border-white">Hemat Rp${new Intl.NumberFormat('id-ID').format(hematAmount)}</div>` : '';
            
            const priorityBadge = `<span class="bg-blue-50 text-blue-600 text-[8px] font-bold px-1.5 py-0.5 rounded-full flex items-center gap-0.5 border border-blue-100 ml-auto whitespace-nowrap"><i class="fas fa-check-circle text-[7px]"></i> Prioritas</span>`;

            const isFav = favorites.has(String(item.ID));
            const favIcon = isFav ? '<i class="fas fa-heart text-red-500 text-xs"></i>' : '<i class="far fa-heart text-gray-400 text-xs"></i>';
            const favButton = `
                <button onclick="toggleFavorite(event, '${item.ID}')" class="absolute top-2 right-2 w-7 h-7 bg-white/90 rounded-full flex items-center justify-center shadow-sm z-20 active:scale-90 transition fav-btn-${item.ID}">
                    ${favIcon}
                </button>
            `;

            if (type === 'horizontal') {
                return `
                <div class="product-card min-w-[300px] bg-white rounded-2xl p-3 shadow-sm border border-gray-100 flex gap-3 snap-center ${opacityClass} relative overflow-hidden" ${clickAction}>
                    <div class="w-28 h-28 bg-gray-100 rounded-xl overflow-hidden shrink-0 relative">
                        <img src="${imgUrl}" class="w-full h-full object-cover" loading="lazy" decoding="async">
                        ${overlay} ${hematLabel}
                        ${!isHabis ? favButton : ''}
                    </div>
                    <div class="flex-1 flex flex-col justify-center min-w-0">
                        <div class="flex items-center gap-1 mb-1">
                            <i class="fas fa-store text-orange-500 text-[10px]"></i>
                            <span class="text-[10px] text-gray-600 truncate font-bold">${item.Vendor_Name}</span>
                            <i class="fas fa-check-circle text-blue-500 text-[8px]"></i>
                        </div>
                        <h4 class="font-bold text-gray-800 text-sm line-clamp-1">${item.Name}</h4>
                        <p class="text-[10px] text-gray-500 mb-2 line-clamp-2 h-8 leading-tight">${item.Description || 'Menu spesial pilihan.'}</p>
                        <div class="flex items-end justify-between mt-auto">
                            <div class="flex flex-col items-start">
                                ${isHemat ? `<span class="text-[9px] text-gray-400 line-through">Rp${oriPrice}</span>` : ''}
                                <span class="text-orange-600 font-bold text-base">Rp${price}</span>
                            </div>
                            <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 shadow-sm"><i class="fas fa-plus text-xs"></i></div>
                        </div>
                    </div>
                </div>`;
            } else {
                return `
                <div class="product-card min-w-[170px] w-full bg-white p-3 rounded-2xl shadow-sm border border-gray-100 snap-center flex flex-col ${opacityClass} relative h-full overflow-hidden" ${clickAction}>
                    <div class="w-full h-36 bg-gray-100 rounded-xl overflow-hidden mb-2 relative">
                        <img src="${imgUrl}" class="w-full h-full object-cover" loading="lazy" decoding="async">
                        ${overlay} ${hematLabel}
                        ${!isHabis ? favButton : ''}
                        ${!isHabis ? `<div class="absolute bottom-2 left-2 bg-white/90 px-1.5 rounded text-[9px] font-bold shadow-sm z-10"><i class="fas fa-star text-yellow-500 text-[8px]"></i> ${item.Rating || '4.5'}</div>` : ''}
                    </div>
                    
                    <div class="flex items-center gap-1 mb-1 w-full">
                        <i class="fas fa-store text-orange-500 text-[9px]"></i>
                        <span class="text-[9px] text-gray-600 font-bold truncate max-w-[70px]">${item.Vendor_Name}</span>
                        ${priorityBadge}
                    </div>

                    <h4 class="font-bold text-gray-800 text-xs line-clamp-2 mb-0.5 h-8">${item.Name}</h4>
                    <p class="text-[9px] text-gray-500 line-clamp-1 mb-2 h-4">${item.Description || ''}</p>
                    <div class="mt-auto flex justify-between items-end">
                        <div class="flex flex-col items-start">
                            ${isHemat ? `<span class="text-[9px] text-gray-400 line-through">Rp${oriPrice}</span>` : ''}
                            <span class="text-orange-600 font-bold text-sm">Rp${price}</span>
                        </div>
                        <div class="w-7 h-7 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 shadow-sm"><i class="fas fa-plus text-[10px]"></i></div>
                    </div>
                </div>`;
            }
        }

        function renderVendorList(vendors) {
            const container = document.getElementById('vendor-list');
            if(!vendors || vendors.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-xs py-8">Belum ada warung terdaftar.</div>';
                return;
            }
            const sorted = vendors.sort((a, b) => (a.Status === 'Buka' ? -1 : 1));

            container.innerHTML = sorted.map(v => {
                const distance = (Math.random() * 3 + 0.2).toFixed(1);
                const time = Math.floor(Math.random() * (25 - 10) + 10);
                const isPromo = Math.random() > 0.5;

                return `
                <div onclick="openVendor('${v.ID}')" class="product-card bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex items-start gap-3 cursor-pointer active:scale-[0.99] ${v.Status === 'Tutup' ? 'grayscale opacity-60' : ''}">
                    <div class="w-24 h-24 rounded-2xl bg-gray-100 overflow-hidden border border-gray-200 shrink-0 relative">
                        <img src="${v.Image_URL || 'https://placehold.co/100?text=W'}" class="w-full h-full object-cover" loading="lazy" decoding="async">
                        ${isPromo && v.Status === 'Buka' ? '<div class="absolute bottom-0 left-0 right-0 bg-red-600 text-white text-[8px] font-bold text-center py-0.5">DISKON 20%</div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0 py-1">
                        <div class="flex justify-between items-start mb-1">
                            <h4 class="font-bold text-gray-800 text-sm truncate pr-2">${v.Vendor_Name}</h4>
                            <span class="text-[9px] font-bold px-2 py-0.5 rounded-full whitespace-nowrap ${v.Status === 'Buka' ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-500'}">${v.Status}</span>
                        </div>
                        
                        <div class="flex items-center gap-1 mb-2">
                             <span class="bg-blue-50 text-blue-600 text-[9px] font-bold px-2 py-0.5 rounded-full border border-blue-100 flex items-center gap-1"><i class="fas fa-shield-alt text-[8px]"></i> Super Partner</span>
                        </div>

                        <p class="text-[10px] text-gray-500 line-clamp-1 mb-2">${v.Type || 'Aneka Makanan'} â€¢ Indonesia</p>
                        
                        <div class="flex items-center gap-3 border-t border-gray-50 pt-2 mt-auto">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-star text-yellow-400 text-[10px]"></i>
                                <span class="text-[10px] font-bold text-gray-700">${v.Rating || '4.8'}</span>
                            </div>
                            <div class="w-[1px] h-3 bg-gray-200"></div>
                            <div class="flex items-center gap-1">
                                <i class="fas fa-map-marker-alt text-gray-400 text-[10px]"></i>
                                <span class="text-[10px] text-gray-500 font-medium">${distance} km</span>
                            </div>
                             <div class="w-[1px] h-3 bg-gray-200"></div>
                            <div class="flex items-center gap-1">
                                <i class="fas fa-clock text-gray-400 text-[10px]"></i>
                                <span class="text-[10px] text-gray-500 font-medium">${time} mnt</span>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function openVendor(vendorId) {
            const vendor = vendorsData.find(v => String(v.ID) === String(vendorId));
            if (!vendor) return;
            document.getElementById('vendor-banner-img').src = vendor.Image_URL || "https://placehold.co/600x200?text=Resto";
            document.getElementById('vendor-name-title').innerText = vendor.Vendor_Name;
            document.getElementById('vendor-info-subtitle').innerText = `${vendor.Status} â€¢ ${vendor.Type || 'Umum'}`;
            document.getElementById('vendor-rating-badge').innerText = vendor.Rating || '4.5';
            const container = document.getElementById('vendor-menu-container');
            const vendorProducts = productsData.filter(p => p.Vendor_Name === vendor.Vendor_Name);
            renderProductGrid(vendorProducts, container);
            navTo('vendor-page');
        }

        function openProductModal(item) {
            const availability = item.Availability ? String(item.Availability) : '';
            if (availability.trim() === 'Habis') return; 
            if (typeof item === 'string') item = JSON.parse(item);
            currentItem = item;
            document.getElementById('variant-modal-img').src = item.Image_URL || 'https://placehold.co/400?text=No+Img';
            document.getElementById('variant-modal-title').innerText = item.Name;
            document.getElementById('variant-modal-vendor').innerText = item.Vendor_Name;
            document.getElementById('variant-modal-price').innerText = "Rp " + new Intl.NumberFormat('id-ID').format(item.Price);
            document.getElementById('variant-modal-desc').innerText = item.Description || "Tidak ada deskripsi.";
            const wrapper = document.getElementById('variant-options-wrapper');
            const container = document.getElementById('variant-options-container');
            if (item.Variants && item.Variants.trim() !== "") {
                wrapper.classList.remove('hidden');
                const vars = item.Variants.split(',').map(v => v.trim());
                container.innerHTML = vars.map((v, i) => `
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-200 cursor-pointer active:bg-orange-50">
                        <span class="text-sm font-medium text-gray-700">${v}</span>
                        <input type="radio" name="prod_var" value="${v}" class="accent-orange-600 w-4 h-4" ${i===0 ? 'checked' : ''}>
                    </label>
                `).join('');
            } else { wrapper.classList.add('hidden'); container.innerHTML = ''; }
            const modal = document.getElementById('variant-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        function closeVariantModal() {
            const modal = document.getElementById('variant-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
            currentItem = null;
        }

        function confirmVariantAdd() {
            if(!currentItem) return;
            let selectedVariant = null;
            const radios = document.getElementsByName('prod_var');
            if (radios.length > 0) {
                for (const r of radios) { if (r.checked) { selectedVariant = r.value; break; } }
            }
            addToCart(currentItem, selectedVariant);
            closeVariantModal();
        }

        function addToCart(item, variant) {
            const cartId = item.ID + (variant ? '-' + variant : '');
            const existing = cart.find(c => c.cartId === cartId);
            if (existing) { existing.qty++; } 
            else { cart.push({ ...item, cartId: cartId, variant: variant || '', qty: 1 }); }
            updateCartBadge();
            const btn = document.getElementById('btn-add-variant');
            btn.innerHTML = '<i class="fas fa-check"></i> Masuk Keranjang';
            btn.classList.add('bg-green-600');
            setTimeout(() => { btn.innerHTML = '<span>Tambah Pesanan</span>'; btn.classList.remove('bg-green-600'); }, 1000);
        }

        function updateCartBadge() {
            const count = cart.reduce((sum, i) => sum + i.qty, 0);
            const badge = document.getElementById('cart-badge-nav');
            if(count > 0) { badge.innerText = count; badge.classList.remove('hidden'); } 
            else { badge.classList.add('hidden'); }
        }

        function renderCartPage() {
            const container = document.getElementById('cart-items-container');
            const form = document.getElementById('checkout-form-container');
            const summaryArea = document.getElementById('cart-summary-area');

            if(cart.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-gray-400"><i class="fas fa-shopping-basket text-4xl mb-3 text-gray-300"></i><p>Keranjang kosong</p></div>`;
                form.classList.add('hidden');
            } else {
                form.classList.remove('hidden');
                let total = 0;
                let totalOriginal = 0;
                
                const grouped = {};
                cart.forEach(item => {
                    if(!grouped[item.Vendor_Name]) grouped[item.Vendor_Name] = [];
                    grouped[item.Vendor_Name].push(item);
                    
                    const priceVal = parseFloat(item.Price);
                    const originalPriceVal = parseFloat(item.Original_Price);
                    const itemOriginalPrice = (!isNaN(originalPriceVal) && originalPriceVal > priceVal) ? originalPriceVal : priceVal;

                    total += (priceVal * item.qty);
                    totalOriginal += (itemOriginalPrice * item.qty);
                });

                let html = '';
                if(Object.keys(grouped).length > 1) {
                    html += `<div class="bg-yellow-50 border border-yellow-200 p-3 rounded-2xl mb-3 flex items-start gap-2"><i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5 text-xs"></i><p class="text-[11px] text-yellow-700 leading-tight">Pesan lebih dari 1 penjual, ada tambahan sedikit ongkir.</p></div>`;
                }

                for(const [vendor, items] of Object.entries(grouped)) {
                    html += `<div class="bg-white rounded-2xl p-4 border border-gray-100 mb-3 shadow-sm"><div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-100"><i class="fas fa-store text-orange-600 text-sm"></i><h4 class="font-bold text-sm text-gray-800">${vendor}</h4></div>`;
                    items.forEach(item => {
                         const priceVal = parseFloat(item.Price);
                         const originalPriceVal = parseFloat(item.Original_Price);
                         const isHemat = originalPriceVal > priceVal;

                        html += `
                        <div class="flex justify-between items-start mb-3 last:mb-0">
                            <div class="flex gap-3 items-center flex-1">
                                <div class="w-12 h-12 rounded-xl bg-gray-200 overflow-hidden shrink-0"><img src="${item.Image_URL}" class="w-full h-full object-cover" loading="lazy" decoding="async"></div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-bold text-gray-800 line-clamp-1">${item.Name}</p>
                                    ${item.variant ? `<p class="text-[10px] text-gray-500 mb-1">Varian: ${item.variant}</p>` : ''}
                                    <div class="flex gap-2 items-center">
                                        <div class="flex flex-col items-start">
                                            ${isHemat ? `<span class="text-[9px] text-gray-400 line-through">${formatRupiah(originalPriceVal)}</span>` : ''}
                                            <span class="text-xs text-orange-600 font-bold">${formatRupiah(priceVal)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 bg-gray-50 rounded-lg px-2 py-1 border border-gray-200">
                                <button onclick="updateQty('${item.cartId}', -1)" class="text-gray-500 font-bold w-4 text-center">-</button>
                                <span class="text-xs font-bold w-4 text-center">${item.qty}</span>
                                <button onclick="updateQty('${item.cartId}', 1)" class="text-green-600 font-bold w-4 text-center">+</button>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                }
                container.innerHTML = html;
                
                const savings = totalOriginal - total;
                const summaryHtml = `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded">PROJEKGO tidak markup harga</span>
                            <span class="text-xs text-gray-400 line-through">${formatRupiah(totalOriginal)}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-600 font-medium">
                            <span>Biaya Aplikasi</span>
                            <div class="flex items-center gap-1"><span class="text-[9px] bg-green-100 text-green-600 px-1.5 py-0.5 rounded font-bold">Gratis</span> <span>Rp 0</span></div>
                        </div>
                        <div class="border-t border-dashed border-gray-200 my-2"></div>
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-gray-800 text-sm">Total harga makanan</span>
                            <div class="text-right">
                                <span class="text-[10px] bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded font-bold border border-orange-100 mb-1 inline-block">Harga Asli</span>
                                <span class="block text-xl font-black text-orange-600">${formatRupiah(total)}</span>
                            </div>
                        </div>
                        ${savings > 0 ? `<div class="flex justify-end"><span class="text-[10px] bg-red-50 text-red-600 px-2 py-1 rounded-lg font-bold">Anda lebih hemat ${formatRupiah(savings)}</span></div>` : ''}
                        
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 mt-2">
                             <p class="text-[10px] text-blue-800 leading-tight">
                                <i class="fas fa-info-circle mr-1"></i> Setelah pesanan diantar, minta <b>Kode Poin</b> ke admin/kurir untuk menambah poinmu.
                             </p>
                        </div>

                        <button onclick="checkoutToWA()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all active:scale-[0.98] mt-2">
                            <i class="fab fa-whatsapp text-xl"></i> Pesan via WhatsApp
                        </button>
                    </div>
                `;
                summaryArea.innerHTML = summaryHtml;
            }
        }

        function openCart() {
             navTo('cart-page');
             renderCartPage();
        }

        function updateQty(id, delta) {
            const idx = cart.findIndex(c => c.cartId === id);
            if(idx !== -1) {
                cart[idx].qty += delta;
                if(cart[idx].qty <= 0) cart.splice(idx, 1);
                updateCartBadge();
                renderCartPage();
            }
        }

        function checkoutToWA() {
            if(cart.length === 0) return;
            
            const addressText = document.getElementById('checkout-address-text').innerText;
            const noteText = document.getElementById('checkout-note').value;
            const lat = document.getElementById('checkout-lat').value;
            const lng = document.getElementById('checkout-lng').value;
            
            if(addressText.includes("Klik untuk atur") || !lat) { 
                alert("Mohon pin titik lokasi pengantaran di peta terlebih dahulu!"); 
                return; 
            }

            const phone = "6281292802623";
            let msg = `Halo Admin, saya mau pesan:\n\n`;
            let grandTotal = 0;
            const grouped = {};
            
            cart.forEach(item => {
                if(!grouped[item.Vendor_Name]) grouped[item.Vendor_Name] = [];
                grouped[item.Vendor_Name].push(item);
                grandTotal += (item.Price * item.qty);
            });

            for(const [vendor, items] of Object.entries(grouped)) {
                msg += `*ðŸª ${vendor}*\n`;
                items.forEach(i => {
                    msg += `- ${i.qty}x ${i.Name} ${i.variant ? `(${i.variant})` : ''} @ ${i.Price/1000}k\n`;
                });
                msg += `\n`;
            }

            msg += `ðŸ’° *Total Makanan: Rp ${new Intl.NumberFormat('id-ID').format(grandTotal)}*\n`;
            const fullAddress = noteText ? `${addressText} (Detail: ${noteText})` : addressText;
            msg += `ðŸ“ *Lokasi:* ${fullAddress}\n`;
            
            if(lat && lng) {
                msg += `ðŸ”— *Maps:* https://www.google.com/maps?q=${lat},${lng}\n\n`;
            } else {
                msg += `\n`;
            }

            msg += `Mohon info ongkirnya kak.`;

            // UPDATE 1: Status pesanan diubah
            const newOrder = {
                id: `ORD-${Date.now()}`,
                date: new Date().toLocaleDateString('id-ID'),
                total: grandTotal,
                status: 'Terkirim ke Admin', // Status baru
                items: cart.length
            };
            orderHistory.unshift(newOrder);
            localStorage.setItem('pg_orders', JSON.stringify(orderHistory));
            renderOrderHistory();

            cart = [];
            updateCartBadge();
            renderCartPage();

            // UPDATE 2: Menggunakan format wa.me dan window.location.href
            // untuk kompatibilitas mobile yang lebih baik
            const waUrl = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            
            // Mencoba redirect langsung (biasanya lebih aman dari popup blocker)
            window.location.href = waUrl;
        }

        function updatePointsUI() {
            document.getElementById('point-display-count').innerText = userPoints;
            const percentage = Math.min((userPoints / 10) * 100, 100);
            document.getElementById('point-progress-bar').style.width = `${percentage}%`;
            
            const btn = document.getElementById('btn-redeem-point');
            if(userPoints >= 10) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-orange-600', 'text-white', 'shadow-lg');
                btn.innerText = "Tukar Sekarang!";
                document.getElementById('point-target-text').innerText = "Siap Ditukar!";
            } else {
                btn.disabled = true;
                btn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                btn.classList.remove('bg-orange-600', 'text-white', 'shadow-lg');
                btn.innerText = `Kurang ${10 - userPoints} Poin lagi`;
                document.getElementById('point-target-text').innerText = `Target: 10 Poin`;
            }
        }

        function claimPointCode() {
            const input = document.getElementById('claim-code-input');
            const code = input.value.trim().toUpperCase();
            if(!code) return;

            if(VALID_POINT_CODES.includes(code)) {
                if(claimedCodes.includes(code)) {
                    alert("Kode ini sudah pernah kamu gunakan!");
                } else {
                    userPoints += 1;
                    claimedCodes.push(code);
                    localStorage.setItem('pg_points', userPoints);
                    localStorage.setItem('pg_claimed_codes', JSON.stringify(claimedCodes));
                    updatePointsUI();
                    alert("Selamat! Poin berhasil ditambahkan.");
                    input.value = "";
                }
            } else {
                alert("Kode Voucher tidak valid. Pastikan kode benar dari admin.");
            }
        }

        function redeemPoints() {
            if(userPoints >= 10) {
                if(confirm("Tukarkan 10 Poin dengan Gratis Ongkir?")) {
                    userPoints -= 10;
                    localStorage.setItem('pg_points', userPoints);
                    updatePointsUI();
                    alert("Berhasil! Tunjukkan screenshot ini ke admin saat memesan untuk klaim gratis ongkir.");
                }
            }
        }
        
        function renderOrderHistory() {
            const container = document.getElementById('order-history-container');
            if(orderHistory.length === 0) return;

            container.innerHTML = orderHistory.map(o => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-3 flex justify-between items-center">
                    <div>
                        <p class="text-xs text-gray-400 mb-1">${o.date} â€¢ ${o.id}</p>
                        <h4 class="font-bold text-gray-800 text-sm">${o.items} Item Makanan</h4>
                        <p class="text-orange-600 font-bold text-xs mt-1">Rp ${new Intl.NumberFormat('id-ID').format(o.total)}</p>
                    </div>
                    <div>
                        <span class="text-[10px] px-2 py-1 rounded bg-yellow-100 text-yellow-700 font-bold">${o.status}</span>
                    </div>
                </div>
            `).join('');
        }

        function openPartnershipModal() { document.getElementById('partnership-modal').classList.remove('hidden'); }
        function closePartnershipModal() { document.getElementById('partnership-modal').classList.add('hidden'); }
        function openSellerRegistration() { closePartnershipModal(); document.getElementById('seller-register-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('seller-register-content').classList.remove('translate-y-full'), 10); }
        function closeSellerRegistration() { document.getElementById('seller-register-content').classList.add('translate-y-full'); setTimeout(() => document.getElementById('seller-register-modal').classList.add('hidden'), 300); }
        function openRiderRegistration() { closePartnershipModal(); document.getElementById('rider-info-modal').classList.remove('hidden'); }
        function closeRiderInfo() { document.getElementById('rider-info-modal').classList.add('hidden'); }
        
        function updateProfileUI() { document.getElementById('profile-name-text').innerText = userProfile.name; document.getElementById('profile-phone-text').innerText = userProfile.phone; document.getElementById('profile-avatar-img').src = userProfile.avatar; }
        function openEditProfile() { document.getElementById('edit-name-input').value = userProfile.name; document.getElementById('edit-phone-input').value = userProfile.phone; document.getElementById('edit-profile-modal').classList.remove('hidden'); }
        function closeEditProfile() { document.getElementById('edit-profile-modal').classList.add('hidden'); }
        function saveProfile() { const newName = document.getElementById('edit-name-input').value; const newPhone = document.getElementById('edit-phone-input').value; if (newName && newPhone) { userProfile.name = newName; userProfile.phone = newPhone; userProfile.avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(newName)}&background=random`; updateProfileUI(); closeEditProfile(); } }
        
        function toggleFavorite(event, id) { 
            event.stopPropagation(); 
            id = String(id);
            const buttons = document.querySelectorAll(`.fav-btn-${id}`); 
            
            if (favorites.has(id)) { 
                favorites.delete(id); 
                buttons.forEach(btn => {
                    btn.innerHTML = `<i class="far fa-heart text-gray-400 text-xs"></i>`; 
                });
            } else { 
                favorites.add(id); 
                buttons.forEach(btn => {
                    btn.innerHTML = `<i class="fas fa-heart text-red-500 text-xs liked-anim"></i>`; 
                });
            } 
            localStorage.setItem('pg_favorites', JSON.stringify([...favorites]));
        }
        
        function openFavoritesPage(navigate = true) { if (navigate) navTo('category-page'); document.getElementById('cat-page-title').innerText = 'Makanan Favorit'; const container = document.getElementById('category-content-container'); const favProducts = productsData.filter(p => favorites.has(String(p.ID))); if (favProducts.length === 0) { container.innerHTML = '<div class="col-span-2 text-center text-gray-400 mt-10"><i class="far fa-heart text-4xl mb-2"></i><p>Belum ada makanan favorit.</p></div>'; } else { renderProductGrid(favProducts, container); } }
        function openAddressModal() { renderAddressList(); document.getElementById('address-modal').classList.remove('hidden'); }
        function closeAddressModal() { document.getElementById('address-modal').classList.add('hidden'); }
        function renderAddressList() { const container = document.getElementById('address-list-container'); container.innerHTML = savedAddresses.map(addr => `<div class="bg-white p-3 rounded-2xl border border-gray-200 flex justify-between items-center cursor-pointer hover:border-orange-500 group" onclick="selectAddress('${addr.detail}')"><div><span class="text-xs font-bold bg-gray-100 text-gray-600 px-2 py-0.5 rounded mb-1 inline-block">${addr.label}</span><p class="text-sm text-gray-800 leading-tight">${addr.detail}</p></div><button onclick="event.stopPropagation(); deleteAddress(${addr.id})" class="text-gray-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button></div>`).join(''); }
        function deleteAddress(id) { if (confirm('Hapus alamat ini?')) { savedAddresses = savedAddresses.filter(a => a.id !== id); renderAddressList(); } }
        function openAddAddressModal() { const modal = document.getElementById('add-address-modal'); const content = document.getElementById('add-address-content'); document.getElementById('new-addr-detail').value = ''; document.getElementById('new-addr-note').value = ''; setAddressLabel('Rumah'); modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('translate-y-full'); }, 10); }
        function closeAddAddressModal() { const modal = document.getElementById('add-address-modal'); const content = document.getElementById('add-address-content'); content.classList.add('translate-y-full'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }
        function setAddressLabel(label) { document.getElementById('new-addr-label').value = label; document.querySelectorAll('.addr-label-btn').forEach(btn => { if(btn.innerText === label) { btn.classList.add('border-orange-500', 'bg-orange-50', 'text-orange-600'); btn.classList.remove('border-gray-200', 'text-gray-600'); } else { btn.classList.remove('border-orange-500', 'bg-orange-50', 'text-orange-600'); btn.classList.add('border-gray-200', 'text-gray-600'); } }); }
        function saveNewAddress() { const label = document.getElementById('new-addr-label').value; const detail = document.getElementById('new-addr-detail').value; const note = document.getElementById('new-addr-note').value; if (!detail) { const input = document.getElementById('new-addr-detail'); input.classList.add('border-red-500', 'animate-pulse'); setTimeout(() => input.classList.remove('border-red-500', 'animate-pulse'), 1000); return; } const finalDetail = note ? `${detail} (${note})` : detail; savedAddresses.push({ id: Date.now(), label: label || "Alamat", detail: finalDetail }); renderAddressList(); closeAddAddressModal(); const toast = document.createElement('div'); toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs font-bold py-2 px-4 rounded-full shadow-lg z-[95] animate-bounce flex items-center'; toast.innerHTML = `<i class="fas fa-check-circle mr-2 text-green-400"></i> Alamat Berhasil Disimpan`; document.body.appendChild(toast); setTimeout(() => toast.remove(), 2000); }
        function selectAddress(detail) { document.getElementById('header-address-text').innerText = detail; closeAddressModal(); }
        function formatRupiah(number) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumSignificantDigits: 3 }).format(number); }

        function navTo(pageId) {
            document.querySelectorAll('.page-section').forEach(el => {
                if(el.id !== pageId) {
                    el.classList.add('hidden-page');
                    el.classList.remove('z-30');
                }
            });
            const target = document.getElementById(pageId);
            if(target) {
                target.classList.remove('hidden-page');
                target.classList.add('z-30');
                
                const scroller = target.querySelector('.scrolling-wrapper');
                if (scroller) scroller.scrollTop = 0;
            }

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active');
                el.querySelector('i').classList.replace('text-orange-600', 'text-gray-400');
                el.querySelector('span').classList.remove('font-bold', 'text-orange-600');
            });
            let activeNav;
            if(pageId === 'home-page') activeNav = document.getElementById('nav-home');
            else if(pageId === 'points-page') activeNav = document.getElementById('nav-points');
            else if(pageId === 'orders-page') activeNav = document.getElementById('nav-orders');
            else if(pageId === 'profile-page') activeNav = document.getElementById('nav-profile');
            
            if(activeNav) {
                activeNav.classList.add('active');
                activeNav.querySelector('i').classList.replace('text-orange-600', 'text-orange-600'); 
                activeNav.querySelector('span').classList.add('font-bold', 'text-orange-600');
            }
        }
        
        function handleBack() {
            navTo('home-page');
        }

        function openExclusivePage() {
            navTo('exclusive-page');
            const container = document.getElementById('exclusive-content-container');
            container.innerHTML = '<div class="col-span-2 text-center py-10"><i class="fas fa-spinner fa-spin text-orange-500"></i> Memuat...</div>';
            setTimeout(() => {
                const exclusiveProducts = productsData.filter(p => String(p.Is_Exclusive || p.Exclusive || 'false').toLowerCase() === 'true');
                if (exclusiveProducts.length === 0) { 
                    container.innerHTML = '<div class="col-span-2 text-center text-gray-400 mt-10">Belum ada menu eksklusif saat ini.</div>'; 
                    return; 
                }
                renderProductGrid(exclusiveProducts, container);
            }, 300);
        }

        function openCategory(catId, catName) { 
            navTo('category-page'); 
            document.getElementById('cat-page-title').innerText = catName; 
            const container = document.getElementById('category-content-container'); 
            
            // Show loading state
            container.innerHTML = '<div class="col-span-2 text-center py-10"><i class="fas fa-spinner fa-spin text-orange-500"></i> Memuat...</div>'; 
            
            setTimeout(() => { 
                // FILTER LOGIC:
                // 1. Source: productsData (from Sheet Products)
                // 2. Filter Column: Category (p.Category)
                // 3. Condition: Match the clicked category name (catId)
                
                const filtered = catId === 'all' ? productsData : productsData.filter(p => {
                    // Normalize data from sheet (handle different casing/trimming)
                    // UPDATE: Added 'Kategori' and 'kategori' for flexibility
                    const pCat = p.Category || p.category || p.Kategori || p.kategori || ''; 
                    
                    // Compare case-insensitively
                    return String(pCat).trim().toLowerCase() === String(catId).trim().toLowerCase();
                });
                
                if (filtered.length === 0) { 
                    // Debugging hint in UI (optional, kept simple)
                    container.innerHTML = '<div class="col-span-2 text-center text-gray-400 mt-10">Belum ada menu di kategori ini.<br><span class="text-[8px]">Pastikan penulisan kategori di Sheet Produk sama persis.</span></div>'; 
                    return; 
                } 
                
                renderProductGrid(filtered, container); 
            }, 300); 
        }

        function submitRegistration(type) {
            let payload = { action: 'register', type: type };
            if (type === 'Mitra Penjual') {
                const name = document.getElementById('reg-seller-name').value;
                const phone = document.getElementById('reg-seller-phone').value;
                const bizName = document.getElementById('reg-seller-biz').value;
                const category = document.getElementById('reg-seller-cat').value;
                const address = document.getElementById('reg-seller-addr').value;
                if (!name || !bizName) { alert("Harap isi semua data wajib!"); return; }
                payload.name = name; payload.phone = phone; payload.bizName = bizName; payload.category = category; payload.address = address;
            }
            const modalId = 'seller-register-modal';
            const contentId = 'seller-register-content';
            document.getElementById(contentId).classList.add('translate-y-full');
            setTimeout(() => document.getElementById(modalId).classList.add('hidden'), 300);
            
            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(response => { alert(`Pendaftaran ${type} Berhasil dikirim!`); })
            .catch(error => { console.error("Error:", error); alert("Gagal Mengirim (Cek Koneksi)"); });
        }

        function renderCategories(data) {
            const container = document.getElementById('categories-container');
            
            // Mapping Icon Manual untuk kategori spesifik
            const iconMap = {
                'Sarapan': 'https://img.icons8.com/color/48/breakfast.png',
                'per Nasi an': 'https://img.icons8.com/color/48/rice-bowl.png',
                'Minuman': 'https://img.icons8.com/color/48/orange-soda.png',
                'Ayam': 'https://img.icons8.com/color/48/fried-chicken.png',
                'Makanan kuah': 'https://img.icons8.com/color/48/soup-plate.png',
                'Aneka mie': 'https://img.icons8.com/color/48/noodles.png',
                'Makanan ringan': 'https://img.icons8.com/color/48/chips.png'
            };

            container.innerHTML = data.map(cat => {
                // Fallback icon jika di sheet kosong, cek mapping, lalu cek default
                let iconSrc = cat.Icon_Image_URL;
                if (!iconSrc || iconSrc.trim() === '') {
                    // Coba cari match di iconMap (case insensitive dikit)
                    const key = Object.keys(iconMap).find(k => k.toLowerCase() === cat.Name.toLowerCase());
                    iconSrc = key ? iconMap[key] : 'https://img.icons8.com/color/48/food.png';
                }

                // PENTING: Gunakan cat.Name sebagai ID untuk filter openCategory
                // Karena user menyebutkan nama-nama kategori spesifik
                const safeName = cat.Name.replace(/'/g, "\\'");

                return `
                <div onclick="openCategory('${safeName}', '${safeName}')" class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition">
                    <div class="w-14 h-14 flex items-center justify-center bg-orange-50 rounded-2xl border border-orange-100 shadow-sm">
                        <img src="${iconSrc}" class="w-8 h-8 object-contain" onerror="this.src='https://img.icons8.com/color/48/food.png'" loading="lazy" decoding="async">
                    </div>
                    <span class="text-[10px] font-bold text-gray-600 text-center leading-tight px-1 truncate w-full mt-1">${cat.Name}</span>
                </div>
            `}).join('');
        }
    </script>
</body>
</html>
