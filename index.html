<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Meta PWA -->
    <meta name="theme-color" content="#ea580c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default"> 
    <meta name="apple-mobile-web-app-title" content="ProjekGo">
    
    <title>ProjekGo - Katalog Kuliner</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        /* === PERFORMA TINGGI & RESET === */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
            touch-action: manipulation; 
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        .shadow-xl, .shadow-2xl, .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03) !important;
        }

        /* Fallback Backdrop Blur untuk performa mobile rendah */
        .backdrop-blur, .backdrop-blur-sm, .backdrop-blur-md {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            background-color: rgba(255, 255, 255, 0.85);
        }
        
        .bg-black\/20, .bg-black\/50, .bg-black\/60 {
            background-color: rgba(0, 0, 0, 0.7) !important;
        }

        #app-container {
            height: 100%;
            height: 100dvh; 
            max-width: 28rem;
            margin: 0 auto;
            background-color: #ffffff;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateZ(0);
        }

        /* === SCROLLING === */
        .scrolling-wrapper {
            -webkit-overflow-scrolling: touch; 
            overflow-y: auto;
            overflow-x: hidden;
            will-change: scroll-position;
            overscroll-behavior-y: none;
            padding-bottom: 7rem; /* Adjusted for higher sticky button */
            scroll-behavior: auto; 
            transform: translateZ(0); 
            contain: content;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* FIX SCROLL ISSUE */
        .horizontal-slider {
            touch-action: pan-x pan-y; 
            min-height: 140px; 
            display: flex; 
        }

        .optimized-list {
            content-visibility: auto; 
            contain-intrinsic-size: 100px 800px; 
        }

        .category-icon:active { transform: scale(0.9); }
        
        .page-section {
            transition: opacity 0.15s ease-out;
            opacity: 1;
            pointer-events: auto;
            position: absolute;
            inset: 0;
            background-color: #fff; 
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding-bottom: 5rem;
            transform: translate3d(0,0,0);
        }
        .hidden-page { opacity: 0; pointer-events: none; z-index: 0; display: none !important; }

        .nav-item.active i { color: #ea580c; }
        .nav-item.active span { color: #ea580c; font-weight: 700; }

        .shop-closed { filter: grayscale(100%); opacity: 0.6; pointer-events: none; }

        .variant-radio:checked + label {
            background-color: #fff7ed; border-color: #ea580c; color: #ea580c; font-weight: 700;
        }
        .variant-radio:checked + label .check-icon { display: block; }
        
        .liked-anim { animation: like-bounce 0.2s ease-in-out; }
        @keyframes like-bounce { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        .progress-bar-fill { transition: width 0.5s ease-out; }

        .leaflet-pane { z-index: 10; }
        .leaflet-top, .leaflet-bottom { z-index: 20; }
        .leaflet-container { touch-action: none; }
    </style>
</head>
<body>

    <div id="app-container">
        
        <!-- === HALAMAN UTAMA (HOME) === -->
        <div id="home-page" class="page-section z-20 bg-gray-50">
            <main class="flex-1 overflow-y-auto hide-scrollbar scrolling-wrapper bg-white z-0 relative w-full pb-24">
                
                <!-- 1. Header ORANGE -->
                <div class="px-5 pt-12 pb-8 bg-orange-600 flex items-center justify-between gap-3 rounded-b-[2.5rem] shadow-lg relative z-50 mb-2">
                    <div>
                        <div class="flex items-center gap-1">
                             <span class="text-white text-2xl font-black tracking-tighter italic">PROJEK<span class="text-yellow-300">GO</span></span>
                        </div>
                        <div class="flex items-center gap-1 mt-0.5 cursor-pointer active:opacity-70 transition" onclick="openRegionModal()">
                            <p class="text-xs font-bold text-orange-50 max-w-[180px] truncate" id="header-address-text">Pilih Wilayah</p>
                            <i class="fas fa-chevron-down text-[10px] text-yellow-300"></i>
                        </div>
                    </div>
                    <button class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-sm border border-white/10 flex items-center justify-center text-white active:scale-95 transition hover:bg-white/30 shadow-sm" onclick="openPartnershipModal()">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>

                <!-- 2. Sticky Search Bar -->
                <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-md px-5 py-3 shadow-[0_4px_20px_rgba(0,0,0,0.02)] transition-all">
                    <div class="relative group active:scale-[0.98] transition w-full" onclick="navTo('search-page')">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i class="fas fa-search text-orange-500 text-sm"></i>
                        </div>
                        <input type="text" placeholder="Cari makanan enak..." readonly
                            class="w-full py-3.5 pl-11 pr-5 rounded-2xl text-gray-700 text-xs font-bold bg-gray-100 border-none focus:ring-0 cursor-pointer placeholder-gray-400">
                    </div>
                </div>

                <!-- 3. Konten Utama (Scrollable) -->
                <div class="px-5 space-y-6 pt-2 pb-24">
                    
                    <!-- Kategori -->
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm">Kategori</h3>
                        </div>
                        <div class="grid grid-cols-4 gap-y-4" id="categories-container">
                            <div class="col-span-4 text-center text-gray-400 text-xs py-4">
                                <div class="animate-pulse flex gap-4 justify-center">
                                    <div class="w-14 h-14 bg-gray-200 rounded-2xl"></div>
                                    <div class="w-14 h-14 bg-gray-200 rounded-2xl"></div>
                                    <div class="w-14 h-14 bg-gray-200 rounded-2xl"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Promo Banner (Horizontal Card) -->
                    <div style="contain: content;">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm">Lagi Promo</h3>
                            <span class="text-orange-600 text-[10px] font-bold cursor-pointer" onclick="openExclusivePage()">Lihat Semua</span>
                        </div>
                        <div id="exclusive-slider" class="flex gap-3 overflow-x-auto hide-scrollbar pb-2 snap-x min-h-[120px] horizontal-slider" style="scroll-behavior: auto;">
                             <div class="w-full text-center text-gray-400 text-xs py-8 animate-pulse flex flex-col justify-center items-center h-full">
                                <span>Memuat data...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Paling Laris (Horizontal List of Vertical Grids) -->
                    <div style="contain: content;">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm">Paling Laris</h3>
                            <span class="text-orange-600 text-[10px] font-bold cursor-pointer" onclick="openCategory('all', 'Semua Menu')">Lihat Semua</span>
                        </div>
                        <div id="recommendation-slider" class="flex gap-3 overflow-x-auto hide-scrollbar pb-2 snap-x min-h-[120px] horizontal-slider" style="scroll-behavior: auto;">
                            <div class="w-full text-center text-gray-400 text-xs py-8 animate-pulse flex flex-col justify-center items-center h-full">
                                <span>Memuat rekomendasi...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Daftar Penjual (Warung Sekitar - Big Cards) -->
                    <div>
                        <div class="flex justify-between items-end mb-3 sticky top-[70px] bg-white/95 backdrop-blur-sm z-10 py-2 -mx-5 px-5">
                            <h3 class="font-bold text-gray-800 text-sm">Warung Sekitar</h3>
                            <button onclick="fetchData(true)" class="text-orange-600 text-[10px] font-semibold flex items-center gap-1 hover:text-orange-700 active:scale-95 transition">
                                <i class="fas fa-sync-alt" id="refreshIcon"></i> Refresh
                            </button>
                        </div>
                        <div id="vendor-list" class="space-y-6 optimized-list">
                            <div class="text-center text-gray-400 text-xs py-10 bg-white rounded-2xl">
                                <i class="fas fa-store text-xl mb-2 text-gray-300"></i><br>Mencari Mitra...
                            </div>
                        </div>
                    </div>
                    
                </div>
            </main>
        </div>

        <!-- === HALAMAN DETAIL PRODUK === -->
        <div id="product-detail-page" class="page-section hidden-page z-50 bg-white flex flex-col h-full">
            <div class="absolute top-0 left-0 right-0 z-[60] p-4 flex justify-between pointer-events-none">
                <button onclick="handleBack()" class="pointer-events-auto w-10 h-10 bg-white/80 backdrop-blur-md rounded-full text-gray-700 flex items-center justify-center shadow-sm border border-gray-100 active:scale-90 transition">
                    <i class="fas fa-arrow-left text-sm"></i>
                </button>
                 <button class="pointer-events-auto w-10 h-10 bg-white/80 backdrop-blur-md rounded-full text-gray-700 flex items-center justify-center shadow-sm border border-gray-100 active:scale-90 transition">
                    <i class="fas fa-share-alt text-sm"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto scrolling-wrapper w-full relative">
                <div class="pb-40"> 
                    <div class="relative h-96 bg-gray-100 w-full shrink-0">
                        <img id="detail-img" src="" class="w-full h-full object-cover" loading="lazy">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                    </div>

                    <div class="relative z-10 -mt-8 bg-white rounded-t-[2.5rem] p-6 min-h-[50vh]">
                        <div class="mb-6">
                            <div class="flex justify-between items-start mb-2">
                                 <h2 id="detail-name" class="text-2xl font-black text-gray-800 leading-tight w-3/4">Nama Makanan</h2>
                                 <div class="flex flex-col items-end">
                                     <p id="detail-price" class="text-orange-600 font-black text-xl">Rp 0</p>
                                     <p id="detail-ori-price" class="text-gray-400 text-xs line-through hidden">Rp 0</p>
                                 </div>
                            </div>
                            
                            <div class="flex items-center gap-3 mb-4">
                                <div class="flex items-center gap-1 text-yellow-500 bg-yellow-50 px-2 py-1 rounded-lg border border-yellow-100">
                                    <i class="fas fa-star text-xs"></i> 
                                    <span id="detail-rating-avg" class="text-xs font-bold text-gray-800">4.8</span>
                                    <span class="text-[10px] text-gray-500">(<span id="detail-review-count">0</span>)</span>
                                </div>
                                <div class="w-[1px] h-4 bg-gray-300"></div>
                                <div class="flex items-center gap-1 cursor-pointer active:opacity-50" id="detail-vendor-link">
                                    <i class="fas fa-store text-orange-500 text-xs"></i>
                                    <span id="detail-vendor" class="text-xs font-bold text-gray-600 underline">Nama Warung</span>
                                </div>
                            </div>

                            <p id="detail-desc" class="text-sm text-gray-600 leading-relaxed">Deskripsi produk...</p>
                        </div>

                        <div class="h-2 bg-gray-50 -mx-6 mb-6"></div>

                        <div id="detail-variant-section" class="mb-6 hidden">
                            <h3 class="font-bold text-gray-800 text-sm mb-3">Pilih Varian</h3>
                            <div id="detail-variant-options" class="space-y-2"></div>
                        </div>

                        <div class="mb-10">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-gray-800 text-lg">Ulasan Pembeli</h3>
                            </div>
                            <div id="detail-reviews-list" class="space-y-4">
                                <div class="text-center text-gray-400 py-4 text-xs">Belum ada ulasan. Jadilah yang pertama!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-[90px] left-4 right-4 bg-white/95 backdrop-blur-sm border border-gray-100 p-4 rounded-2xl z-[60] flex items-center gap-3 shadow-[0_10px_40px_rgba(0,0,0,0.15)] max-w-md mx-auto ring-1 ring-black/5">
                 <div class="flex items-center gap-3 border border-gray-200 rounded-xl px-3 py-2.5">
                    <button onclick="adjustDetailQty(-1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-orange-600 font-bold active:scale-90 transition">-</button>
                    <span id="detail-qty" class="text-sm font-bold text-gray-800 w-4 text-center">1</span>
                    <button onclick="adjustDetailQty(1)" class="w-6 h-6 flex items-center justify-center text-green-600 font-bold active:scale-90 transition">+</button>
                </div>
                <button onclick="addToCartFromDetail()" class="flex-1 bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-orange-200 active:scale-[0.98] transition flex items-center justify-center gap-2 text-sm">
                    <i class="fas fa-shopping-basket"></i> Tambah Pesanan
                </button>
            </div>
        </div>

        <!-- FORM ULASAN -->
        <div id="write-review-modal" class="absolute inset-0 z-[100] hidden">
            <div class="absolute inset-0 bg-black/50" onclick="closeReviewForm()"></div>
            <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6 min-h-[50%] flex flex-col transition-transform duration-300 transform translate-y-full" id="write-review-content">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 cursor-grab" onclick="closeReviewForm()"></div>
                
                <h3 id="review-modal-title" class="font-bold text-xl text-gray-800 mb-2 text-center">Bagaimana makanannya?</h3>
                <p id="review-item-name" class="text-center text-gray-500 text-xs mb-6">Nama Makanan</p>
                
                <div class="flex justify-center gap-2 mb-6">
                    <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition review-star" onclick="setRating(1)"></i>
                    <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition review-star" onclick="setRating(2)"></i>
                    <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition review-star" onclick="setRating(3)"></i>
                    <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition review-star" onclick="setRating(4)"></i>
                    <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition review-star" onclick="setRating(5)"></i>
                </div>
                <input type="hidden" id="review-rating-value" value="0">
                <input type="hidden" id="review-item-id" value="">

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-2">Ceritakan pengalamanmu</label>
                    <textarea id="review-text" rows="4" class="w-full bg-gray-50 border border-gray-200 rounded-2xl p-4 text-sm focus:outline-none focus:border-orange-500 resize-none font-medium" placeholder="Rasanya enak, porsi banyak..."></textarea>
                </div>

                <button onclick="submitReview()" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-2xl shadow-lg mt-auto active:scale-[0.98] transition">
                    <span id="submit-review-btn-text">Kirim Ulasan</span>
                </button>
            </div>
        </div>

        <!-- === HALAMAN PENCARIAN === -->
        <div id="search-page" class="page-section hidden-page z-30 bg-gray-50">
            <div class="bg-white p-3 shadow-sm flex items-center gap-3 sticky top-0 z-10">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-2.5 text-orange-500 text-xs"></i>
                    <input type="text" id="global-search-input" placeholder="Cari makanan atau resto..." 
                        class="w-full py-2 pl-9 pr-4 rounded-full bg-gray-100 text-gray-800 text-xs focus:outline-none focus:ring-2 focus:ring-orange-200"
                        oninput="debouncedSearch(this.value)">
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 scrolling-wrapper optimized-list" id="search-results">
                <div class="text-center mt-10 text-gray-400">
                    <i class="fas fa-search text-3xl mb-2"></i>
                    <p class="text-xs">Ketik untuk mencari...</p>
                </div>
            </div>
        </div>

        <!-- === HALAMAN POIN === -->
        <div id="points-page" class="page-section hidden-page z-30 bg-gray-50">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 sticky top-0 z-10">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Poin Saya</h2>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar scrolling-wrapper">
                <div class="bg-gradient-to-br from-orange-500 to-red-600 rounded-[1.5rem] p-5 text-white shadow-xl mb-6 relative overflow-hidden">
                    <div class="absolute -top-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl"></div>
                    <div class="absolute bottom-0 left-0 w-32 h-32 bg-yellow-400 opacity-10 rounded-full blur-xl"></div>
                    
                    <div class="relative z-10 flex flex-col items-center">
                        <p class="text-orange-100 text-xs font-medium mb-1">Saldo Poin</p>
                        <h1 class="text-5xl font-black mb-2 drop-shadow-sm" id="point-display-count">0</h1>
                        <div class="w-full bg-black/20 rounded-full h-2 mb-2 overflow-hidden">
                            <div id="point-progress-bar" class="bg-yellow-400 h-full rounded-full shadow-lg progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between w-full text-[10px] font-medium text-orange-100 px-1">
                            <span>0</span>
                            <span id="point-target-text">Target: 10 Poin</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-[1.5rem] shadow-sm mb-6 border border-gray-100">
                    <h3 class="font-bold text-gray-800 text-sm mb-3">Punya Kode Voucher?</h3>
                    <div class="flex gap-2">
                        <input type="text" id="claim-code-input" placeholder="Masukkan kode dari Admin" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-orange-500 uppercase">
                        <button onclick="claimPointCode()" class="bg-orange-600 text-white px-4 py-2 rounded-xl font-bold text-xs shadow-md active:scale-95">Klaim</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 italic">*Minta kode ke admin setelah pesananmu selesai diantar.</p>
                </div>

                <div class="bg-white p-5 rounded-[1.5rem] shadow-sm mb-6 border border-gray-100">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-lg">
                            <i class="fas fa-truck-fast"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm">Gratis Ongkir Rp 5.000</h3>
                            <p class="text-[10px] text-gray-500">Tukarkan 10 Poin</p>
                        </div>
                    </div>
                    <button id="btn-redeem-point" onclick="redeemPoints()" disabled class="w-full py-3 rounded-xl font-bold text-xs transition-all duration-300 bg-gray-200 text-gray-400 cursor-not-allowed">
                        Tukar Poin
                    </button>
                </div>
            </div>
        </div>

        <!-- === HALAMAN PESANAN (History) === -->
        <div id="orders-page" class="page-section hidden-page z-30 bg-gray-50">
             <div class="bg-white p-4 shadow-sm flex items-center gap-4 sticky top-0 z-10">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Riwayat Pesanan</h2>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 scrolling-wrapper optimized-list" id="order-history-container">
                 <div class="text-center text-gray-400 mt-10 text-xs">Belum ada pesanan. Pesan dulu yuk!</div>
            </div>
        </div>

        <!-- === HALAMAN PROFIL === -->
        <div id="profile-page" class="page-section hidden-page z-30 bg-gray-50">
            <div class="bg-orange-600 h-24 relative shrink-0"></div>
            <div class="px-4 -mt-10 relative z-10 mb-4 shrink-0">
                <div class="bg-white p-4 rounded-[1.5rem] shadow-md flex flex-col items-center relative">
                    <div class="w-16 h-16 bg-gray-200 rounded-full border-4 border-white -mt-10 mb-2 overflow-hidden shadow-sm">
                        <img src="https://ui-avatars.com/api/?name=User+ProjekGo&background=random" class="w-full h-full" id="profile-avatar-img" loading="lazy">
                    </div>
                    <button onclick="openEditProfile()" class="absolute top-2 right-2 text-gray-400 hover:text-orange-600 p-2">
                        <i class="fas fa-pen text-xs"></i>
                    </button>
                    <h2 class="font-bold text-base text-gray-800" id="profile-name-text">User ProjekGo</h2>
                    <p class="text-xs text-gray-500" id="profile-phone-text">+62 812-3456-7890</p>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto px-4 pb-20 scrolling-wrapper">
                <div class="space-y-3">
                    <button onclick="openAddressModal()" class="w-full bg-white p-3 rounded-2xl shadow-sm flex justify-between items-center text-gray-700 active:bg-gray-50 transition">
                        <span class="font-medium text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-full bg-orange-100 flex items-center justify-center text-orange-500"><i class="fas fa-map-marker-alt text-xs"></i></div> Alamat Tersimpan</span>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </button>
                    <button onclick="openFavoritesPage()" class="w-full bg-white p-3 rounded-2xl shadow-sm flex justify-between items-center text-gray-700 active:bg-gray-50 transition">
                        <span class="font-medium text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-full bg-red-100 flex items-center justify-center text-red-500"><i class="fas fa-heart text-xs"></i></div> Makanan Favorit</span>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </button>
                    <button class="w-full bg-white p-3 rounded-2xl shadow-sm flex justify-between items-center text-gray-700 active:bg-gray-50 transition">
                        <span class="font-medium text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-full bg-blue-100 flex items-center justify-center text-blue-500"><i class="fas fa-headset text-xs"></i></div> Bantuan</span>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- === HALAMAN KERANJANG === -->
        <div id="cart-page" class="page-section hidden-page z-50 bg-gray-50 flex flex-col h-full absolute inset-0">
            <!-- Header Cart -->
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 sticky top-0 z-20 flex-shrink-0">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Keranjang</h2>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar scrolling-wrapper">
                <div id="cart-items-container" class="space-y-4 pb-4 optimized-list">
                    <!-- Cart items will be rendered here -->
                </div>
                
                <!-- Checkout Form Area -->
                <div id="checkout-form-container" class="border-t border-gray-200 pt-6 hidden pb-24">
                    <div class="mb-4 space-y-4">
                        <!-- Alamat -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-2">Alamat Pengantaran</label>
                            <div class="relative">
                                <i class="fas fa-map-marker-alt absolute left-3 top-3 text-orange-500 text-xs"></i>
                                <textarea id="checkout-address" rows="3" class="w-full bg-white border border-gray-200 rounded-xl py-2.5 pl-9 pr-4 text-xs focus:outline-none focus:border-orange-500 resize-none font-medium text-gray-700 shadow-sm placeholder-gray-400" placeholder="Ketik alamat lengkap (Jalan, No. Rumah, Patokan)..."></textarea>
                            </div>
                        </div>

                        <!-- Catatan Pesanan (BARU) -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-2">Catatan Pesanan (Opsional)</label>
                            <div class="relative">
                                <i class="fas fa-edit absolute left-3 top-3 text-gray-400 text-xs"></i>
                                <textarea id="checkout-note" rows="2" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-2.5 pl-9 pr-4 text-xs focus:outline-none focus:border-orange-500 resize-none font-medium text-gray-700 placeholder-gray-400" placeholder="Contoh: Jangan pedas, kuah dipisah, banyakin kecap..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dynamic Summary will be injected here via JS -->
                    <div id="cart-summary-area"></div>
                </div>
            </div>
        </div>

        <!-- === HALAMAN KATEGORI / FAVORIT === -->
        <div id="category-page" class="page-section hidden-page z-40 bg-gray-50">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 z-10 shrink-0 sticky top-0">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 id="cat-page-title" class="text-lg font-bold text-gray-800">Kategori</h2>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar scrolling-wrapper">
                <div id="category-content-container" class="space-y-4 pb-24 optimized-list"></div>
            </div>
        </div>

        <!-- HALAMAN "HANYA ADA DI PROJEKGO" -->
        <div id="exclusive-page" class="page-section hidden-page z-40 bg-gray-50">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 z-10 shrink-0 sticky top-0">
                <button onclick="handleBack()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-700 active:bg-gray-200">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Eksklusif</h2>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 hide-scrollbar scrolling-wrapper">
                <div id="exclusive-content-container" class="grid grid-cols-2 gap-3 pb-24 optimized-list"></div>
            </div>
        </div>

        <!-- === HALAMAN DETAIL PENJUAL (TERBARU) === -->
        <div id="vendor-page" class="page-section hidden-page z-50 bg-gray-50 block overflow-y-auto scrolling-wrapper">
            <div class="fixed top-0 left-0 z-[60] p-4">
                <button onclick="handleBack()" class="w-10 h-10 bg-orange-600 rounded-full text-white flex items-center justify-center shadow-lg hover:bg-orange-700 transition active:scale-90 border-2 border-white/20">
                    <i class="fas fa-arrow-left text-sm"></i>
                </button>
            </div>

            <div class="relative h-72 bg-gray-300 w-full shrink-0"> 
                <img id="vendor-banner-img" src="" class="w-full h-full object-cover" loading="lazy" decoding="async">
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                
                <div class="absolute bottom-10 left-5 text-white w-full pr-5 z-10">
                    <div class="flex justify-between items-end">
                        <div>
                            <h2 id="vendor-name-title" class="text-3xl font-black leading-none mb-2 shadow-black drop-shadow-md tracking-tight">Nama Warung</h2>
                            <div class="flex items-center gap-2">
                                <span class="bg-orange-600/90 backdrop-blur-sm px-2.5 py-0.5 rounded-lg text-[10px] font-bold border border-orange-500/30 text-white shadow-sm" id="vendor-info-status">Buka</span>
                                <span class="text-xs opacity-90 font-medium text-gray-100 bg-black/20 px-2 py-0.5 rounded-lg backdrop-blur-sm" id="vendor-info-type">Kategori</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="relative z-10 -mt-6 bg-gray-50 rounded-t-[2rem] min-h-[calc(100vh-16rem)] p-5 pb-32 shadow-[0_-4px_20px_rgba(0,0,0,0.1)]">
                <div class="absolute right-8 -top-6 bg-white px-4 py-2 rounded-2xl shadow-xl flex flex-col items-center justify-center border border-gray-100 w-16 h-16">
                    <i class="fas fa-star text-yellow-400 text-sm mb-0.5"></i>
                    <span id="vendor-rating-badge" class="text-sm font-black text-gray-800 leading-none">4.8</span>
                </div>

                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 opacity-60"></div>
                
                <div class="flex items-center justify-between mb-5 sticky top-0 bg-gray-50/95 backdrop-blur-sm py-2 z-20">
                    <h3 class="font-bold text-gray-800 text-lg">Daftar Menu</h3>
                    <span class="text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-lg">Scroll &darr;</span>
                </div>
                
                <div id="vendor-menu-container" class="grid grid-cols-2 gap-3 optimized-list"></div>
            </div>
        </div>

        <!-- === MODAL / SHEET LAYOUTS === -->
        
        <!-- MODAL PILIHAN WILAYAH -->
        <div id="region-choice-modal" class="absolute inset-0 z-[110] hidden bg-black/80 flex items-center justify-center p-6" style="backdrop-filter: none;">
            <div class="bg-white rounded-[2rem] w-full max-w-sm p-6 shadow-2xl animate-bounce-in">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-map-marked-alt text-2xl text-orange-600"></i>
                    </div>
                    <h2 class="text-xl font-black text-gray-800">Mau Jajan Dimana?</h2>
                    <p class="text-sm text-gray-500 mt-1">Pilih area sekitarmu untuk menemukan kuliner terbaik.</p>
                </div>
                <div class="space-y-3">
                    <button onclick="selectRegion('Gombong')" class="w-full bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-xl font-bold shadow-lg shadow-orange-200 transition active:scale-[0.98] flex items-center justify-between group">
                        <span>Area Gombong</span>
                        <i class="fas fa-chevron-right group-hover:translate-x-1 transition"></i>
                    </button>
                    <button onclick="selectRegion('Kebumen')" class="w-full bg-white border-2 border-gray-100 hover:border-orange-500 text-gray-700 p-4 rounded-xl font-bold transition active:scale-[0.98] flex items-center justify-between group">
                        <span>Kebumen Kota</span>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:text-orange-500 transition"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- SELLER REGISTRATION SHEET -->
        <div id="seller-register-modal" class="absolute inset-0 z-[100] hidden">
            <div class="absolute inset-0 bg-black/50" onclick="closeSellerRegistration()"></div>
            <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6 min-h-[85%] flex flex-col transition-transform duration-300 transform translate-y-full" id="seller-register-content">
                <button onclick="closeSellerRegistration()" class="absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 hover:text-red-500 transition z-20"><i class="fas fa-times"></i></button>
                <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4 cursor-grab" onclick="closeSellerRegistration()"></div>
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600"><i class="fas fa-store"></i></div>
                    <div><h3 class="font-bold text-xl text-gray-800 leading-none">Formulir Mitra Penjual</h3><p class="text-xs text-gray-500 mt-1">Daftar sekarang untuk mulai berjualan</p></div>
                </div>
                <div class="flex-1 overflow-y-auto hide-scrollbar space-y-5 pb-6">
                    <div>
                        <h4 class="text-sm font-bold text-gray-800 mb-3 border-l-4 border-orange-500 pl-2">Informasi Pemilik</h4>
                        <div class="space-y-3">
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Nama Lengkap Pemilik</label><input type="text" id="reg-seller-name" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500 font-medium" placeholder="Contoh: Budi Santoso"></div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Nomor WhatsApp Aktif</label><div class="relative"><span class="absolute left-4 top-3 text-gray-500 font-medium text-sm">+62</span><input type="tel" id="reg-seller-phone" class="w-full bg-gray-50 border border-gray-200 rounded-2xl pl-12 pr-4 py-3 text-sm focus:outline-none focus:border-orange-500 font-medium" placeholder="8123456789"></div></div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-gray-800 mb-3 border-l-4 border-orange-500 pl-2">Informasi Usaha</h4>
                        <div class="space-y-3">
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Nama Resto / Warung</label><input type="text" id="reg-seller-biz" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500 font-medium" placeholder="Contoh: Warung Sejahtera"></div>
                            
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Area Operasional (Wajib Pilih)</label>
                                <select id="reg-seller-region" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500 font-medium text-gray-700">
                                    <option value="" disabled selected>Pilih Wilayah Warung</option>
                                    <option value="Gombong">Area Gombong</option>
                                    <option value="Kebumen Kota">Kebumen Kota</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Kategori Makanan</label>
                                <select id="reg-seller-cat" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500 font-medium text-gray-700">
                                    <option value="" disabled selected>Pilih Kategori Utama</option>
                                    <option value="Sarapan">Sarapan</option>
                                    <option value="per Nasi an">per Nasi an</option>
                                    <option value="Minuman">Minuman</option>
                                    <option value="Ayam">Ayam</option>
                                    <option value="Makanan kuah">Makanan kuah</option>
                                    <option value="Aneka mie">Aneka mie</option>
                                    <option value="Makanan ringan">Makanan ringan</option>
                                </select>
                            </div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Alamat Lengkap Usaha</label><textarea id="reg-seller-addr" rows="2" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500 font-medium resize-none" placeholder="Jalan, No, RT/RW, Kelurahan..."></textarea></div>
                        </div>
                    </div>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-100">
                    <button onclick="submitRegistration('Mitra Penjual')" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-orange-200 hover:bg-orange-700 active:scale-[0.98] transition flex justify-center items-center gap-2">
                        <i class="fas fa-paper-plane"></i> Kirim Pendaftaran
                    </button>
                </div>
            </div>
        </div>

        <!-- EDIT PROFILE -->
        <div id="edit-profile-modal" class="absolute inset-0 z-[90] hidden flex items-center justify-center bg-black/50 p-4">
            <div class="bg-white rounded-[2rem] w-full max-w-sm p-6 shadow-2xl">
                <h3 class="font-bold text-lg text-gray-800 mb-4">Edit Profil</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Nama Lengkap</label>
                        <input type="text" id="edit-name-input" class="w-full border border-gray-300 rounded-xl p-3 text-sm focus:outline-none focus:border-orange-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Nomor Telepon</label>
                        <input type="tel" id="edit-phone-input" class="w-full border border-gray-300 rounded-xl p-3 text-sm focus:outline-none focus:border-orange-500">
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button onclick="closeEditProfile()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl">Batal</button>
                        <button onclick="saveProfile()" class="flex-1 bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg">Simpan</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADDRESS MODAL -->
        <div id="address-modal" class="absolute inset-0 z-[85] hidden bg-gray-50 flex flex-col">
            <div class="bg-white p-4 shadow-sm flex items-center gap-4 z-10">
                <button onclick="closeAddressModal()" class="p-2 hover:bg-gray-100 rounded-full text-gray-700">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-lg font-bold text-gray-800">Alamat Tersimpan</h2>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 scrolling-wrapper optimized-list" id="address-list-container"></div>
            <div class="p-4 bg-white border-t border-gray-200">
                <button onclick="openAddAddressModal()" class="w-full bg-orange-600 text-white font-bold py-3 rounded-2xl shadow-lg flex items-center justify-center gap-2 active:scale-[0.98] transition">
                    <i class="fas fa-plus"></i> Tambah Alamat Baru
                </button>
            </div>
        </div>

        <!-- ADD ADDRESS SHEET -->
        <div id="add-address-modal" class="absolute inset-0 z-[90] hidden">
            <div class="absolute inset-0 bg-black/50" onclick="closeAddAddressModal()"></div>
            <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6 min-h-[50%] flex flex-col transition-transform duration-300 transform translate-y-full" id="add-address-content">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 cursor-grab" onclick="closeAddAddressModal()"></div>
                <h3 class="font-bold text-xl text-gray-800 mb-6">Tambah Alamat Baru</h3>
                <div class="space-y-5 mb-6 flex-1 overflow-y-auto hide-scrollbar">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Label Alamat</label>
                        <div class="flex gap-2">
                            <button onclick="setAddressLabel('Rumah')" class="addr-label-btn flex-1 py-3 border border-orange-500 bg-orange-50 text-orange-600 rounded-2xl text-sm font-bold transition">Rumah</button>
                            <button onclick="setAddressLabel('Kantor')" class="addr-label-btn flex-1 py-3 border border-gray-200 text-gray-600 rounded-2xl text-sm font-bold hover:bg-gray-50 transition">Kantor</button>
                            <button onclick="setAddressLabel('Lainnya')" class="addr-label-btn flex-1 py-3 border border-gray-200 text-gray-600 rounded-2xl text-sm font-bold hover:bg-gray-50 transition">Lainnya</button>
                        </div>
                        <input type="hidden" id="new-addr-label" value="Rumah">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Alamat Lengkap</label>
                        <div class="relative">
                            <i class="fas fa-map-marker-alt absolute left-3 top-3.5 text-gray-400"></i>
                            <textarea id="new-addr-detail" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-2xl py-3 pl-10 pr-4 text-sm focus:outline-none focus:border-orange-500 focus:bg-white transition resize-none text-gray-800 font-medium" placeholder="Jalan, Nomor Rumah, RT/RW..."></textarea>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Catatan Kurir (Opsional)</label>
                        <div class="relative">
                            <i class="fas fa-pen absolute left-3 top-3.5 text-gray-400"></i>
                            <input type="text" id="new-addr-note" class="w-full bg-gray-50 border border-gray-200 rounded-2xl py-3 pl-10 pr-4 text-sm focus:outline-none focus:border-orange-500 focus:bg-white transition text-gray-800 font-medium" placeholder="Pagar hitam, dekat warung...">
                        </div>
                    </div>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-100">
                    <button onclick="saveNewAddress()" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-orange-200 hover:bg-orange-700 active:scale-[0.98] transition flex justify-center items-center gap-2">
                        <i class="fas fa-check"></i> Simpan Alamat
                    </button>
                </div>
            </div>
        </div>

        <!-- PARTNERSHIP MODAL -->
        <div id="partnership-modal" class="absolute inset-0 z-[95] hidden flex items-end justify-center bg-black/50" onclick="closePartnershipModal()">
            <div class="bg-white w-full rounded-t-[2.5rem] p-6 pb-10" onclick="event.stopPropagation()">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-6"></div>
                <h3 class="font-bold text-xl text-gray-800 mb-4">Menu Mitra</h3>
                <div class="space-y-3">
                    <div onclick="openSellerRegistration()" class="bg-green-50 p-4 rounded-2xl flex items-center gap-4 hover:bg-green-100 transition border border-green-100 cursor-pointer">
                        <div class="bg-green-500 text-white w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-user-plus"></i></div>
                        <div><h4 class="font-bold text-gray-800">Daftar Mitra Baru</h4><p class="text-xs text-gray-600">Gabung jadi penjual/rider sekarang</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <nav class="bg-white border-t border-gray-100 flex justify-around items-center px-2 py-3 pb-6 shrink-0 z-[60] absolute bottom-0 left-0 right-0 w-full rounded-t-[2rem] shadow-[0_-5px_15px_rgba(0,0,0,0.03)]" style="contain: layout size;">
            <button onclick="navTo('home-page')" class="nav-item active flex flex-col items-center gap-1 text-gray-400 w-16 active:scale-90 transition" id="nav-home">
                <i class="fas fa-utensils text-xl"></i><span class="text-[10px] font-medium">Beranda</span>
            </button>
            
            <button onclick="navTo('points-page')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16 active:scale-90 transition" id="nav-points">
                <i class="fas fa-star text-xl"></i><span class="text-[10px] font-medium">Poin</span>
            </button>
            
            <div class="relative -top-6">
                <!-- Open Full Page Cart -->
                <button onclick="navTo('cart-page'); renderCartPage()" class="bg-orange-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-orange-300 active:scale-95 transition relative z-40">
                    <i class="fas fa-shopping-basket text-xl"></i>
                    <span id="cart-badge-nav" class="absolute top-0 right-0 bg-red-500 border-2 border-white text-white text-[9px] w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
                </button>
            </div>
            <button onclick="navTo('orders-page')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16 active:scale-90 transition" id="nav-orders">
                <i class="fas fa-receipt text-xl"></i><span class="text-[10px] font-medium">Pesanan</span>
            </button>
            <button onclick="navTo('profile-page')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16 active:scale-90 transition" id="nav-profile">
                <i class="fas fa-user text-xl"></i><span class="text-[10px] font-medium">Profil</span>
            </button>
        </nav>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbw65jWYm1cmPsXPM22Hsi9LH0FrY2AiIPNHE-16uvhEaVsx-KrgZ8KWw0K0cpAVA5Sj/exec"; 
        
        // --- CACHE CONSTANTS ---
        const CACHE_DURATION = 30 * 60 * 1000; // 30 Menit
        
        // --- HELPER UNTUK SAFE STORAGE (Mencegah SecurityError di iframe) ---
        const safeStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } catch(e) { console.warn('Storage restricted'); return null; }
            },
            setItem: (key, val) => {
                try { localStorage.setItem(key, val); } catch(e) { console.warn('Storage restricted'); }
            }
        };

        let map;
        let selectedLat, selectedLng;
        let cart = [];
        
        // Load data safely
        let orderHistory = [];
        try { orderHistory = JSON.parse(safeStorage.getItem('pg_orders')) || []; } catch(e) { }

        let productsData = [];
        let vendorsData = [];
        let userRegionPref = safeStorage.getItem('pg_region_pref') || null;
        
        let favorites = new Set();
        try { favorites = new Set(JSON.parse(safeStorage.getItem('pg_favorites')) || []); } catch(e) { }
        
        // --- REVIEW SYSTEM ---
        let productReviews = {};
        try { productReviews = JSON.parse(safeStorage.getItem('pg_reviews')) || {}; } catch(e) { }

        let currentDetailItem = null;
        let currentDetailQty = 1;

        let userProfile = {
            name: "User ProjekGo",
            phone: "+62 812-3456-7890",
            avatar: "https://ui-avatars.com/api/?name=User+ProjekGo&background=random"
        };
        let savedAddresses = [
            { id: 1, label: "Rumah", detail: "Jl. Melati No. 10, RT 01/02, Jakarta Selatan" },
            { id: 2, label: "Kantor", detail: "Gedung Cyber Lt. 2, Kuningan, Jakarta Selatan" }
        ];

        let userPoints = parseInt(safeStorage.getItem('pg_points')) || 0;
        
        let claimedCodes = [];
        try { claimedCodes = JSON.parse(safeStorage.getItem('pg_claimed_codes')) || []; } catch(e) { }
        
        const VALID_POINT_CODES = ['PROJEKGO', 'MAKANENAK', 'SENIN', 'JUMATBERKAH', 'TEST1234'];

        // Helper untuk format nominal pendek (misal: 5rb)
        function formatRupiahShort(num) {
            if(num >= 1000) {
                // Jika kelipatan 1000, tampilkan bulat, jika tidak 1 desimal
                return (num / 1000).toFixed(num % 1000 === 0 ? 0 : 1) + 'rb';
            }
            return num;
        }

        function toggleFavorite(e, itemId) {
            e.stopPropagation();
            if(favorites.has(itemId)) {
                favorites.delete(itemId);
            } else {
                favorites.add(itemId);
            }
            safeStorage.setItem('pg_favorites', JSON.stringify([...favorites]));
            
            // Re-render UI: Cari tombol dan ubah classnya
            const btnIcon = e.currentTarget.querySelector('i');
            if(btnIcon) {
                if(favorites.has(itemId)) {
                    btnIcon.className = 'fas fa-heart text-red-500 text-xs';
                } else {
                    btnIcon.className = 'far fa-heart text-white text-xs';
                }
            }
            
            // Animasi kecil
            e.currentTarget.classList.add('scale-125');
            setTimeout(() => e.currentTarget.classList.remove('scale-125'), 200);
        }

        // --- HISTORY API HANDLING ---
        window.addEventListener('load', () => {
            try {
                history.pushState({page: 'home'}, document.title, window.location.href);
            } catch(e) { console.warn("History API access denied/restricted."); }

            fetchData();
            if(!userRegionPref) {
                setTimeout(() => { document.getElementById('region-choice-modal').classList.remove('hidden'); }, 1000);
            } else {
                document.getElementById('header-address-text').innerText = userRegionPref;
            }
            updateProfileUI(); updatePointsUI(); renderOrderHistory();
        });

        window.addEventListener('popstate', (event) => {
            try { history.pushState({page: 'home'}, document.title, window.location.href); } catch(e) { }
            handleHardwareBack();
        });

        function handleHardwareBack() {
            if(!document.getElementById('write-review-modal').classList.contains('hidden')) { closeReviewForm(); return; }
            if(!document.getElementById('seller-register-modal').classList.contains('hidden')) { closeSellerRegistration(); return; }
            if(!document.getElementById('add-address-modal').classList.contains('hidden')) { closeAddAddressModal(); return; }
            if(!document.getElementById('address-modal').classList.contains('hidden')) { closeAddressModal(); return; }
            if(!document.getElementById('edit-profile-modal').classList.contains('hidden')) { closeEditProfile(); return; }
            if(!document.getElementById('partnership-modal').classList.contains('hidden')) { closePartnershipModal(); return; }
            
            const detailPage = document.getElementById('product-detail-page');
            if (!detailPage.classList.contains('hidden-page')) { navTo('home-page'); return; }

            const activePage = document.querySelector('.page-section.z-30');
            if (activePage && activePage.id !== 'home-page') { navTo('home-page'); return; }
        }

        // --- DEBOUNCE SEARCH ---
        let searchTimeout;
        function debouncedSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { handleGlobalSearch(query); }, 300); 
        }

        function handleGlobalSearch(query) {
            const container = document.getElementById('search-results');
            if(!query) {
                container.innerHTML = `<div class="text-center mt-10 text-gray-400"><i class="fas fa-search text-3xl mb-2"></i><p class="text-xs">Ketik untuk mencari...</p></div>`;
                return;
            }
            const lowerQ = query.toLowerCase();
            const applicableProducts = getAppplicableProducts(); 
            const results = applicableProducts.filter(p => p.Name.toLowerCase().includes(lowerQ) || p.Vendor_Name.toLowerCase().includes(lowerQ));
            if(results.length === 0) { container.innerHTML = `<div class="text-center mt-10 text-gray-400"><p class="text-xs">Tidak ditemukan.</p></div>`; } 
            else { renderProductGrid(results, container); }
        }

        function convertDriveImage(url) {
            if (!url) return 'https://placehold.co/200?text=No+Img';
            if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
                const idMatch = url.match(/[-\w]{25,}/);
                if (idMatch) { return `https://lh3.googleusercontent.com/d/${idMatch[0]}`; }
            }
            return url;
        }

        function selectRegion(region) {
            userRegionPref = region === 'Kebumen' ? 'Kebumen Kota' : 'Gombong';
            safeStorage.setItem('pg_region_pref', userRegionPref);
            document.getElementById('header-address-text').innerText = userRegionPref;
            document.getElementById('region-choice-modal').classList.add('hidden');
            refreshDashboard();
        }

        function openRegionModal() { document.getElementById('region-choice-modal').classList.remove('hidden'); }
        
        function refreshDashboard() {
            if(productsData.length > 0) {
                renderProductLists();
                // Panggil fungsi render baru untuk "Warung Sekitar"
                renderNearbyBigCards(vendorsData, productsData);
            }
        }

        async function fetchData(forceRefresh = false) {
            const refreshBtn = document.getElementById('refreshIcon');
            if(refreshBtn) refreshBtn.classList.add('fa-spin');

            const now = Date.now();
            let cachedCats = null, cachedProds = null, cachedVends = null;
            try {
                cachedCats = JSON.parse(safeStorage.getItem('pg_cache_cats'));
                cachedProds = JSON.parse(safeStorage.getItem('pg_cache_prods'));
                cachedVends = JSON.parse(safeStorage.getItem('pg_cache_vends'));
            } catch(e) {}
            
            let isCacheValid = cachedCats && cachedProds && cachedVends && (now - cachedCats.timestamp < CACHE_DURATION);

            if (isCacheValid && !forceRefresh) {
                console.log("Using Cached Data");
                renderCategories(cachedCats.data);
                vendorsData = cachedVends.data;
                productsData = cachedProds.data;
                renderProductLists();
                renderNearbyBigCards(vendorsData, productsData);
                if(refreshBtn) refreshBtn.classList.remove('fa-spin');
                fetchFromNetwork(false); 
                return;
            }
            await fetchFromNetwork(true);
            if(refreshBtn) refreshBtn.classList.remove('fa-spin');
        }

        async function fetchFromNetwork(renderImmediately) {
            try {
                const timeout = (ms, promise) => {
                    return new Promise((resolve, reject) => {
                        setTimeout(() => reject(new Error("Timeout")), ms);
                        promise.then(resolve, reject);
                    });
                };

                // UPDATED TIMEOUT: Increased from 10000ms (10s) to 25000ms (25s) to prevent timeout errors on slow connections
                const vendRes = await timeout(25000, fetch(`${API_URL}?action=getVendors`));
                const vendJson = await vendRes.json();
                if(vendJson.status === 'success') {
                    vendorsData = vendJson.data;
                    safeStorage.setItem('pg_cache_vends', JSON.stringify({timestamp: Date.now(), data: vendorsData}));
                }

                const catRes = await timeout(25000, fetch(`${API_URL}?action=getCategories`));
                const catJson = await catRes.json();
                if(catJson.status === 'success') {
                    safeStorage.setItem('pg_cache_cats', JSON.stringify({timestamp: Date.now(), data: catJson.data}));
                    if(renderImmediately) renderCategories(catJson.data);
                }

                const prodRes = await timeout(25000, fetch(`${API_URL}?action=getProducts`));
                const prodJson = await prodRes.json();
                if(prodJson.status === 'success') {
                    productsData = prodJson.data; 
                    safeStorage.setItem('pg_cache_prods', JSON.stringify({timestamp: Date.now(), data: productsData}));
                    if(renderImmediately) {
                        renderProductLists();
                        renderNearbyBigCards(vendorsData, productsData);
                    }
                }

            } catch (error) {
                console.error("Gagal memuat data:", error);
                if(renderImmediately) {
                    renderProductLists(); 
                    renderNearbyBigCards(vendorsData || [], productsData || []);
                }
            }
        }

        function renderCategories(data) {
            const container = document.getElementById('categories-container');
            const iconMap = {
                'Sarapan': 'https://img.icons8.com/color/48/breakfast.png',
                'per Nasi an': 'https://img.icons8.com/color/48/rice-bowl.png',
                'Minuman': 'https://img.icons8.com/color/48/orange-soda.png',
                'Ayam': 'https://img.icons8.com/color/48/fried-chicken.png',
                'Makanan kuah': 'https://img.icons8.com/color/48/soup-plate.png',
                'Aneka mie': 'https://img.icons8.com/color/48/noodles.png',
                'Makanan ringan': 'https://img.icons8.com/color/48/chips.png'
            };

            container.innerHTML = data.map(cat => {
                let iconSrc = cat.Icon_Image_URL;
                if (!iconSrc || iconSrc.trim() === '') {
                    const key = Object.keys(iconMap).find(k => k.toLowerCase() === cat.Name.toLowerCase());
                    iconSrc = key ? iconMap[key] : 'https://img.icons8.com/color/48/food.png';
                }
                const safeName = cat.Name.replace(/'/g, "\\'");
                return `
                <div onclick="openCategory('${safeName}', '${safeName}')" class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition">
                    <div class="w-20 h-20 flex items-center justify-center rounded-full bg-orange-600/10 backdrop-blur-sm transition hover:scale-105 border border-orange-600/5">
                        <img src="${iconSrc}" class="w-12 h-12 object-contain drop-shadow-sm mix-blend-multiply" onerror="this.src='https://img.icons8.com/color/48/food.png'" loading="lazy" decoding="async">
                    </div>
                    <span class="text-[10px] font-bold text-gray-700 text-center leading-tight px-1 truncate w-full mt-1">${cat.Name}</span>
                </div>
            `}).join('');
        }

        function getAppplicableProducts() {
            if (!userRegionPref) return productsData;
            if (!vendorsData || vendorsData.length === 0) return [];
            
            const validVendors = vendorsData.filter(v => {
                const region = (v.Region || v.City || v.Alamat || v.Address || '').toLowerCase();
                const pref = userRegionPref.toLowerCase();
                if (pref.includes('gombong')) return region.includes('gombong');
                if (pref.includes('kebumen')) return region.includes('kebumen');
                return true; 
            }).map(v => v.Vendor_Name);
            return productsData.filter(p => validVendors.includes(p.Vendor_Name));
        }

        function renderProductLists() {
            const exclusiveContainer = document.getElementById('exclusive-slider');
            const recContainer = document.getElementById('recommendation-slider');
            const emptyUI = (msg) => `<div class="w-full text-center py-4 flex flex-col items-center justify-center h-full"><p class="text-xs text-gray-400 mb-2">${msg}</p><button onclick="fetchData(true)" class="bg-gray-100 hover:bg-gray-200 text-gray-600 text-[10px] font-bold py-1 px-3 rounded-full transition"><i class="fas fa-sync-alt mr-1"></i> Coba Lagi</button></div>`;

            if (!productsData || productsData.length === 0) {
                exclusiveContainer.innerHTML = emptyUI("Sedang memuat...");
                recContainer.innerHTML = emptyUI("Sedang memuat...");
                return;
            }

            const applicableProducts = getAppplicableProducts();
            const exclusive = applicableProducts.filter(p => String(p.Is_Exclusive || p.Exclusive || 'false').toLowerCase() === 'true');
            const normal = applicableProducts; 

            if(exclusive.length > 0) {
                exclusiveContainer.innerHTML = exclusive.map(p => createProductCard(p, 'horizontal')).join('');
            } else {
                exclusiveContainer.innerHTML = '<div class="text-xs text-gray-400 w-full text-center py-4 flex flex-col justify-center h-full">Belum ada promo di wilayah ini.</div>';
            }

            if(normal.length > 0) {
                recContainer.innerHTML = normal.slice(0, 10).map(p => 
                    `<div class="min-w-[150px] w-40 snap-center h-full">` + createProductCard(p, 'vertical') + `</div>`
                ).join('');
            } else {
                recContainer.innerHTML = '<div class="text-xs text-gray-400 w-full text-center py-4 flex flex-col justify-center h-full">Belum ada data di wilayah ini.</div>';
            }
        }

        function renderProductGrid(products, container) {
            if(!products || products.length === 0) { container.innerHTML = '<div class="col-span-2 text-center text-gray-400 text-sm py-10">Tidak ada produk ditemukan.</div>'; return; }
            container.innerHTML = products.map(item => createProductCard(item, 'vertical')).join('');
        }

        function addToCartDirect(e, item) {
            e.stopPropagation(); 
            if (typeof item === 'string') { try { item = JSON.parse(decodeURIComponent(item)); } catch(err) { console.error(err); return; } }
            if (item.Variants && item.Variants.trim() !== "") { openProductDetail(item); } 
            else {
                const cartId = item.ID;
                const existing = cart.find(c => c.cartId === cartId);
                if (existing) { existing.qty += 1; } 
                else { cart.push({ ...item, cartId: cartId, variant: '', qty: 1 }); }
                updateCartBadge();
                const toast = document.createElement('div');
                toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black/80 text-white text-xs font-bold py-2 px-4 rounded-full shadow-lg z-[100] animate-bounce flex items-center gap-2 backdrop-blur';
                toast.innerHTML = `<i class="fas fa-check text-green-400"></i> ${item.Name} +1`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 1500);
            }
        }

        function createProductCard(item, type) {
            const priceVal = parseFloat(item.Price);
            const originalPriceVal = parseFloat(item.Original_Price);
            const price = new Intl.NumberFormat('id-ID').format(priceVal);
            const oriPrice = new Intl.NumberFormat('id-ID').format(originalPriceVal);
            let rawImgUrl = item.Image_URL && item.Image_URL.trim() !== '' ? item.Image_URL : 'https://placehold.co/200?text=No+Img';
            const imgUrl = convertDriveImage(rawImgUrl);
            const availability = item.Availability ? String(item.Availability) : '';
            const isHabis = availability.trim() === 'Habis';
            
            const itemString = encodeURIComponent(JSON.stringify(item));
            const clickAction = isHabis ? "" : `onclick='openProductDetail(JSON.parse(decodeURIComponent("${itemString}")))'`;
            
            const opacityClass = isHabis ? "opacity-60 grayscale cursor-not-allowed" : "cursor-pointer active:scale-[0.98]";
            const overlay = isHabis ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-xs text-white font-bold rounded-xl z-20">HABIS</div>' : '';
            
            // Hemat Logic
            const isHemat = originalPriceVal > priceVal;
            const saving = originalPriceVal - priceVal;
            // Tampilkan nominal hemat (misal: Hemat 5rb)
            const hematLabel = isHemat ? `<div class="absolute top-2 left-2 bg-red-600 text-white text-[9px] font-bold px-2 py-0.5 rounded-md z-10 shadow-sm border border-white">Hemat ${formatRupiahShort(saving)}</div>` : '';
            
            // Favorite Button Logic
            const isFav = favorites.has(String(item.ID));
            const favIconClass = isFav ? 'fas fa-heart text-red-500' : 'far fa-heart text-white';
            // Tombol love di pojok kiri bawah gambar
            const favBtn = isHabis ? '' : `<button onclick="toggleFavorite(event, '${item.ID}')" class="absolute bottom-2 left-2 z-20 w-7 h-7 bg-black/30 backdrop-blur-sm rounded-full flex items-center justify-center active:scale-90 transition hover:bg-black/50"><i class="${favIconClass} text-xs"></i></button>`;

            const addButton = isHabis ? '' : `
                <button onclick="addToCartDirect(event, '${itemString}')" class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 shadow-sm hover:bg-orange-200 active:scale-90 transition shrink-0">
                    <i class="fas fa-plus text-xs"></i>
                </button>
            `;

            if (type === 'horizontal') {
                return `
                <div class="product-card min-w-[320px] bg-white rounded-2xl p-2.5 shadow-sm border border-gray-100 flex gap-3 snap-center ${opacityClass} relative overflow-hidden" ${clickAction}>
                    <div class="w-32 h-32 bg-gray-100 rounded-xl overflow-hidden shrink-0 relative">
                        <img src="${imgUrl}" class="w-full h-full object-cover" loading="lazy" decoding="async">
                        ${overlay} ${hematLabel}
                        ${favBtn}
                    </div>
                    <div class="flex-1 flex flex-col justify-between min-w-0 py-1">
                        <div>
                            <div class="flex items-center gap-1 mb-1">
                                <i class="fas fa-store text-orange-500 text-[10px]"></i>
                                <span class="text-[10px] text-gray-600 truncate font-bold">${item.Vendor_Name}</span>
                            </div>
                            <h4 class="font-bold text-gray-800 text-sm leading-tight line-clamp-2">${item.Name}</h4>
                            <p class="text-[10px] text-gray-500 line-clamp-2 mt-1 leading-tight">${item.Description || 'Menu spesial.'}</p>
                        </div>
                        <div class="flex items-end justify-between mt-2">
                            <div class="flex flex-col items-start leading-none">
                                ${isHemat ? `<span class="text-[9px] text-gray-400 line-through mb-0.5">Rp${oriPrice}</span>` : ''}
                                <span class="text-orange-600 font-black text-base">Rp${price}</span>
                            </div>
                            ${addButton}
                        </div>
                    </div>
                </div>`;
            } else {
                // VERTIKAL GRID STYLE (Paling Laris)
                return `
                <div class="product-card w-full bg-white p-2.5 pb-3 rounded-2xl shadow-sm border border-gray-100 flex flex-col ${opacityClass} relative h-full overflow-hidden" ${clickAction}>
                    <div class="w-full h-44 bg-gray-100 rounded-xl overflow-hidden mb-2 relative">
                        <img src="${imgUrl}" class="w-full h-full object-cover" loading="lazy" decoding="async">
                        ${overlay} ${hematLabel}
                        ${favBtn}
                        ${!isHabis ? `<div class="absolute bottom-2 right-2 bg-white/90 px-1.5 rounded text-[9px] font-bold shadow-sm z-10"><i class="fas fa-star text-yellow-500 text-[8px]"></i> ${item.Rating || '4.8'}</div>` : ''}
                    </div>
                    
                    <div class="flex items-center gap-1 mb-1 w-full">
                        <i class="fas fa-store text-orange-500 text-[9px]"></i>
                        <span class="text-[9px] text-gray-600 font-bold truncate max-w-[100px]">${item.Vendor_Name}</span>
                    </div>
                    
                    <h4 class="font-bold text-gray-800 text-sm leading-tight line-clamp-2 mb-0.5 h-9">${item.Name}</h4>
                    
                    <!-- Deskripsi tambahan di kartu vertikal -->
                    <p class="text-[9px] text-gray-400 line-clamp-2 mt-0.5 mb-2 h-6 leading-tight">${item.Description || ''}</p>
                    
                    <div class="mt-auto pt-2 flex justify-between items-center border-t border-gray-50">
                        <div class="flex flex-col items-start leading-none">
                            ${isHemat ? `<span class="text-[9px] text-gray-400 line-through mb-0.5">Rp${oriPrice}</span>` : ''}
                            <span class="text-orange-600 font-black text-[13px] whitespace-nowrap">Rp${price}</span>
                        </div>
                        ${addButton}
                    </div>
                </div>`;
            }
        }

        // --- FUNGSI BARU: Render "Warung Sekitar" sebagai Feed Produk (Kartu Besar) ---
        function renderNearbyBigCards(vendors, products) {
            const container = document.getElementById('vendor-list');
            if (!userRegionPref) userRegionPref = 'Gombong';
            
            // 1. Filter Vendor based on Region
            const applicableVendors = vendors.filter(v => {
                const region = (v.Region || v.City || v.Alamat || v.Address || '').toLowerCase();
                const pref = userRegionPref.toLowerCase();
                if (pref.includes('gombong')) return region.includes('gombong');
                if (pref.includes('kebumen')) return region.includes('kebumen');
                return true; 
            });

            if(!applicableVendors || applicableVendors.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 text-xs py-8">Belum ada warung di ${userRegionPref}.</div>`;
                return;
            }

            // 2. Render Vendor Cards
            container.innerHTML = applicableVendors.map(vendor => {
                // Get products for this vendor to calculate price range
                const vProducts = products.filter(p => p.Vendor_Name === vendor.Vendor_Name);
                
                let priceRangeDisplay = "Harga belum tersedia";
                let isPromo = false;
                let lowestItem = null;

                if (vProducts.length > 0) {
                    // Sort by Price to find cheapest
                    vProducts.sort((a, b) => parseFloat(a.Price) - parseFloat(b.Price));
                    lowestItem = vProducts[0];
                    const minPrice = parseFloat(lowestItem.Price);
                    
                    // Check for promo in the lowest item
                    const lowestOri = parseFloat(lowestItem.Original_Price);
                    if (!isNaN(lowestOri) && lowestOri > minPrice) {
                        isPromo = true;
                        // Format: Rp 10rb (Asli 15rb)
                        priceRangeDisplay = `Mulai <span class="text-orange-600 font-bold">Rp${formatRupiahShort(minPrice)}</span> <span class="text-[10px] text-gray-400 line-through">Rp${formatRupiahShort(lowestOri)}</span>`;
                    } else {
                         priceRangeDisplay = `Mulai <span class="text-orange-600 font-bold">Rp${formatRupiahShort(minPrice)}</span>`;
                    }
                }

                const vendorImg = convertDriveImage(vendor.Image_URL);
                const rating = vendor.Rating || '4.8';
                // Randomize mock data for demo
                const distance = (Math.random() * (4.5 - 0.5) + 0.5).toFixed(1); // 0.5 - 5.0 km
                const time = Math.floor(Math.random() * (45 - 15) + 15); // 15 - 45 min

                return `
                <div class="bg-white rounded-3xl shadow-lg border border-gray-100 overflow-hidden mb-6 cursor-pointer active:scale-[0.99] transition group" onclick="openVendor('${vendor.ID}')">
                    <!-- Image Header -->
                    <div class="relative w-full h-48 bg-gray-200">
                        <img src="${vendorImg}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" loading="lazy">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                        
                        <!-- Rating Badge -->
                        <div class="absolute top-3 right-3 bg-white/90 backdrop-blur-sm px-2 py-1 rounded-lg flex items-center gap-1 shadow-sm">
                            <i class="fas fa-star text-yellow-400 text-xs"></i>
                            <span class="text-xs font-bold text-gray-800">${rating}</span>
                        </div>

                        <!-- Promo Badge if applicable -->
                        ${isPromo ? `<div class="absolute top-3 left-3 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-sm animate-pulse">Hemat Harga Asli</div>` : ''}

                        <div class="absolute bottom-3 left-3 right-3 text-white">
                            <h3 class="font-black text-xl leading-tight mb-1 shadow-black drop-shadow-md">${vendor.Vendor_Name}</h3>
                            <p class="text-[10px] opacity-90 font-medium">${vendor.Type || 'Aneka Kuliner'}</p>
                        </div>
                    </div>

                    <!-- Content Body -->
                    <div class="p-4">
                        <div class="flex items-center justify-between text-gray-600 text-xs font-medium mb-3">
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-1.5">
                                    <i class="fas fa-clock text-orange-500"></i>
                                    <span>${time} mnt</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <i class="fas fa-map-marker-alt text-orange-500"></i>
                                    <span>${distance} km</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-100 flex items-center justify-between">
                             <div class="flex flex-col">
                                <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Harga Makanan</span>
                                <div class="text-sm text-gray-800">${priceRangeDisplay}</div>
                             </div>
                             <div class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-400 group-hover:bg-orange-600 group-hover:text-white group-hover:border-orange-600 transition">
                                <i class="fas fa-arrow-right text-xs"></i>
                             </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function openVendor(vendorId) {
            const vendor = vendorsData.find(v => String(v.ID) === String(vendorId));
            if (!vendor) return;
            document.getElementById('vendor-banner-img').src = convertDriveImage(vendor.Image_URL);
            document.getElementById('vendor-name-title').innerText = vendor.Vendor_Name;
            
            const statusEl = document.getElementById('vendor-info-status');
            statusEl.innerText = vendor.Status || 'Buka';
            if(vendor.Status === 'Tutup') {
                statusEl.className = "bg-red-500/20 backdrop-blur-sm px-2 py-0.5 rounded text-[10px] font-medium border border-red-500/10 text-red-100";
            } else {
                statusEl.className = "bg-green-500/20 backdrop-blur-sm px-2 py-0.5 rounded text-[10px] font-medium border border-green-500/10 text-green-100";
            }
            document.getElementById('vendor-info-type').innerText = vendor.Type || 'Umum';
            document.getElementById('vendor-rating-badge').innerText = vendor.Rating || '4.5';
            
            const container = document.getElementById('vendor-menu-container');
            const vendorProducts = productsData.filter(p => p.Vendor_Name === vendor.Vendor_Name);
            renderProductGrid(vendorProducts, container);
            
            navTo('vendor-page');
            const page = document.getElementById('vendor-page');
            if(page) page.scrollTop = 0;
        }

        function openProductDetail(item) {
            currentDetailItem = item;
            currentDetailQty = 1;

            document.getElementById('detail-img').src = convertDriveImage(item.Image_URL);
            document.getElementById('detail-name').innerText = item.Name;
            document.getElementById('detail-price').innerText = "Rp " + new Intl.NumberFormat('id-ID').format(item.Price);
            
            if (item.Original_Price > item.Price) {
                document.getElementById('detail-ori-price').innerText = "Rp " + new Intl.NumberFormat('id-ID').format(item.Original_Price);
                document.getElementById('detail-ori-price').classList.remove('hidden');
            } else {
                document.getElementById('detail-ori-price').classList.add('hidden');
            }

            document.getElementById('detail-desc').innerText = item.Description || "Tidak ada deskripsi.";
            document.getElementById('detail-vendor').innerText = item.Vendor_Name;
            document.getElementById('detail-qty').innerText = "1";
            
            const vData = vendorsData.find(v => v.Vendor_Name === item.Vendor_Name);
            const vLink = document.getElementById('detail-vendor-link');
            if(vData) {
                vLink.onclick = () => openVendor(vData.ID);
            }

            const variantSection = document.getElementById('detail-variant-section');
            const variantContainer = document.getElementById('detail-variant-options');
            if (item.Variants && item.Variants.trim() !== "") {
                variantSection.classList.remove('hidden');
                const vars = item.Variants.split(',').map(v => v.trim());
                variantContainer.innerHTML = vars.map((v, i) => `
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-200 cursor-pointer active:bg-orange-50 transition">
                        <span class="text-sm font-medium text-gray-700">${v}</span>
                        <input type="radio" name="detail_prod_var" value="${v}" class="accent-orange-600 w-4 h-4" ${i===0 ? 'checked' : ''}>
                    </label>
                `).join('');
            } else {
                variantSection.classList.add('hidden');
                variantContainer.innerHTML = '';
            }

            renderReviews(item.ID);
            navTo('product-detail-page');
        }

        function adjustDetailQty(delta) {
            let newQty = currentDetailQty + delta;
            if(newQty < 1) newQty = 1;
            currentDetailQty = newQty;
            document.getElementById('detail-qty').innerText = newQty;
        }

        function addToCartFromDetail() {
            if(!currentDetailItem) return;
            
            let selectedVariant = null;
            const radios = document.getElementsByName('detail_prod_var');
            if (radios.length > 0) {
                for (const r of radios) { if (r.checked) { selectedVariant = r.value; break; } }
            }

            const item = currentDetailItem;
            const cartId = item.ID + (selectedVariant ? '-' + selectedVariant : '');
            const existing = cart.find(c => c.cartId === cartId);
            if (existing) { existing.qty += currentDetailQty; } 
            else { cart.push({ ...item, cartId: cartId, variant: selectedVariant || '', qty: currentDetailQty }); }
            
            updateCartBadge();
            handleBack(); 
        }

        function renderReviews(itemId) {
            const list = document.getElementById('detail-reviews-list');
            const reviews = productReviews[itemId] || [];
            
            let avg = 4.8; 
            if(reviews.length > 0) {
                const sum = reviews.reduce((acc, r) => acc + parseInt(r.rating), 0);
                avg = (sum / reviews.length).toFixed(1);
            }
            document.getElementById('detail-rating-avg').innerText = avg;
            document.getElementById('detail-review-count').innerText = reviews.length;

            if(reviews.length === 0) {
                list.innerHTML = `<div class="bg-gray-50 rounded-xl p-6 text-center text-gray-400 border border-gray-100 border-dashed"><i class="far fa-comment-dots text-3xl mb-2"></i><p class="text-xs">Belum ada ulasan. Jadilah yang pertama!</p></div>`;
                return;
            }

            list.innerHTML = reviews.map(r => `
                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                             <div class="w-6 h-6 rounded-full bg-gray-200 overflow-hidden"><img src="https://ui-avatars.com/api/?name=${encodeURIComponent(r.user)}&background=random" class="w-full h-full"></div>
                             <span class="text-xs font-bold text-gray-700">${r.user}</span>
                        </div>
                        <span class="text-[10px] text-gray-400">${r.date}</span>
                    </div>
                    <div class="flex text-yellow-400 text-[10px] mb-1">
                        ${[...Array(5)].map((_, i) => i < r.rating ? '<i class="fas fa-star"></i>' : '<i class="far fa-star text-gray-300"></i>').join('')}
                    </div>
                    <p class="text-xs text-gray-600 leading-snug">${r.text}</p>
                </div>
            `).join('');
        }

        function openReviewFormFromHistory(itemId, itemName) {
            document.getElementById('review-item-name').innerText = itemName;
            document.getElementById('review-item-id').value = itemId;
            const existingReviews = productReviews[itemId] || [];
            const myReview = existingReviews.find(r => r.user === userProfile.name);
            if (myReview) {
                document.getElementById('review-text').value = myReview.text;
                setRating(myReview.rating);
                document.getElementById('submit-review-btn-text').innerText = "Simpan Perubahan";
                document.getElementById('review-modal-title').innerText = "Edit Ulasanmu";
            } else {
                document.getElementById('review-text').value = '';
                setRating(0);
                document.getElementById('submit-review-btn-text').innerText = "Kirim Ulasan";
                document.getElementById('review-modal-title').innerText = "Bagaimana makanannya?";
            }
            document.getElementById('write-review-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('write-review-content').classList.remove('translate-y-full'), 10);
        }

        function closeReviewForm() {
            document.getElementById('write-review-content').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('write-review-modal').classList.add('hidden'), 300);
        }

        function setRating(val) {
            document.getElementById('review-rating-value').value = val;
            const stars = document.querySelectorAll('.review-star');
            stars.forEach((s, i) => {
                if(i < val) { s.classList.remove('text-gray-300'); s.classList.add('text-yellow-400'); } 
                else { s.classList.add('text-gray-300'); s.classList.remove('text-yellow-400'); }
            });
        }

        function submitReview() {
            const itemId = document.getElementById('review-item-id').value;
            const rating = document.getElementById('review-rating-value').value;
            const text = document.getElementById('review-text').value;

            if(!itemId) return; 
            if(rating == 0) { alert("Mohon berikan bintang!"); return; }
            if(!text) { alert("Mohon isi ulasanmu!"); return; }

            if(!productReviews[itemId]) productReviews[itemId] = [];
            const existingIndex = productReviews[itemId].findIndex(r => r.user === userProfile.name);
            const reviewData = { user: userProfile.name, rating: rating, text: text, date: new Date().toLocaleDateString('id-ID') };
            if (existingIndex > -1) { productReviews[itemId][existingIndex] = reviewData; alert("Ulasan berhasil diperbarui!"); } 
            else { productReviews[itemId].unshift(reviewData); if (productReviews[itemId].length > 50) productReviews[itemId].pop(); alert("Terima kasih atas ulasanmu!"); }
            safeStorage.setItem('pg_reviews', JSON.stringify(productReviews));
            renderOrderHistory(); 
            closeReviewForm();
        }

        function updateCartBadge() {
            const count = cart.reduce((sum, i) => sum + i.qty, 0);
            const badge = document.getElementById('cart-badge-nav');
            if(count > 0) { badge.innerText = count; badge.classList.remove('hidden'); } 
            else { badge.classList.add('hidden'); }
        }

        function renderCartPage() {
            const container = document.getElementById('cart-items-container');
            const form = document.getElementById('checkout-form-container');
            const summaryArea = document.getElementById('cart-summary-area');

            if(cart.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-gray-400"><i class="fas fa-shopping-basket text-4xl mb-3 text-gray-300"></i><p>Keranjang kosong</p></div>`;
                form.classList.add('hidden');
            } else {
                form.classList.remove('hidden');
                let total = 0;
                let totalOriginal = 0;
                
                const grouped = {};
                cart.forEach(item => {
                    if(!grouped[item.Vendor_Name]) grouped[item.Vendor_Name] = [];
                    grouped[item.Vendor_Name].push(item);
                    
                    const priceVal = parseFloat(item.Price);
                    const originalPriceVal = parseFloat(item.Original_Price);
                    const itemOriginalPrice = (!isNaN(originalPriceVal) && originalPriceVal > priceVal) ? originalPriceVal : priceVal;

                    total += (priceVal * item.qty);
                    totalOriginal += (itemOriginalPrice * item.qty);
                });

                let html = '';
                if(Object.keys(grouped).length > 1) {
                    html += `<div class="bg-yellow-50 border border-yellow-200 p-3 rounded-2xl mb-3 flex items-start gap-2"><i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5 text-xs"></i><p class="text-[11px] text-yellow-700 leading-tight">Pesan lebih dari 1 penjual, ada tambahan sedikit ongkir.</p></div>`;
                }

                for(const [vendor, items] of Object.entries(grouped)) {
                    html += `<div class="bg-white rounded-2xl p-4 border border-gray-100 mb-3 shadow-sm"><div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-100"><i class="fas fa-store text-orange-600 text-sm"></i><h4 class="font-bold text-sm text-gray-800">${vendor}</h4></div>`;
                    items.forEach(item => {
                         const priceVal = parseFloat(item.Price);
                         const originalPriceVal = parseFloat(item.Original_Price);
                         const isHemat = originalPriceVal > priceVal;
                         const imgUrl = convertDriveImage(item.Image_URL);

                        html += `
                        <div class="flex justify-between items-start mb-3 last:mb-0">
                            <div class="flex gap-3 items-center flex-1">
                                <div class="w-12 h-12 rounded-xl bg-gray-200 overflow-hidden shrink-0"><img src="${imgUrl}" class="w-full h-full object-cover" loading="lazy" decoding="async"></div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-bold text-gray-800 line-clamp-1">${item.Name}</p>
                                    ${item.variant ? `<p class="text-[10px] text-gray-500 mb-1">Varian: ${item.variant}</p>` : ''}
                                    <div class="flex gap-2 items-center">
                                        <div class="flex flex-col items-start">
                                            ${isHemat ? `<span class="text-[9px] text-gray-400 line-through">${formatRupiah(originalPriceVal)}</span>` : ''}
                                            <span class="text-xs text-orange-600 font-bold">${formatRupiah(priceVal)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 bg-gray-50 rounded-lg px-2 py-1 border border-gray-200">
                                <button onclick="updateQty('${item.cartId}', -1)" class="text-gray-500 font-bold w-4 text-center">-</button>
                                <span class="text-xs font-bold w-4 text-center">${item.qty}</span>
                                <button onclick="updateQty('${item.cartId}', 1)" class="text-green-600 font-bold w-4 text-center">+</button>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                }
                container.innerHTML = html;
                
                const savings = totalOriginal - total;
                const summaryHtml = `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-3">
                        <!-- Baris 1: Markup Info (Tanpa Label Warna) -->
                        <div class="flex justify-between items-center text-xs text-gray-500 font-medium">
                            <span>PROJEKGO tidak markup harga</span>
                            <span class="text-gray-400 line-through">${formatRupiah(totalOriginal)}</span>
                        </div>
                        
                        <!-- Baris 2: Biaya App -->
                        <div class="flex justify-between items-center text-xs text-gray-600 font-medium">
                            <span>Biaya Aplikasi</span>
                            <div class="flex items-center gap-1"><span class="text-[9px] bg-green-100 text-green-600 px-1.5 py-0.5 rounded font-bold">Gratis</span> <span>Rp 0</span></div>
                        </div>
                        
                        <div class="border-t border-dashed border-gray-200 my-2"></div>
                        
                        <!-- Baris 3: Total Harga -->
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-gray-800 text-sm">Total harga makanan</span>
                            <div class="text-right flex flex-col items-end">
                                <span class="text-xl font-black text-orange-600 leading-none">${formatRupiah(total)}</span>
                                <span class="text-[10px] text-gray-400 font-medium mt-1">Harga Asli</span>
                            </div>
                        </div>
                        
                        ${savings > 0 ? `<div class="flex justify-end"><span class="text-[10px] bg-red-50 text-red-600 px-2 py-1 rounded-lg font-bold">Anda lebih hemat ${formatRupiah(savings)}</span></div>` : ''}
                        
                        <!-- INFO ONGKIR -->
                        <div class="bg-blue-50 border border-blue-100 p-3 rounded-xl mt-2 flex gap-2 items-start">
                            <i class="fas fa-info-circle text-blue-500 mt-0.5 text-xs"></i>
                            <p class="text-[10px] text-blue-800 font-medium leading-tight">
                                Ongkir nanti akan diinfokan oleh admin (ongkir prioritas, pasti lebih hemat).
                            </p>
                        </div>

                        <button onclick="checkoutToWA()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all active:scale-[0.98] mt-2">
                            <i class="fab fa-whatsapp text-xl"></i> Pesan via WhatsApp
                        </button>
                    </div>
                `;
                summaryArea.innerHTML = summaryHtml;
            }
        }

        function updateQty(id, delta) {
            const idx = cart.findIndex(c => c.cartId === id);
            if(idx !== -1) {
                cart[idx].qty += delta;
                if(cart[idx].qty <= 0) cart.splice(idx, 1);
                updateCartBadge();
                renderCartPage();
            }
        }

        function checkoutToWA() {
            if(cart.length === 0) return;
            const address = document.getElementById('checkout-address').value.trim();
            const orderNote = document.getElementById('checkout-note').value.trim();
            
            if(!address) { 
                alert("Mohon isi alamat lengkap pengantaran!"); 
                document.getElementById('checkout-address').focus();
                return; 
            }
            
            const phone = "6281292802623";
            
            // === FORMAT PESANAN BARU (LEBIH RAPI & TANPA EMOT) ===
            let msg = `Halo Admin, saya mau pesan:\n\n`;
            let grandTotal = 0;
            const grouped = {};
            
            const orderItemsDetail = cart.map(c => ({
                id: c.ID,
                name: c.Name,
                price: c.Price,
                qty: c.qty,
                variant: c.variant || '',
                image: c.Image_URL
            }));

            cart.forEach(item => {
                if(!grouped[item.Vendor_Name]) grouped[item.Vendor_Name] = [];
                grouped[item.Vendor_Name].push(item);
                grandTotal += (item.Price * item.qty);
            });

            for(const [vendor, items] of Object.entries(grouped)) {
                // Header Warung
                msg += `[ ${vendor.toUpperCase()} ]\n`; 
                
                items.forEach(i => {
                    // Format harga: 15.000
                    const priceFormatted = new Intl.NumberFormat('id-ID').format(i.Price);
                    // Format item: 2x Nasi Goreng (Pedas) @ 15.000
                    msg += `${i.qty}x ${i.Name} ${i.variant ? `(${i.variant})` : ''} @ ${priceFormatted}\n`;
                });
                
                // Garis Pemisah
                msg += `--------------------------------\n`; 
            }
            
            msg += `\n*Total Harga Makanan: Rp ${new Intl.NumberFormat('id-ID').format(grandTotal)}*\n\n`;
            msg += `*Alamat Pengantaran:*\n${address}\n\n`;
            
            if(orderNote) {
                msg += `*Catatan:*\n${orderNote}\n\n`;
            } else {
                // Tambahan baris kosong jika tidak ada catatan agar rapi
                // msg += `\n`; 
            }
            
            msg += `Mohon info ongkirnya. Terima kasih.`;
            // ======================================================

            const waUrl = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            
            // --- FIX FOR MOBILE REDIRECT ---
            // Deteksi apakah user menggunakan mobile atau desktop
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            // Simpan Order History & Kosongkan Keranjang DULUAN
            // (Agar data tersimpan meskipun redirect browser menghentikan eksekusi script selanjutnya)
            const newOrder = {
                id: `ORD-${Date.now()}`,
                date: new Date().toLocaleDateString('id-ID'),
                total: grandTotal,
                status: 'Menunggu Konfirmasi WA',
                items: cart.length,
                itemsDetail: orderItemsDetail 
            };
            orderHistory.unshift(newOrder);
            safeStorage.setItem('pg_orders', JSON.stringify(orderHistory));
            
            cart = []; 
            updateCartBadge();
            renderCartPage();
            renderOrderHistory();

            // Redirect ke WhatsApp
            // window.location.href lebih kuat di Mobile untuk memicu "Deep Link" (membuka aplikasi WA)
            // window.open lebih baik di Desktop (tab baru)
            if (isMobile) {
                window.location.href = waUrl;
            } else {
                window.open(waUrl, '_blank');
            }
        }

        function updatePointsUI() {
            document.getElementById('point-display-count').innerText = userPoints;
            const percentage = Math.min((userPoints / 10) * 100, 100);
            document.getElementById('point-progress-bar').style.width = `${percentage}%`;
            const btn = document.getElementById('btn-redeem-point');
            if(userPoints >= 10) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-orange-600', 'text-white', 'shadow-lg');
                btn.innerText = "Tukar Sekarang!";
                document.getElementById('point-target-text').innerText = "Siap Ditukar!";
            } else {
                btn.disabled = true;
                btn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                btn.classList.remove('bg-orange-600', 'text-white', 'shadow-lg');
                btn.innerText = `Kurang ${10 - userPoints} Poin lagi`;
                document.getElementById('point-target-text').innerText = `Target: 10 Poin`;
            }
        }

        function claimPointCode() {
            const input = document.getElementById('claim-code-input');
            const code = input.value.trim().toUpperCase();
            if(!code) return;
            if(VALID_POINT_CODES.includes(code)) {
                if(claimedCodes.includes(code)) {
                    alert("Kode ini sudah pernah kamu gunakan!");
                } else {
                    userPoints += 1;
                    claimedCodes.push(code);
                    safeStorage.setItem('pg_points', userPoints);
                    safeStorage.setItem('pg_claimed_codes', JSON.stringify(claimedCodes));
                    updatePointsUI();
                    alert("Selamat! Poin berhasil ditambahkan.");
                    input.value = "";
                }
            } else {
                alert("Kode Voucher tidak valid. Pastikan kode benar dari admin.");
            }
        }

        function redeemPoints() {
            if(userPoints >= 10) {
                if(confirm("Tukarkan 10 Poin dengan Gratis Ongkir?")) {
                    userPoints -= 10;
                    safeStorage.setItem('pg_points', userPoints);
                    updatePointsUI();
                    alert("Berhasil! Tunjukkan screenshot ini ke admin saat memesan untuk klaim gratis ongkir.");
                }
            }
        }
        
        function renderOrderHistory() {
            const container = document.getElementById('order-history-container');
            if(orderHistory.length === 0) {
                 container.innerHTML = `<div class="text-center text-gray-400 mt-10 text-xs">Belum ada pesanan. Pesan dulu yuk!</div>`;
                 return;
            }
            container.innerHTML = orderHistory.map(o => {
                let itemsHtml = '';
                if(o.itemsDetail && o.itemsDetail.length > 0) {
                    itemsHtml = '<div class="mt-3 space-y-2 border-t border-gray-100 pt-2">';
                    o.itemsDetail.forEach(item => {
                        const hasReviewed = (productReviews[item.id] || []).some(r => r.user === userProfile.name);
                        const btnText = hasReviewed ? "Edit Ulasan" : "Beri Ulasan";
                        const btnClass = hasReviewed 
                            ? "bg-gray-100 text-gray-600 border border-gray-300" 
                            : "bg-orange-50 text-orange-600 border border-orange-200";

                        itemsHtml += `
                            <div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                                <div class="flex items-center gap-2 overflow-hidden">
                                     <div class="w-8 h-8 bg-white rounded-md shrink-0"><img src="${convertDriveImage(item.image)}" class="w-full h-full object-cover rounded-md"></div>
                                     <div class="min-w-0">
                                        <p class="text-xs font-bold text-gray-700 truncate">${item.name}</p>
                                        <p class="text-[9px] text-gray-500">${item.qty}x</p>
                                     </div>
                                </div>
                                <button onclick="openReviewFormFromHistory('${item.id}', '${item.name.replace(/'/g, "\\'")}')" class="${btnClass} text-[10px] font-bold px-3 py-1.5 rounded-full shadow-sm hover:brightness-95 active:scale-95 transition">
                                    ${btnText}
                                </button>
                            </div>
                        `;
                    });
                    itemsHtml += '</div>';
                }

                return `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-3">
                    <div class="flex justify-between items-center mb-1">
                         <p class="text-[10px] text-gray-400">${o.date}  ${o.id}</p>
                         <span class="text-[10px] px-2 py-0.5 rounded bg-yellow-100 text-yellow-700 font-bold">${o.status}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-gray-800 text-sm">Total Belanja</h4>
                        <p class="text-orange-600 font-black text-sm">Rp ${new Intl.NumberFormat('id-ID').format(o.total)}</p>
                    </div>
                    ${itemsHtml}
                </div>
            `}).join('');
        }

        function openPartnershipModal() { document.getElementById('partnership-modal').classList.remove('hidden'); }
        function closePartnershipModal() { document.getElementById('partnership-modal').classList.add('hidden'); }
        function openSellerRegistration() { closePartnershipModal(); document.getElementById('seller-register-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('seller-register-content').classList.remove('translate-y-full'), 10); }
        function closeSellerRegistration() { document.getElementById('seller-register-content').classList.add('translate-y-full'); setTimeout(() => document.getElementById('seller-register-modal').classList.add('hidden'), 300); }
        
        function updateProfileUI() { document.getElementById('profile-name-text').innerText = userProfile.name; document.getElementById('profile-phone-text').innerText = userProfile.phone; document.getElementById('profile-avatar-img').src = userProfile.avatar; }
        function openEditProfile() { document.getElementById('edit-name-input').value = userProfile.name; document.getElementById('edit-phone-input').value = userProfile.phone; document.getElementById('edit-profile-modal').classList.remove('hidden'); }
        function closeEditProfile() { document.getElementById('edit-profile-modal').classList.add('hidden'); }
        function saveProfile() { const newName = document.getElementById('edit-name-input').value; const newPhone = document.getElementById('edit-phone-input').value; if (newName && newPhone) { userProfile.name = newName; userProfile.phone = newPhone; userProfile.avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(newName)}&background=random`; updateProfileUI(); closeEditProfile(); } }
        
        function openFavoritesPage(navigate = true) { if (navigate) navTo('category-page'); document.getElementById('cat-page-title').innerText = 'Makanan Favorit'; const container = document.getElementById('category-content-container'); const favProducts = productsData.filter(p => favorites.has(String(p.ID))); if (favProducts.length === 0) { container.innerHTML = '<div class="col-span-2 text-center text-gray-400 mt-10"><i class="far fa-heart text-4xl mb-2"></i><p>Belum ada makanan favorit.</p></div>'; } else { renderProductGrid(favProducts, container); } }
        function openAddressModal() { renderAddressList(); document.getElementById('address-modal').classList.remove('hidden'); }
        function closeAddressModal() { document.getElementById('address-modal').classList.add('hidden'); }
        function renderAddressList() { const container = document.getElementById('address-list-container'); container.innerHTML = savedAddresses.map(addr => `<div class="bg-white p-3 rounded-2xl border border-gray-200 flex justify-between items-center cursor-pointer hover:border-orange-500 group" onclick="selectAddress('${addr.detail}')"><div><span class="text-xs font-bold bg-gray-100 text-gray-600 px-2 py-0.5 rounded mb-1 inline-block">${addr.label}</span><p class="text-sm text-gray-800 leading-tight">${addr.detail}</p></div><button onclick="event.stopPropagation(); deleteAddress(${addr.id})" class="text-gray-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button></div>`).join(''); }
        function deleteAddress(id) { if (confirm('Hapus alamat ini?')) { savedAddresses = savedAddresses.filter(a => a.id !== id); renderAddressList(); } }
        function openAddAddressModal() { const modal = document.getElementById('add-address-modal'); const content = document.getElementById('add-address-content'); document.getElementById('new-addr-detail').value = ''; document.getElementById('new-addr-note').value = ''; setAddressLabel('Rumah'); modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('translate-y-full'); }, 10); }
        function closeAddAddressModal() { const modal = document.getElementById('add-address-modal'); const content = document.getElementById('add-address-content'); content.classList.add('translate-y-full'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }
        function setAddressLabel(label) { document.getElementById('new-addr-label').value = label; document.querySelectorAll('.addr-label-btn').forEach(btn => { if(btn.innerText === label) { btn.classList.add('border-orange-500', 'bg-orange-50', 'text-orange-600'); btn.classList.remove('border-gray-200', 'text-gray-600'); } else { btn.classList.remove('border-orange-500', 'bg-orange-50', 'text-orange-600'); btn.classList.add('border-gray-200', 'text-gray-600'); } }); }
        function saveNewAddress() { const label = document.getElementById('new-addr-label').value; const detail = document.getElementById('new-addr-detail').value; const note = document.getElementById('new-addr-note').value; if (!detail) { const input = document.getElementById('new-addr-detail'); input.classList.add('border-red-500', 'animate-pulse'); setTimeout(() => input.classList.remove('border-red-500', 'animate-pulse'), 1000); return; } const finalDetail = note ? `${detail} (${note})` : detail; savedAddresses.push({ id: Date.now(), label: label || "Alamat", detail: finalDetail }); renderAddressList(); closeAddAddressModal(); const toast = document.createElement('div'); toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs font-bold py-2 px-4 rounded-full shadow-lg z-[95] animate-bounce flex items-center'; toast.innerHTML = `<i class="fas fa-check-circle mr-2 text-green-400"></i> Alamat Berhasil Disimpan`; document.body.appendChild(toast); setTimeout(() => toast.remove(), 2000); }
        function selectAddress(detail) { document.getElementById('header-address-text').innerText = detail; closeAddressModal(); }
        function formatRupiah(number) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumSignificantDigits: 3 }).format(number); }

        function navTo(pageId) {
            document.querySelectorAll('.page-section').forEach(el => {
                if(el.id !== pageId) { el.classList.add('hidden-page'); el.classList.remove('z-30'); }
            });
            const target = document.getElementById(pageId);
            if(target) {
                target.classList.remove('hidden-page'); target.classList.add('z-30');
                const scroller = target.querySelector('.scrolling-wrapper');
                if (scroller) scroller.scrollTop = 0;
            }

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active');
                el.querySelector('i').classList.replace('text-orange-600', 'text-gray-400');
                el.querySelector('span').classList.remove('font-bold', 'text-orange-600');
            });
            let activeNav;
            if(pageId === 'home-page') activeNav = document.getElementById('nav-home');
            else if(pageId === 'points-page') activeNav = document.getElementById('nav-points');
            else if(pageId === 'orders-page') activeNav = document.getElementById('nav-orders');
            else if(pageId === 'profile-page') activeNav = document.getElementById('nav-profile');
            if(activeNav) {
                activeNav.classList.add('active');
                activeNav.querySelector('i').classList.replace('text-orange-600', 'text-orange-600'); 
                activeNav.querySelector('span').classList.add('font-bold', 'text-orange-600');
            }
        }
        
        function handleBack() {
            const detailPage = document.getElementById('product-detail-page');
            if (!detailPage.classList.contains('hidden-page')) { navTo('home-page'); return; }
            navTo('home-page');
        }

        function openExclusivePage() {
            navTo('exclusive-page');
            const container = document.getElementById('exclusive-content-container');
            container.innerHTML = '<div class="col-span-2 text-center py-10"><i class="fas fa-spinner fa-spin text-orange-500"></i> Memuat...</div>';
            setTimeout(() => {
                const applicableProducts = getAppplicableProducts();
                const exclusiveProducts = applicableProducts.filter(p => String(p.Is_Exclusive || p.Exclusive || 'false').toLowerCase() === 'true');
                if (exclusiveProducts.length === 0) { container.innerHTML = '<div class="col-span-2 text-center text-gray-400 mt-10">Belum ada menu eksklusif saat ini.</div>'; return; }
                renderProductGrid(exclusiveProducts, container);
            }, 300);
        }

        function openCategory(catId, catName) { 
            navTo('category-page'); 
            document.getElementById('cat-page-title').innerText = catName; 
            const container = document.getElementById('category-content-container'); 
            container.innerHTML = '<div class="col-span-2 text-center py-10"><i class="fas fa-spinner fa-spin text-orange-500"></i> Memuat...</div>'; 
            
            setTimeout(() => { 
                const applicableProducts = getAppplicableProducts();
                let filteredProducts;
                if (catId === 'all') {
                    filteredProducts = applicableProducts;
                } else {
                    filteredProducts = applicableProducts.filter(p => {
                        let pCat = p.Category || p.category || p.Kategori || p.kategori || '';
                        if(!pCat) {
                            const keys = Object.keys(p);
                            const fuzzyKey = keys.find(k => k.toLowerCase().includes('category') || k.toLowerCase().includes('kategori'));
                            if (fuzzyKey) pCat = p[fuzzyKey];
                        }
                        return String(pCat).trim().toLowerCase() === String(catId).trim().toLowerCase();
                    });
                }
                if (filteredProducts.length === 0) { 
                    container.innerHTML = `<div class="col-span-2 text-center text-gray-400 mt-10 px-4"><i class="far fa-folder-open text-4xl mb-2 text-gray-300"></i><p class="font-bold text-gray-600">Tidak ada produk ditemukan di ${userRegionPref}.</p></div>`; 
                    return; 
                } 

                const vendorMap = {};
                filteredProducts.forEach(product => {
                    if (!vendorMap[product.Vendor_Name]) { vendorMap[product.Vendor_Name] = []; }
                    vendorMap[product.Vendor_Name].push(product);
                });

                let html = '';
                for (const [vName, items] of Object.entries(vendorMap)) {
                    const vInfo = vendorsData.find(v => v.Vendor_Name === vName);
                    const vImage = vInfo ? convertDriveImage(vInfo.Image_URL) : 'https://placehold.co/100?text=Warung';
                    const vRating = vInfo ? vInfo.Rating : '4.8';
                    const vId = vInfo ? vInfo.ID : '';

                    const productsHtml = items.map(item => {
                        const priceVal = parseFloat(item.Price);
                        const price = new Intl.NumberFormat('id-ID').format(priceVal);
                        const imgUrl = convertDriveImage(item.Image_URL);
                        const itemString = encodeURIComponent(JSON.stringify(item));
                        return `
                        <div class="min-w-[120px] w-32 snap-center flex flex-col bg-white rounded-xl overflow-hidden border border-gray-100 shadow-sm" onclick='openProductDetail(JSON.parse(decodeURIComponent("${itemString}")))' style="flex-shrink: 0;">
                            <div class="h-24 w-full bg-gray-100 relative">
                                <img src="${imgUrl}" class="w-full h-full object-cover" loading="lazy">
                            </div>
                            <div class="p-2 flex flex-col flex-1">
                                <h4 class="text-[10px] font-bold text-gray-800 line-clamp-2 leading-tight mb-1 h-7">${item.Name}</h4>
                                <div class="mt-auto pt-1 flex justify-between items-end">
                                    <span class="text-[10px] font-bold text-orange-600">Rp${price}</span>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');

                    html += `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-50 cursor-pointer" onclick="openVendor('${vId}')">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden border border-gray-100">
                                    <img src="${vImage}" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <h3 class="font-bold text-sm text-gray-800 flex items-center gap-1">
                                        ${vName} <i class="fas fa-chevron-right text-[10px] text-gray-400"></i>
                                    </h3>
                                    <div class="flex items-center gap-2 text-[10px] text-gray-500">
                                        <span class="flex items-center gap-0.5 text-yellow-500 font-bold"><i class="fas fa-star text-[8px]"></i> ${vRating}</span>
                                        <span></span>
                                        <span>Tap untuk detail</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-1 snap-x">
                            ${productsHtml}
                        </div>
                    </div>
                    `;
                }
                container.className = "space-y-2 pb-24 optimized-list";
                container.innerHTML = html;
            }, 300); 
        }

        function submitRegistration(type) {
            let payload = { action: 'register', type: type };
            if (type === 'Mitra Penjual') {
                const name = document.getElementById('reg-seller-name').value;
                const phone = document.getElementById('reg-seller-phone').value;
                const bizName = document.getElementById('reg-seller-biz').value;
                const category = document.getElementById('reg-seller-cat').value;
                const region = document.getElementById('reg-seller-region').value; 
                const address = document.getElementById('reg-seller-addr').value;
                if (!name || !bizName || !region) { alert("Harap isi semua data wajib (termasuk Area Operasional)!"); return; }
                payload.name = name; payload.phone = phone; payload.bizName = bizName; payload.category = category; payload.region = region; payload.address = address;
            }
            const modalId = 'seller-register-modal'; const contentId = 'seller-register-content';
            document.getElementById(contentId).classList.add('translate-y-full');
            setTimeout(() => document.getElementById(modalId).classList.add('hidden'), 300);
            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(response => { alert(`Pendaftaran ${type} Berhasil dikirim!`); })
            .catch(error => { console.error("Error:", error); alert("Gagal Mengirim (Cek Koneksi)"); });
        }
    </script>
</body>
</html>
