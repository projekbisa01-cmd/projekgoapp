<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Pusat - Projekgo</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --primary: #FF6600;
            --dark: #1A1A1A;
            --bg: #F8F9FB;
            --white: #ffffff;
            --gray: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            --nav-height: 75px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; 
            background: var(--bg); 
            color: var(--dark);
            padding-bottom: var(--nav-height); 
        }

        /* LOGIN SCREEN */
        #login-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 10001; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 24px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .login-input { width: 100%; padding: 15px; border: 1.5px solid #eee; border-radius: 12px; margin: 20px 0; font-size: 16px; outline: none; transition: 0.3s; text-align: center; }
        .login-input:focus { border-color: var(--primary); }
        .btn-login { width: 100%; padding: 15px; background: var(--dark); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 16px; }

        /* HEADER */
        .top-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 900;
            border-bottom: 1px solid #eee;
        }
        .brand-mobile { font-size: 20px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .btn-logout-top { background: #f1f5f9; border: none; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--danger); cursor: pointer; }

        /* MAIN CONTENT */
        .main-content { padding: 20px; max-width: 800px; margin: 0 auto; }
        .page-header { margin-bottom: 25px; }
        .page-title { font-size: 22px; font-weight: 800; margin: 0; color: var(--dark); }
        .page-subtitle { font-size: 14px; color: var(--gray); margin-top: 5px; }
        
        /* BOTTOM NAVIGATION */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #eee;
            padding: 0 5px;
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--gray);
            text-decoration: none;
            flex: 1;
            padding: 10px 0;
            cursor: pointer;
            transition: 0.2s;
        }
        .nav-item i { font-size: 22px; }
        .nav-item span { font-size: 10px; font-weight: 600; }
        .nav-item.active { color: var(--primary); }

        /* CARDS & STATS */
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 20px; display: flex; align-items: center; gap: 15px; border: 1px solid #f0f0f0; }
        .stat-icon { width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stat-info div { font-size: 13px; color: var(--gray); }
        .stat-info span { font-size: 20px; font-weight: 800; }

        .data-card { background: white; border-radius: 20px; border: 1px solid #f0f0f0; overflow: hidden; margin-bottom: 20px; }
        .card-header { padding: 18px 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 16px; }
        
        /* TABLES */
        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { background: #f8fafc; padding: 12px 20px; text-align: left; font-size: 11px; color: var(--gray); text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 16px 20px; border-bottom: 1px solid #f8fafc; font-size: 14px; }

        /* BUTTONS */
        .btn-add-float { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; border-radius: 18px; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 25px rgba(255, 102, 0, 0.3); z-index: 800; }
        .btn-status { padding: 6px 12px; border-radius: 10px; font-weight: 700; font-size: 11px; border: none; cursor: pointer; }
        .btn-status.open { background: #ecfdf5; color: var(--success); }
        .btn-status.closed { background: #fef2f2; color: var(--danger); }
        .action-btn { width: 36px; height: 36px; border-radius: 8px; border: none; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .action-btn:active { transform: scale(0.9); }
        .btn-delete { background: #fef2f2; color: var(--danger); }
        .btn-view { background: #eff6ff; color: #2563eb; }
        .btn-edit-pin { background: #e0f2fe; color: #0284c7; }
        
        /* Style baru untuk tombol Exclusive */
        .btn-exclusive { background: #f3f4f6; color: #9ca3af; }
        .btn-exclusive.active { background: #ede9fe; color: #7c3aed; }

        /* REVIEW COMPONENTS */
        .rating-badge { display: inline-flex; align-items: center; gap: 4px; background: #fffbeb; color: #d97706; padding: 4px 10px; border-radius: 8px; font-weight: 800; font-size: 13px; }
        .review-item { padding: 15px 20px; border-bottom: 1px solid #f8fafc; }
        .review-user { font-weight: 700; font-size: 14px; display: flex; justify-content: space-between; margin-bottom: 4px; }
        .review-date { font-size: 11px; color: var(--gray); font-weight: 400; }
        .review-stars { color: var(--warning); font-size: 12px; margin-bottom: 8px; }
        .review-comment { font-size: 14px; line-height: 1.5; color: #4b5563; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10002; align-items: flex-end; justify-content: center; }
        .modal-box { background: white; padding: 30px; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: var(--gray); }
        .form-input, textarea { width: 100%; padding: 12px; border: 1.5px solid #eee; border-radius: 12px; font-family: inherit; font-size: 15px; outline: none; }
        .modal-actions { display: flex; gap: 12px; margin-top: 25px; }
        .btn-modal { flex: 1; padding: 14px; border-radius: 12px; font-weight: 700; border: none; cursor: pointer; }

        /* BADGE */
        .unique-badge {
            background-color: #E3F2FD;
            color: #1976D2;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 5px;
            display: inline-block;
        }

        /* PAGE VISIBILITY */
        .page-content { display: none; }
        .page-content.active { display: block; }

        @media (min-width: 640px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay">
        <div class="login-box">
            <i class="ph-fill ph-rocket" style="font-size: 48px; color: var(--primary);"></i>
            <h2 style="margin: 15px 0 5px;">Admin Pusat</h2>
            <p style="color:var(--gray); font-size:14px;">Dashboard Manajemen Projekgo</p>
            <input type="password" id="admin-pass" class="login-input" placeholder="Masukkan Password">
            <button class="btn-login" onclick="checkLogin()">Masuk Sekarang</button>
        </div>
    </div>

    <!-- TOP HEADER -->
    <div class="top-header">
        <div class="brand-mobile">
            <i class="ph-fill ph-rocket"></i>
            <span>Projekgo</span>
        </div>
        <button class="btn-logout-top" onclick="logout()" title="Keluar">
            <i class="ph-bold ph-sign-out"></i>
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        
        <!-- DASHBOARD PAGE -->
        <div id="page-dashboard" class="page-content active">
            <div class="page-header">
                <h1 class="page-title">Ringkasan</h1>
                <p class="page-subtitle">Performa ekosistem hari ini</p>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background:#fff7ed; color:#ea580c;"><i class="ph-fill ph-storefront"></i></div>
                    <div class="stat-info"><div>Mitra</div><span id="count-vendors">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#eff6ff; color:#2563eb;"><i class="ph-fill ph-bowl-food"></i></div>
                    <div class="stat-info"><div>Menu</div><span id="count-products">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#fffbeb; color:#d97706;"><i class="ph-fill ph-star"></i></div>
                    <div class="stat-info"><div>Avg Rating</div><span id="global-rating">4.8</span></div>
                </div>
            </div>
            <div class="data-card">
                <div class="card-header">Mitra Aktif</div>
                <div class="table-responsive">
                    <table id="recent-vendors-table"></table>
                </div>
            </div>
        </div>

        <!-- VENDORS PAGE -->
        <div id="page-vendors" class="page-content">
            <div class="page-header">
                <h1 class="page-title">Daftar Mitra</h1>
                <p class="page-subtitle">Kelola status operasional mitra</p>
            </div>
            <div class="data-card">
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Warung & Akses</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody id="vendor-list-body"></tbody>
                    </table>
                </div>
            </div>
            <button class="btn-add-float" onclick="openAddModal()"><i class="ph-bold ph-plus"></i></button>
        </div>

        <!-- PRODUCTS PAGE -->
        <div id="page-products" class="page-content">
            <div class="page-header">
                <h1 class="page-title">Katalog Menu</h1>
                <p class="page-subtitle">Kontrol stok menu per mitra</p>
            </div>
            
            <div id="menu-vendor-list-view">
                <div class="data-card">
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Mitra</th><th>Menu</th><th>Aksi</th></tr></thead>
                            <tbody id="menu-vendor-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="menu-detail-view" style="display:none;">
                <button class="btn-status" style="margin-bottom:15px; background:#eee; color:#555;" onclick="showMenuVendorList()">
                    <i class="ph ph-arrow-left"></i> Kembali
                </button>
                <h3 id="detail-vendor-name" style="margin-bottom:15px;"></h3>
                <div class="data-card">
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Menu</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr></thead>
                            <tbody id="detail-product-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- REVIEWS PAGE -->
        <div id="page-reviews" class="page-content">
            <div class="page-header">
                <h1 class="page-title">Ulasan Mitra</h1>
                <p class="page-subtitle">Pantau feedback dari pelanggan</p>
            </div>
            
            <div id="review-vendor-list">
                <div class="data-card">
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Mitra</th><th>Rating</th><th>Aksi</th></tr></thead>
                            <tbody id="review-vendor-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="review-detail-view" style="display:none;">
                <button class="btn-status" style="margin-bottom:15px; background:#eee; color:#555;" onclick="showReviewList()">
                    <i class="ph ph-arrow-left"></i> Kembali
                </button>
                <div class="stat-card" style="margin-bottom: 20px;">
                    <div id="rev-detail-icon" class="stat-icon" style="background:#fffbeb; color:#d97706;"><i class="ph-fill ph-star"></i></div>
                    <div class="stat-info">
                        <div id="rev-detail-vendor-name" style="font-weight:700; color:var(--dark);">Nama Warung</div>
                        <span id="rev-detail-avg-rating">0.0</span> <small style="color:var(--gray); font-weight:400;">/ 5.0</small>
                    </div>
                </div>
                <div class="data-card">
                    <div class="card-header">Komentar Terbaru</div>
                    <div id="review-items-container">
                        <!-- Ulasan per user akan muncul di sini -->
                    </div>
                </div>
            </div>
        </div>

        <!-- BROADCAST PAGE -->
        <div id="page-broadcast" class="page-content">
            <div class="page-header">
                <h1 class="page-title">Siaran Siaga</h1>
                <p class="page-subtitle">Kirim pesan massal ke pengguna</p>
            </div>
            <div class="data-card" style="padding:20px;">
                <div class="form-group">
                    <label class="form-label">Judul</label>
                    <input type="text" id="broadcast-title" class="form-input" placeholder="Info penting...">
                </div>
                <div class="form-group">
                    <label class="form-label">Isi Pesan</label>
                    <textarea id="broadcast-body" rows="4" class="form-input" placeholder="Tulis pengumuman..."></textarea>
                </div>
                <button class="btn-login" style="background:var(--primary);" onclick="kirimBroadcast()">Siarkan Sekarang</button>
            </div>
        </div>

    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('dashboard', this)">
            <i class="ph ph-squares-four"></i>
            <span>Dashboard</span>
        </div>
        <div class="nav-item" onclick="showPage('vendors', this)">
            <i class="ph ph-storefront"></i>
            <span>Mitra</span>
        </div>
        <div class="nav-item" onclick="showPage('products', this)">
            <i class="ph ph-bowl-food"></i>
            <span>Menu</span>
        </div>
        <div class="nav-item" onclick="showPage('reviews', this)">
            <i class="ph ph-star"></i>
            <span>Ulasan</span>
        </div>
        <div class="nav-item" onclick="showPage('broadcast', this)">
            <i class="ph ph-megaphone"></i>
            <span>Siaran</span>
        </div>
    </div>

    <!-- MODAL TAMBAH MITRA -->
    <div id="add-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Daftar Mitra Baru</div>
            <div class="form-group">
                <label class="form-label">ID Unik (Login)</label>
                <input type="text" id="new-vendor-id" class="form-input" placeholder="contoh: warung_berkah">
                <div style="font-size: 11px; color: var(--gray); margin-top: 4px;">*Tanpa spasi, digunakan untuk login</div>
            </div>
            <div class="form-group">
                <label class="form-label">PIN Keamanan</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="new-vendor-pin" class="form-input" placeholder="Min 6 digit">
                    <button type="button" onclick="generateRandomPin()" class="btn-modal" style="background: var(--warning); color: white; width: auto; white-space: nowrap; padding: 0 15px; font-size: 12px;">Acak PIN</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Nama Warung</label>
                <input type="text" id="new-vendor-name" class="form-input" placeholder="Contoh: Warung Berkah">
            </div>
            <div class="modal-actions">
                <button class="btn-modal" style="background:#f1f5f9;" onclick="closeModal('add-modal')">Batal</button>
                <button class="btn-modal" style="background:var(--primary); color:white;" onclick="saveWarung()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- MODAL GANTI PIN -->
    <div id="edit-pin-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Ganti PIN Mitra</div>
            <p style="color:var(--gray); font-size:13px; margin-bottom:15px;">Ubah PIN untuk warung <b id="ep-name">...</b></p>
            <input type="hidden" id="ep-id">
            <div class="form-group">
                <label class="form-label">PIN Baru</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="ep-new-pin" class="form-input" placeholder="Min 6 digit">
                    <button type="button" onclick="generateRandomPinEdit()" class="btn-modal" style="background: var(--warning); color: white; width: auto; white-space: nowrap; padding: 0 15px; font-size: 12px;">Acak</button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-modal" style="background:#f1f5f9;" onclick="closeModal('edit-pin-modal')">Batal</button>
                <button class="btn-modal" style="background:var(--primary); color:white;" onclick="confirmChangePin()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- MODAL KONFIRMASI HAPUS -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <div class="stat-icon" style="background:#fef2f2; color:var(--danger); margin: 0 auto 15px; width:70px; height:70px; font-size:32px; border-radius:50%;">
                <i class="ph-bold ph-trash"></i>
            </div>
            <div class="modal-title">Hapus Data?</div>
            <p style="color:var(--gray); font-size:14px; margin-bottom:20px;">Tindakan ini permanen.</p>
            <div class="modal-actions">
                <button class="btn-modal" style="background:#f1f5f9;" onclick="closeModal('delete-modal')">Batal</button>
                <button class="btn-modal" style="background:var(--danger); color:white;" id="confirm-delete-btn">Hapus</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, deleteDoc, doc, setDoc, updateDoc, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDq0UCWj43rCP3rqvAGbdyr2FFV7kyhZTA",
            authDomain: "projekgo-app.firebaseapp.com",
            projectId: "projekgo-app",
            storageBucket: "projekgo-app.firebasestorage.app",
            messagingSenderId: "910691523179",
            appId: "1:910691523179:web:2c78d27de6a02cec952f2e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminAllProducts = []; 
        let adminAllVendors = [];
        let adminAllReviews = [];
        let currentVendorView = null; 
        let deleteTarget = null; 

        // --- AUTH ---
        window.checkLogin = () => {
            const pass = document.getElementById('admin-pass').value;
            if(pass === 'admin123') { 
                document.getElementById('login-overlay').style.display = 'none';
                initData();
            } else { alert('Password salah!'); }
        }
        window.logout = () => { location.reload(); }

        // --- NAVIGASI ---
        window.showPage = (pageId, el) => {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(m => m.classList.remove('active'));
            el.classList.add('active');
            window.scrollTo(0,0);
            
            if (pageId === 'products') showMenuVendorList();
            if (pageId === 'reviews') showReviewList();
        }

        // --- REVIEW PAGE LOGIC ---
        window.showReviewList = () => {
            document.getElementById('review-vendor-list').style.display = 'block';
            document.getElementById('review-detail-view').style.display = 'none';
            renderReviewVendors();
        }

        window.openReviewDetail = (vendorId, vendorName) => {
            document.getElementById('review-vendor-list').style.display = 'none';
            document.getElementById('review-detail-view').style.display = 'block';
            document.getElementById('rev-detail-vendor-name').innerText = vendorName;
            
            const vendorReviews = adminAllReviews.filter(r => r.vendor_id === vendorId);
            const container = document.getElementById('review-items-container');
            const avgDisplay = document.getElementById('rev-detail-avg-rating');
            
            container.innerHTML = '';
            
            if (vendorReviews.length === 0) {
                container.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">Belum ada ulasan untuk mitra ini.</div>';
                avgDisplay.innerText = "0.0";
            } else {
                let totalRating = 0;
                vendorReviews.forEach(r => {
                    totalRating += parseFloat(r.rating || 0);
                    const stars = '★'.repeat(r.rating) + '☆'.repeat(5 - r.rating);
                    const formattedDate = r.date ? new Date(r.date).toLocaleDateString('id-ID') : '-';
                    
                    container.innerHTML += `
                        <div class="review-item">
                            <div class="review-user">
                                <span>${r.user_name || 'Anonim'}</span>
                                <span class="review-date">${formattedDate}</span>
                            </div>
                            <div class="review-stars">${stars}</div>
                            <div class="review-comment">${r.comment || 'Tidak ada komentar.'}</div>
                        </div>
                    `;
                });
                avgDisplay.innerText = (totalRating / vendorReviews.length).toFixed(1);
            }
        }

        function renderReviewVendors() {
            const body = document.getElementById('review-vendor-body');
            body.innerHTML = '';
            
            adminAllVendors.forEach(v => {
                const vendorReviews = adminAllReviews.filter(r => r.vendor_id === v.id);
                let avg = 0;
                if(vendorReviews.length > 0) {
                    avg = vendorReviews.reduce((acc, curr) => acc + parseFloat(curr.rating), 0) / vendorReviews.length;
                }
                
                body.innerHTML += `
                    <tr>
                        <td style="font-weight:700;">${v.nama_warung || '-'}</td>
                        <td>
                            <div class="rating-badge">
                                <i class="ph-fill ph-star"></i> ${avg.toFixed(1)}
                            </div>
                        </td>
                        <td>
                            <button class="action-btn btn-view" onclick="openReviewDetail('${v.id}', '${v.nama_warung}')">
                                <i class="ph-bold ph-caret-right"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- PRODUCT PAGE LOGIC ---
        window.showMenuVendorList = () => {
            currentVendorView = null;
            document.getElementById('menu-vendor-list-view').style.display = 'block';
            document.getElementById('menu-detail-view').style.display = 'none';
        }
        window.openVendorMenu = (vendorName) => {
            currentVendorView = vendorName;
            document.getElementById('menu-vendor-list-view').style.display = 'none';
            document.getElementById('menu-detail-view').style.display = 'block';
            document.getElementById('detail-vendor-name').innerText = vendorName;
            renderDetailProducts(vendorName);
        }
        
        function renderDetailProducts(vendorName) {
            const detailBody = document.getElementById('detail-product-body');
            detailBody.innerHTML = '';
            const vendorProducts = adminAllProducts.filter(p => p.vendor_name === vendorName);
            if (vendorProducts.length === 0) {
                detailBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#999;">Kosong.</td></tr>';
            } else {
                vendorProducts.forEach(p => {
                    const isAvail = p.is_available !== false;
                    const isExclusive = p.is_exclusive === true;
                    
                    detailBody.innerHTML += `
                        <tr>
                            <td style="font-weight:600;">${p.nama_menu}</td>
                            <td>${parseInt(p.harga).toLocaleString()}</td>
                            <td><button class="btn-status ${isAvail ? 'open' : 'closed'}" onclick="toggleProductStock('${p.id}', ${isAvail})">${isAvail ? 'Ada' : 'Habis'}</button></td>
                            <td>
                                <div style="display:flex; gap:5px;">
                                    <button class="action-btn btn-exclusive ${isExclusive ? 'active' : ''}" title="${isExclusive ? 'Hapus dari Exclusive' : 'Jadikan Exclusive'}" onclick="toggleExclusive('${p.id}', ${isExclusive})">
                                        <i class="ph-fill ph-diamond"></i>
                                    </button>
                                    <button class="action-btn btn-delete" onclick="askDelete('products', '${p.id}')">
                                        <i class="ph-bold ph-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
        }
        
        function renderVendorMenuOverview() {
            const container = document.getElementById('menu-vendor-body');
            container.innerHTML = '';
            const grouped = {};
            adminAllVendors.forEach(v => grouped[v.nama_warung] = 0);
            adminAllProducts.forEach(p => { if(grouped[p.vendor_name] !== undefined) grouped[p.vendor_name]++; });
            for (const [vName, count] of Object.entries(grouped)) {
                container.innerHTML += `<tr><td style="font-weight:700;">${vName}</td><td>${count} Menu</td><td><button class="action-btn btn-view" onclick="openVendorMenu('${vName}')"><i class="ph-bold ph-caret-right"></i></button></td></tr>`;
            }
        }

        // --- CRUD OPS ---
        window.openAddModal = () => { 
            // Reset form saat dibuka
            document.getElementById('new-vendor-id').value = "";
            document.getElementById('new-vendor-pin').value = "";
            document.getElementById('new-vendor-name').value = "";
            document.getElementById('add-modal').style.display = 'flex'; 
        }
        window.closeModal = (id) => { document.getElementById(id).style.display = 'none'; }
        
        // Generator PIN Acak
        window.generateRandomPin = () => {
            const pin = Math.floor(100000 + Math.random() * 900000); // 6 digit
            document.getElementById('new-vendor-pin').value = pin;
        }

        window.saveWarung = async () => {
            // Sanitasi ID: huruf kecil, ganti spasi dengan underscore
            let rawId = document.getElementById('new-vendor-id').value.trim();
            const id = rawId.toLowerCase().replace(/\s+/g, '_');
            
            const pin = document.getElementById('new-vendor-pin').value.trim();
            const nama = document.getElementById('new-vendor-name').value.trim();
            
            if(!id || !pin || !nama) return alert("Mohon lengkapi semua form!");
            if(pin.length < 4) return alert("PIN minimal 4 karakter untuk keamanan!");

            // Cek apakah ID sudah ada di database
            try {
                const docRef = doc(db, "vendors", id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    alert(`ID "${id}" sudah digunakan oleh mitra lain. Harap gunakan ID unik.`);
                    return;
                }

                // Simpan jika unik
                await setDoc(docRef, { 
                    id, 
                    nama_warung: nama, 
                    pin: pin,
                    status: 'BUKA', 
                    role: 'vendor', 
                    created_at: new Date().toISOString() 
                });
                
                closeModal('add-modal');
                alert(`Mitra Berhasil Didaftarkan!\n\nID Login: ${id}\nPIN Akses: ${pin}\n\nSilakan berikan kredensial ini kepada mitra.`);
            } catch(e) { 
                alert("Gagal menyimpan data: " + e.message); 
                console.error(e);
            }
        }

        // GANTI PIN FUNCTIONS
        window.openChangePinModal = (id, name) => {
            document.getElementById('ep-id').value = id;
            document.getElementById('ep-name').innerText = name;
            document.getElementById('ep-new-pin').value = "";
            document.getElementById('edit-pin-modal').style.display = 'flex';
        }

        window.generateRandomPinEdit = () => {
            const pin = Math.floor(100000 + Math.random() * 900000); // 6 digit
            document.getElementById('ep-new-pin').value = pin;
        }

        window.confirmChangePin = async () => {
            const id = document.getElementById('ep-id').value;
            const newPin = document.getElementById('ep-new-pin').value.trim();
            if(newPin.length < 4) return alert("PIN minimal 4 karakter");
            
            try {
                await updateDoc(doc(db, "vendors", id), { pin: newPin });
                closeModal('edit-pin-modal');
                alert("PIN berhasil diubah!");
            } catch(e) {
                alert("Gagal update PIN: " + e.message);
            }
        }

        window.toggleStatus = async (id, currentStatus) => {
            const newStatus = (currentStatus === 'BUKA') ? 'TUTUP' : 'BUKA';
            await updateDoc(doc(db, "vendors", id), { status: newStatus });
        }
        window.toggleProductStock = async (id, currentStatus) => {
            await updateDoc(doc(db, "products", id), { is_available: !currentStatus });
        }
        window.toggleExclusive = async (id, currentVal) => {
            try {
                await updateDoc(doc(db, "products", id), { is_exclusive: !currentVal });
            } catch(e) { console.error("Error toggling exclusive:", e); }
        }
        window.askDelete = (coll, id) => {
            deleteTarget = { coll, id };
            document.getElementById('delete-modal').style.display = 'flex';
        }
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if(!deleteTarget) return;
            await deleteDoc(doc(db, deleteTarget.coll, deleteTarget.id));
            closeModal('delete-modal');
        });

        // --- DATA SYNC ---
        function initData() {
            onSnapshot(collection(db, "vendors"), (snap) => {
                const vendorBody = document.getElementById('vendor-list-body');
                const recentBody = document.getElementById('recent-vendors-table');
                let hMain = '', hRecent = '';
                adminAllVendors = [];
                document.getElementById('count-vendors').innerText = snap.size;
                snap.forEach(d => adminAllVendors.push({id: d.id, ...d.data()}));
                adminAllVendors.forEach(v => {
                    const isOpen = v.status === 'BUKA';
                    hMain += `
                        <tr>
                            <td>
                                <div style="font-weight:700;">${v.nama_warung}</div>
                                <div class="unique-badge">ID: ${v.id}</div>
                                <div style="font-size:11px; color:#666;">PIN: <b>${v.pin || '-'}</b></div>
                            </td>
                            <td><button class="btn-status ${isOpen ? 'open' : 'closed'}" onclick="toggleStatus('${v.id}', '${v.status}')">${v.status}</button></td>
                            <td>
                                <div style="display:flex; gap:5px;">
                                    <button class="action-btn btn-edit-pin" title="Ganti PIN" onclick="openChangePinModal('${v.id}', '${v.nama_warung}')">
                                        <i class="ph-bold ph-key"></i>
                                    </button>
                                    <button class="action-btn btn-delete" onclick="askDelete('vendors', '${v.id}')">
                                        <i class="ph-bold ph-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    hRecent += `<tr><td>${v.nama_warung}</td><td style="text-align:right;"><span class="btn-status ${isOpen ? 'open' : 'closed'}">${v.status}</span></td></tr>`;
                });
                vendorBody.innerHTML = hMain;
                recentBody.innerHTML = hRecent;
                renderVendorMenuOverview();
                renderReviewVendors();
            });

            onSnapshot(collection(db, "products"), (snap) => {
                adminAllProducts = [];
                document.getElementById('count-products').innerText = snap.size;
                snap.forEach(d => adminAllProducts.push({id: d.id, ...d.data()}));
                renderVendorMenuOverview();
                if(currentVendorView) renderDetailProducts(currentVendorView);
            });

            onSnapshot(collection(db, "reviews"), (snap) => {
                adminAllReviews = [];
                let totalRating = 0;
                snap.forEach(d => {
                    const data = d.data();
                    adminAllReviews.push({id: d.id, ...data});
                    totalRating += parseFloat(data.rating || 0);
                });
                if(snap.size > 0) {
                    document.getElementById('global-rating').innerText = (totalRating / snap.size).toFixed(1);
                }
                renderReviewVendors();
            });
        }
    </script>
</body>
</html>
